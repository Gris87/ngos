NGOS                                                                                                                                                                                                     // Colorize: green
====                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
0.5. How to debug                                                                                                                                                                                        // Colorize: green
-----------------                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
GDB, the GNU Project debugger, allows you to see what is going on inside another program while it executes -- or what another program was doing at the moment it crashed.                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
GDB can do four main kinds of things (plus other things in support of these) to help you catch bugs in the act:                                                                                          // Colorize: green
* Start your program, specifying anything that might affect its behavior.                                                                                                                                // Colorize: green
* Make your program stop on specified conditions.                                                                                                                                                        // Colorize: green
* Examine what has happened, when your program has stopped.                                                                                                                                              // Colorize: green
* Change things in your program, so you can experiment with correcting the effects of one bug and go on to learn about another.                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
You should start QEMU virtual machine before start debugging with one of the following commands:                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
make run-test-debug                                                                                                                                                                                      // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
or                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
cd tools/vm/ && ./start_vm.sh qemu vnc ngos                                                                                                                                                              // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
It is also possible to start another kernels with commands:                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
cd tools/vm/ && ./start_vm.sh qemu vnc ngos_installer                                                                                                                                                    // Colorize: green
cd tools/vm/ && ./start_vm.sh qemu vnc linux                                                                                                                                                             // Colorize: green
cd tools/vm/ && ./start_vm.sh qemu vnc win7                                                                                                                                                              // Colorize: green
cd tools/vm/ && ./start_vm.sh qemu vnc win10                                                                                                                                                             // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
If you are running NGOS kernel built in Debug mode you will have 5 seconds delay in order to establish GDB remote connection with the commands:                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
gdb                                                                                                                                                                                                      // Colorize: green
(gdb) set architecture i386:x86-64:intel                                                                                                                                                                 // Colorize: green
(gdb) target remote :1234                                                                                                                                                                                // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
After that you can load symbols with the commands:                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
(gdb) add-symbol-file-all src/os/configure/build/configure.elf 0x3E40F220                                                                                                                                // Colorize: green
(gdb) add-symbol-file-all src/os/configure/build/configure.elf 0x02000000                                                                                                                                // Colorize: green
(gdb) add-symbol-file-all src/os/kernel/build/kernel.elf -0xFFFFFFFF80000000+0x10000000                                                                                                                  // Colorize: green
(gdb) add-symbol-file-all src/os/kernel/build/kernel.elf -0xFFFFFFFF80000000+0xFFFFFFFF80000000                                                                                                          // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Where:                                                                                                                                                                                                   // Colorize: green
* 0x3E40F220 - Address of first kernel instruction when UEFI loads image in memory                                                                                                                       // Colorize: green
* 0x02000000 - Address of relocated kernel in low address space                                                                                                                                          // Colorize: green
* 0x10000000 - Random address of kernel in Physical address space                                                                                                                                        // Colorize: green
* 0xFFFFFFFF80000000 - Random address of kernel in Virtual address space                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
`add-symbol-file-all` is user defined GDB command. You should install it first with:                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
cd tools/gdb                                                                                                                                                                                             // Colorize: green
./install.sh                                                                                                                                                                                             // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
You may do the debugging as you wish from this moment.                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Additional GDB commands                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here is the list of useful GDB commands:                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
* `symbol-file` - call this command to remove all symbols that you may load again with `add-symbol-file-all`                                                                                             // Colorize: green
* `dump binary memory result.bin 0x0000000000000000 0x000000003FFFFFFF` - this command dumps memory range to the external file on your hard disk                                                         // Colorize: green
* `x/10xg 0x01000000` - dumps ten 64 bit integers in HEX format. Please check `help x` for more output options                                                                                           // Colorize: green
* `x/60i 0x01000000` - prints 60 instructions starting from specified address                                                                                                                            // Colorize: green
* `x/60i $pc` - prints 60 instructions starting from current instruction                                                                                                                                 // Colorize: green
* `br *0x01000000` - puts breakpoint at specified address                                                                                                                                                // Colorize: green
* `c` - continue execution until breakpoint reached or Ctrl+C pressed                                                                                                                                    // Colorize: green
* `ni` - execute current instruction. Jump over function call                                                                                                                                            // Colorize: green
* `si` - execute current instruction. Step into function call                                                                                                                                            // Colorize: green
* `i r` - prints register values                                                                                                                                                                         // Colorize: green
* `i th` - prints information about currently running threads                                                                                                                                            // Colorize: green
* `t 2` - switch to thread specified by thread ID                                                                                                                                                        // Colorize: green
