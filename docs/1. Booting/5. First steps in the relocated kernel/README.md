NGOS                                                                                                                                                                                                     // Colorize: green
====                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
1.5. First steps in the relocated kernel                                                                                                                                                                 // Colorize: green
----------------------------------------                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We have known from the previous [chapter](../4.%20UEFI%20initialization/README.md) how NGOS perform initialization during UEFI booting like:                                                             // Colorize: green
* Serial port initialization for debugging                                                                                                                                                               // Colorize: green
* Early CPU initialization                                                                                                                                                                               // Colorize: green
* Assets loading                                                                                                                                                                                         // Colorize: green
* Base functionality testing                                                                                                                                                                             // Colorize: green
* Space allocation for boot parameters                                                                                                                                                                   // Colorize: green
* Obtaining graphics parameters                                                                                                                                                                          // Colorize: green
* Early console initialization                                                                                                                                                                           // Colorize: green
* Fetching ROM images for PCI devices                                                                                                                                                                    // Colorize: green
* Kernel image relocation                                                                                                                                                                                // Colorize: green
* Global descriptor table initialization                                                                                                                                                                 // Colorize: green
* Storing memory map information                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
In the previous chapter we have finished at the relocated_address label in relocated address space.<br/>                                                                                                 // Colorize: green
Let's continue from this point.                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
relocated_address:                                                              # Label for relocated address                                                                                            // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
# Clear EFLAGS                                                                  #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    pushq   $0                                                                  # Push 0 to the stack                                                                                                    // Colorize: green
    popfq                                                                       # Restore EFLAGS from the stack                                                                                          // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here we are resetting EFLAGS register.                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Setup Global Descriptor Table                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The Global Descriptor Table (GDT) is a data structure used by Intel x86-family processors starting with the 80286 in order to define the characteristics of the various memory areas used during program execution, including the base address, the size, and access privileges like executability and writability. These memory areas are called segments in Intel terminology.<br/> // Colorize: green
The GDT is still present in 64 bit mode; a GDT must be defined, but is generally never changed or used for segmentation.<br/>                                                                            // Colorize: green
We need to setup GDT in order to be able to perform jump to 32 bit mode.                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
# Setup GDT                                                                     #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    leaq    gdt(%rip), %rax                                                     # Put address of gdt variable to RAX                                                                                     // Colorize: green
    movq    %rax, early_gdt_register + 0x02(%rip)                               # Store address of gdt variable in early_gdt_register                                                                    // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    lgdt    early_gdt_register(%rip)                                            # Setup GDT                                                                                                              // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The GDT is loaded using the `lgdt` instruction. It expects the location points to following structure:                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/5.%20First%20steps%20in%20the%20relocated%20kernel/GDT%20register.png?raw=true" alt="GDT register"/>                          // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The offset is the linear address of the table itself, which means that paging applies. The size is the size of the table subtracted by 1. This is because the maximum value of size is 65535, while the GDT can be up to 65536 bytes (a maximum of 8192 entries). Further no GDT can have a size of 0. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
ENTRY(early_gdt_register)                                                       # Declaration for early_gdt_register variable                                                                            // Colorize: green
    .word   GDT_ENTRIES * 8 - 1                                                 # Put size of gdt variable. The size subtracted by 1 because the maximum value of size is 65535, while the GDT can be up to 65536 bytes (a maximum of 8192 entries). Further no GDT can have a size of 0. // Colorize: green
    .quad   gdt                                                                 # Put address of gdt variable                                                                                            // Colorize: green
END_ENTRY(early_gdt_register)                                                   # End of declaration for early_gdt_register variable                                                                     // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here is declaration of early_gdt_register variable that we provide to `lgdt` instruction.<br/>                                                                                                           // Colorize: green
The table contains of GDT_ENTRIES amount of entries.<br/>                                                                                                                                                // Colorize: green
GDT_ENTRIES defined in [src/os/include/gdt/segments.h](../../../src/os/include/gdt/segments.h) as following:                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#define GDT_ENTRIES                 16                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We also provide GDT location as address of gdt variable.                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The table contains 8-byte entries. Each entry has the following structure:                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/5.%20First%20steps%20in%20the%20relocated%20kernel/GDT%20entry.png?raw=true" alt="GDT entry"/>                                // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
What "Limit 0:15" means is that the field contains bits 0-15 of the limit value. The base is a 32 bit value containing the linear address where the segment begins. The limit, a 20 bit value, tells the maximum addressable unit (either in 1 byte units, or in pages). Hence, if you choose page granularity (4 KB) and set the limit value to 0x000FFFFF the segment will span the full 4 GiB address space. Here is the structure of the access byte and flags: // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/5.%20First%20steps%20in%20the%20relocated%20kernel/GDT%20flags.png?raw=true" alt="GDT flags"/>                                // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The bit fields are:                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
* Pr: Present bit. This must be 1 for all valid selectors.                                                                                                                                               // Colorize: green
* Privl: Privilege, 2 bits. Contains the ring level, 0 = highest (kernel), 3 = lowest (user applications).                                                                                               // Colorize: green
* Ex: Executable bit. If 1 code in this segment can be executed, ie. a code selector. If 0 it is a data selector.                                                                                        // Colorize: green
* DC: Direction bit/Conforming bit.                                                                                                                                                                      // Colorize: green
    * Direction bit for data selectors: Tells the direction. 0 the segment grows up. 1 the segment grows down, ie. the offset has to be greater than the limit.                                          // Colorize: green
    * Conforming bit for code selectors:                                                                                                                                                                 // Colorize: green
        * If 1 code in this segment can be executed from an equal or lower privilege level. For example, code in ring 3 can far-jump to conforming code in a ring 2 segment. The privl-bits represent the highest privilege level that is allowed to execute the segment. For example, code in ring 0 cannot far-jump to a conforming code segment with privl==0x02, while code in ring 2 and 3 can. Note that the privilege level remains the same, ie. a far-jump form ring 3 to a privl==2-segment remains in ring 3 after the jump. // Colorize: green
        * If 0 code in this segment can only be executed from the ring set in privl.                                                                                                                     // Colorize: green
* RW: Readable bit/Writable bit.                                                                                                                                                                         // Colorize: green
    * Readable bit for code selectors: Whether read access for this segment is allowed. Write access is never allowed for code segments.                                                                 // Colorize: green
    * Writable bit for data selectors: Whether write access for this segment is allowed. Read access is always allowed for data segments.                                                                // Colorize: green
* Ac: Accessed bit. Just set to 0. The CPU sets this to 1 when the segment is accessed.                                                                                                                  // Colorize: green
* Gr: Granularity bit. If 0 the limit is in 1 B blocks (byte granularity), if 1 the limit is in 4 KB blocks (page granularity).                                                                          // Colorize: green
* Sz: Size bit. If 0 the selector defines 16 bit protected mode. If 1 it defines 32 bit protected mode. You can have both 16 bit and 32 bit selectors at once.                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
ENTRY(gdt)                                                                      # Declaration for gdt variable                                                                                           // Colorize: green
    .quad   0x0000000000000000                                                  # First GDT entry ignored                                                                                                // Colorize: green
    .quad   0x00CF9A000000FFFF                                                  # GDT_ENTRY_KERNEL32_CS                                                                                                  // Colorize: green
    .quad   0x00AF9A000000FFFF                                                  # GDT_ENTRY_KERNEL_CS                                                                                                    // Colorize: green
    .quad   0x00CF92000000FFFF                                                  # GDT_ENTRY_KERNEL_DS                                                                                                    // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_DEFAULT_USER32_CS                                                                                            // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_DEFAULT_USER_DS                                                                                              // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_DEFAULT_USER_CS                                                                                              // Colorize: green
    .quad   0x0000000000000000                                                  # Ignored                                                                                                                // Colorize: green
    .quad   0x0080890000000000                                                  # GDT_ENTRY_TSS                                                                                                          // Colorize: green
    .quad   0x0000000000000000                                                  # Ignored                                                                                                                // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_LDT                                                                                                          // Colorize: green
    .quad   0x0000000000000000                                                  # Ignored                                                                                                                // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_TLS_MIN                                                                                                      // Colorize: green
    .quad   0x0000000000000000                                                  # Ignored                                                                                                                // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_TLS_MAX                                                                                                      // Colorize: green
    .quad   0x0000000000000000                                                  # GDT_ENTRY_PER_CPU                                                                                                      // Colorize: green
END_ENTRY(gdt)                                                                  # End of declaration for gdt variable                                                                                    // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
gdt variable consist of GDT_ENTRIES (16) predefined entries above.                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Segments initialization                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We are resetting segments after updating Global Descriptor Table:                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
# Clear segment registers                                                       #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    xorq    %rax, %rax                                                          # Indirectly assign (via RAX)                                                                                            // Colorize: green
    movq    %rax, %ds                                                           # DS to 0                                                                                                                // Colorize: green
    movq    %rax, %es                                                           # ES to 0                                                                                                                // Colorize: green
    movq    %rax, %ss                                                           # SS to 0                                                                                                                // Colorize: green
    movq    %rax, %fs                                                           # FS to 0                                                                                                                // Colorize: green
    movq    %rax, %gs                                                           # GS to 0                                                                                                                // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Jumping to C++ code                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
# Extract the Kernel                                                            #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    leaq    _start(%rip), %rdx                                                  # Put address of relocated kernel to RDX                                                                                 // Colorize: green
    movq    ASM_OFFSET_BOOT_PARAM_KERNEL_SIZE(%rsi), %rax                       # Put size of the kernel to RAX                                                                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
# Align RAX by PAGE_SIZE in order to make address of page table to be aligned   #                                                                                                                        // Colorize: green
    movq    $(PAGE_SIZE), %rcx                                                  # Put PAGE_SIZE to RCX                                                                                                   // Colorize: green
    decq    %rcx                                                                # Since RCX is power of 2, then it will give us a mask                                                                   // Colorize: green
    addq    %rcx, %rax                                                          # Add RCX to RAX. If RAX unaligned it will make it aligned on the next steps                                             // Colorize: green
    notq    %rcx                                                                # Inverting RCX to get the mask                                                                                          // Colorize: green
    andq    %rcx, %rax                                                          # Align RAX with inverted RCX                                                                                            // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    addq    %rax, %rdx                                                          # Calculate end position of kernel image in RDX                                                                          // Colorize: green
    movq    %rdx, %rcx                                                          # Store address of page table to RCX                                                                                     // Colorize: green
    addq    $(BOOT_PAGE_TABLE_SIZE + BOOT_STACK_SIZE), %rdx                     # Calculate start position of stack in RDX                                                                               // Colorize: green
    movq    %rdx, %rsp                                                          # Initialize the stack                                                                                                   // Colorize: green
    leaq    _end(%rip), %rdi                                                    # Put address of attached kernel image to RDI                                                                            // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
#if NGOS_BUILD_KERNEL_COMPRESSION == OPTION_KERNEL_COMPRESSION_NONE                                                                                                                                      // Colorize: green
    leaq    ASM_OFFSET_KERNEL_DESCRIPTOR_CONTENT(%rdi), %rdx                    # Put address of attached decompressed kernel image to RDX                                                               // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
It is better to explain this code block with a picture below:                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/5.%20First%20steps%20in%20the%20relocated%20kernel/Image%20structure.png?raw=true" alt="Image structure"/>                    // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As you know from the previous [chapter](../4.%20UEFI%20initialization/README.md) we are allocating space for kernel image, page table, stack and for decompressed kernel if the kernel was compressed.<br/> // Colorize: green
Page table should be properly aligned to page size. Therefore we are adding few bytes to imageSize variable to make it aligned.<br/>                                                                     // Colorize: green
It is expected that the location of relocated kernel will be also aligned to page size.                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We are putting address of relocated kernel to RDX with the first instruction.                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    leaq    _start(%rip), %rdx                                                  # Put address of relocated kernel to RDX                                                                                 // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Next block of instructions calculates value of imageSize aligned to page size and appends to RDX.                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    movq    ASM_OFFSET_BOOT_PARAM_KERNEL_SIZE(%rsi), %rax                       # Put size of the kernel to RAX                                                                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
# Align RAX by PAGE_SIZE in order to make address of page table to be aligned   #                                                                                                                        // Colorize: green
    movq    $(PAGE_SIZE), %rcx                                                  # Put PAGE_SIZE to RCX                                                                                                   // Colorize: green
    decq    %rcx                                                                # Since RCX is power of 2, then it will give us a mask                                                                   // Colorize: green
    addq    %rcx, %rax                                                          # Add RCX to RAX. If RAX unaligned it will make it aligned on the next steps                                             // Colorize: green
    notq    %rcx                                                                # Inverting RCX to get the mask                                                                                          // Colorize: green
    andq    %rcx, %rax                                                          # Align RAX with inverted RCX                                                                                            // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    addq    %rax, %rdx                                                          # Calculate end position of kernel image in RDX                                                                          // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
RDX register is pointing to address of page table now. We will store its value to RCX:                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    movq    %rdx, %rcx                                                          # Store address of page table to RCX                                                                                     // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
After this we will calculate and setup address of the stack:                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    addq    $(BOOT_PAGE_TABLE_SIZE + BOOT_STACK_SIZE), %rdx                     # Calculate start position of stack in RDX                                                                               // Colorize: green
    movq    %rdx, %rsp                                                          # Initialize the stack                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
And the last instruction needed to get the address of [KernelDescriptor](../../../src/os/configure/src/bits64/other/kerneldescriptor.h) structure located at the beginning of .kernel section:           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    leaq    _end(%rip), %rdi                                                    # Put address of attached kernel image to RDI                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
In case when included kernel image doesn't compressed RDX should point to location of that image right after [KernelDescriptor](../../../src/os/configure/src/bits64/other/kerneldescriptor.h) structure. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#if NGOS_BUILD_KERNEL_COMPRESSION == OPTION_KERNEL_COMPRESSION_NONE                                                                                                                                      // Colorize: green
    leaq    ASM_OFFSET_KERNEL_DESCRIPTOR_CONTENT(%rdi), %rdx                    # Put address of attached decompressed kernel image to RDX                                                               // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Otherwise RDX should point to address where we will put the decompressed image.                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Since we are done with the registers we can go back to C++ code for extracting kernel image.                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    pushq   %rsi                                                                # Push address of boot parameters (RSI) to the stack                                                                     // Colorize: green
    call    extractKernel                                                       # Call extractKernel function                                                                                            // Colorize: green
    popq    %rsi                                                                # Restore address of boot parameters back to RSI from the stack                                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    cmpq    $0, %rax                                                            # IF result == 0                                                                                                         // Colorize: green
    je      fail                                                                #   THEN jump to fail                                                                                                    // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    jmp     *%rax                                                               # Jump to decompressed kernel                                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
RSI register is pointing to boot parameters. So we need to store this address since it may be changed during extractKernel() function call.                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
extractKernel() function located in [src/os/configure/src/bits64/b_early/main/kernelextraction.cpp](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/b_early/main/kernelextraction.cpp#L16) file. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here is the extractKernel declaration:                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
CPP_EXTERN_C                                                                                                                                                                                             // Colorize: green
u64 extractKernel(KernelDescriptor *kernelDescriptor, BootParams *params, u8 *decompressedAddress, u8 *pageTable)                                                                                        // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As a result we should get the address of extracted kernel binary image.<br/>                                                                                                                             // Colorize: green
In case when result is null that means that we have some problem and we will jump to fail label.                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
fail:                                                                           # Label for failure                                                                                                      // Colorize: green
    hlt                                                                         # Wait for interrupt                                                                                                     // Colorize: green
    jmp    fail                                                                 # Loop in fail forever                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
In case of issue we came to fail label and hold PC into a forever loop.                                                                                                                                  // Colorize: green
