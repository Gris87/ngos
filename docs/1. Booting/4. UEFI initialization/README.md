NGOS                                                                                                                                                                                                     // Colorize: green
====                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
1.4. UEFI initialization                                                                                                                                                                                 // Colorize: green
------------------------                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As we already know from the previous [chapter](../2.%20First%20steps%20in%20the%20kernel/README.md) we jump to the C++ code from start up with the instructions below:                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ============================================================================= # =============================================================================                                          // Colorize: green
# Entry point                                                                   #                                                                                                                        // Colorize: green
#                                                                               #                                                                                                                        // Colorize: green
# RDX - address of systemTable                                                  #                                                                                                                        // Colorize: green
# RCX - address of imageHandle                                                  #                                                                                                                        // Colorize: green
# ============================================================================= # =============================================================================                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    movq    %rcx, %rdi                                                          # Put address of imageHandle to RDI                                                                                      // Colorize: green
    movq    %rdx, %rsi                                                          # Put address of systemTable to RSI                                                                                      // Colorize: green
    leaq    _start(%rip), %rdx                                                  # Put address of entry point to RDX                                                                                      // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    call    uefiMain                                                            # Call uefiMain function                                                                                                 // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    cmpq    $0, %rax                                                            # IF result == 0                                                                                                         // Colorize: green
    je      fail                                                                #   THEN jump to fail                                                                                                    // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Let's go through [uefiMain()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/main.cpp#L106) function and explain what we are doing.                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    // We can't output at the moment                                                                                                                                                                     // Colorize: green
    // UEFI_LT((" | imageHandle = 0x%p, systemTable = 0x%p, kernelLocation = 0x%p", imageHandle, systemTable, kernelLocation)); // Commented to avoid error because UEFI is uninitialized                // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
At the beginning of each function it is required to have such LT logs that provides information about currently executed function and its parameters.<br/>                                               // Colorize: green
You have to set [NGOS_BUILD_LOG_LEVEL](../../0.%20Intro/3.%20Configuration/README.md#-----------ngos_build_log_level-----------) configuration parameter to TRACE logging level in order to see such logs.<br/> // Colorize: green
But, we can't do any output at the moment unfortunately. We will call it later.                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_ASSERT_EXECUTION(Serial::initConsole(), 0);                                                                                                                                                     // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As we already mention in [Logging principles chapter](../3.%20Logging%20principles/README.md) we have to call Serial::initConsole() method at the very beginning of the kernel in order to enable logging to default serial port.<br/> // Colorize: green
We are checking that Serial::initConsole() was successful with UEFI_ASSERT_EXECUTION macro, otherwise we just leave uefiMain() function.                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    // Check that we are booting via UEFI                                                                                                                                                                // Colorize: green
    if (systemTable->header.signature != UEFI_SYSTEM_TABLE_SIGNATURE)                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Unexpected UEFI System Table signature"));                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here we just double check that we are booting via UEFI and nothing else.                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_ASSERT_EXECUTION(UEFI::init(imageHandle, systemTable), 0);                                                                                                                                      // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We are finally initialize [UEFI](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/uefi/uefi.cpp#L19) module with the address of Image Handle and address of System Table.<br/> // Colorize: green
After that we can do the printing on the screen.                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_LT((" | imageHandle = 0x%p, systemTable = 0x%p, kernelLocation = 0x%p", imageHandle, systemTable, kernelLocation)); // We can output now                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_ASSERT(imageHandle,    "imageHandle is null",    0);                                                                                                                                            // Colorize: green
    UEFI_ASSERT(systemTable,    "systemTable is null",    0);                                                                                                                                            // Colorize: green
    UEFI_ASSERT(kernelLocation, "kernelLocation is null", 0);                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("NGOS starting up"));                                                                                                                                                                       // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Since we can output we are calling the same UEFI_LT macro for trace logging.<br/>                                                                                                                        // Colorize: green
We are also saying that NGOS is started.<br/>                                                                                                                                                            // Colorize: green
Here you can see some assertions. It is strongly recommended to do attribute checking in each function.<br/>                                                                                             // Colorize: green
We are calling it here because in case of issue we need to print the error message on the screen. That's why we can't do it earlier.                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Waiting for GDB debugging                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#if NGOS_BUILD_RELEASE == OPTION_NO                                                                                                                                                                      // Colorize: green
    UEFI_LD(("Application started at address 0x%p", kernelLocation));                                                                                                                                    // Colorize: green
    UEFI_LD(("gdb debug is ready to go"));                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_ASSERT_EXECUTION(waitForGdbDebug(), 0);                                                                                                                                                         // Colorize: green
#else                                                                                                                                                                                                    // Colorize: green
    UEFI_LV(("Application started at address 0x%p", kernelLocation));                                                                                                                                    // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
This code block is mostly interesting for users that want to debug kernel with gdb.<br/>                                                                                                                 // Colorize: green
In case if we build kernel in Debug mode it will provide 5 second delay for establishing GDB connection.<br/>                                                                                            // Colorize: green
Please refer to [How to debug chapter](../../0.%20Intro/5.%20How%20to%20debug/README.md) for details.                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Early CPU initialization                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_ASSERT_EXECUTION(CPU::init(), 0);                                                                                                                                                               // Colorize: green
    UEFI_LI(("CPU information initialized"));                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#if NGOS_BUILD_UEFI_LOG_LEVEL == OPTION_LOG_LEVEL_INHERIT && NGOS_BUILD_LOG_LEVEL >= OPTION_LOG_LEVEL_VERBOSE || NGOS_BUILD_UEFI_LOG_LEVEL >= OPTION_LOG_LEVEL_VERBOSE                                   // Colorize: green
    UEFI_ASSERT_EXECUTION(printCpuFlags(), 0);                                                                                                                                                           // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    const char8 *wantedCpuFlag = 0;                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (CPU::check(&wantedCpuFlag) != NgosStatus::OK)                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        char8 buffer[1024];                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_ASSERT_EXECUTION(UEFI::clearScreen(), UefiStatus, UefiStatus::SUCCESS, 0);                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_ASSERT_EXECUTION(CPU::toString(buffer, 1024), 0);                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_LF(("%s\n", buffer));                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_ASSERT_EXECUTION(CPU::flagsToString(buffer, 1024), 0);                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_LF(("CPU flags:             %s\n", buffer));                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (wantedCpuFlag != nullptr && wantedCpuFlag[0] != 0)                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            UEFI_LF(("CPU flag \"%s\" is not supported\n", wantedCpuFlag));                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        UEFI_LF(("Your CPU is already outdated. Please upgrade it"));                                                                                                                                    // Colorize: green
        UEFI_LF(("We recommend Intel Core i9-10980XE Extreme Edition or newer or AMD Ryzen Threadripper 3990X or newer"));                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here we are doing initialization of CPU module in order to obtain all CPU flags.<br/>                                                                                                                    // Colorize: green
We also check the CPU flags and inform user when CPU is not supported.                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Assets initialization                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Assets are the set of files directly included to kernel image from [src/os/configure/assets](../../../src/os/configure/assets) folder.                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_ASSERT_EXECUTION(Assets::init(), 0);                                                                                                                                                            // Colorize: green
    UEFI_LI(("Assets initialized"));                                                                                                                                                                     // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here we are calling [Assets::init()](https://github.com/Gris87/ngos/blob/master/src/os/shared/common/src/bits64/assets/assets.cpp#L19) function to perform loading addresses of all assets included to kernel image.<br/> // Colorize: green
We can get address of some asset with [Assets::getAssetEntry()](https://github.com/Gris87/ngos/blob/master/src/os/shared/common/src/bits64/assets/assets.cpp#L87) function after this.                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Early kernel testing                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#if NGOS_BUILD_TEST_MODE == OPTION_YES                                                                                                                                                                   // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        startTestSection0() != NgosStatus::OK                                                                                                                                                            // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        startTestSection1() != NgosStatus::OK                                                                                                                                                            // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Test failure"));                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
This code block is only working if kernel was built with the tests.<br/>                                                                                                                                 // Colorize: green
It just perform checking for the set of tests located in [src/os/shared/uefibase/test/bits64/sections/section0](../../../src/os/shared/uefibase/test/bits64/sections/section0) folder and in [src/os/configure/test/bits64/a_uefi/sections/section1](../../../src/os/configure/test/bits64/a_uefi/sections/section1) folder.<br/> // Colorize: green
In case of issue we leave uefiMain() function.                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Setup boot parameters                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Boot parameters are the set of parameters that can be shared between Configure part, Kernel part and Installer part.                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    BootParams *params = 0;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (setupBootParams(&params, kernelLocation) != NgosStatus::OK)                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to setup boot parameters"));                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("Setup boot parameters completed"));                                                                                                                                                        // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
If you check [setupBootParams()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/setupbootparams.cpp#L11) function you will know that it is allocating few pages for [BootParams](../../../src/os/include/bootparams/bootparams.h) structure and perform following simple initialization: // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    memzero(*params, sizeof(BootParams));                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    (*params)->header.signature      = BOOT_PARAMS_HEADER_SIGNATURE;                                                                                                                                     // Colorize: green
    (*params)->header.kernelLocation = kernelLocation;                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Setup graphics                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We need to setup graphics in order to have possibility to draw something on the screen.                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    if (setupGraphics(params) != NgosStatus::OK)                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to setup graphics"));                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("Setup graphics completed"));                                                                                                                                                               // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
[setupGraphics()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/setupgraphics.cpp#L355) function loops over Graphics Output Protocols(GOP) and try to find GOP that support mode with the biggest screen resolution.<br/> // Colorize: green
After that we are switching to this mode(why not?) and updating screenInfo in boot parameters via [updateScreenInfo()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/setupgraphics.cpp#L47) function. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Since we have information about screen we can use our own printing on the screen.                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    UEFI_ASSERT_EXECUTION(Console::init(params), NgosStatus::ASSERTION);                                                                                                                                 // Colorize: green
    UEFI_LVV(("Console initialized"));                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
[Console](../../../src/os/shared/common/src/bits64/console/console.cpp) module is a special module that use predrawn glyphs for printing on the screen.<br/>                                             // Colorize: green
It even can print after calling UEFI::exitBootServices().<br/>                                                                                                                                           // Colorize: green
These glyphs located in kernel image as an asset. We are using freetype library to prepare the glyphs.<br/>                                                                                              // Colorize: green
You may check it in [code_generator](../../../tools/qt/code_generator/src/generators/assets/zzz_generators/consoleglyphgenerator.cpp) tool.                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Setup PCI IO                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Several PCI devices may have its own Read-only memory (ROM) that mostly used for initialization of such devices.<br/>                                                                                    // Colorize: green
We have to store these ROM images in order to setup these PCI devices.                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    if (setupPciIo(params) != NgosStatus::OK)                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to setup PCI IO"));                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("Setup PCI IO completed"));                                                                                                                                                                 // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
[setupPciIo()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/setuppciio.cpp#L298) function loops over PCI IO Protocols and try to find PCI devices with ROM image.<br/> // Colorize: green
If we found such device we will allocate enough space for storing its PCI ROM image.                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As a result we should have a linked list of [PciRomImageWithInfo](../../../src/os/include/bootparams/pciromimagewithinfo.h) objects in boot parameters that contains information about PCI device and the ROM image itself. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Setup kernel location                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
UEFI loads kernel image in any place of the memory.<br/>                                                                                                                                                 // Colorize: green
Sometimes it may cause issues in case when image is located above 4 GB limit since we may have to perform jump to 32 bit mode.<br/>                                                                      // Colorize: green
For example, switching to 5 level paging requires to jump to 32 bit mode.<br/>                                                                                                                           // Colorize: green
That's why we are relocating kernel to low address space.                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    if (setupKernelLocation(params) != NgosStatus::OK)                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to setup kernel location"));                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("Setup kernel location completed"));                                                                                                                                                        // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As you can see [setupKernelLocation()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/setupkernellocation.cpp#L20) function is a little bit complex. So, we will explain it more deeply. // Colorize: green
                                                                                                                                                                                                         // Colorize: green
First of all, we will get information about loaded image:                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    Guid                     protocol = UEFI_LOADED_IMAGE_PROTOCOL_GUID;                                                                                                                                 // Colorize: green
    uefi_handle              handle   = UEFI::getImageHandle();                                                                                                                                          // Colorize: green
    UefiLoadedImageProtocol *image    = 0;                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (UEFI::handleProtocol(handle, &protocol, (void **)&image) != UefiStatus::SUCCESS)                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to handle(0x%p) protocol for UEFI_LOADED_IMAGE_PROTOCOL", handle));                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return NgosStatus::FAILED;                                                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LVV(("Handled(0x%p) protocol(0x%p) for UEFI_LOADED_IMAGE_PROTOCOL", handle, image));                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LVVV(("Loaded image:"));                                                                                                                                                                        // Colorize: green
    UEFI_LVVV(("-------------------------------------"));                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LVVV(("image->imageBase = 0x%p", image->imageBase));                                                                                                                                            // Colorize: green
    UEFI_LVVV(("image->imageSize = %u",   image->imageSize));                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LVVV(("-------------------------------------"));                                                                                                                                                // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
The structure of kernel image can be displayed on figure below:                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/4.%20UEFI%20initialization/Image%20structure.png?raw=true" alt="Image structure"/>                                            // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Since Boot part and .reloc section is only required for UEFI we don't need it anymore.<br/>                                                                                                              // Colorize: green
We need to drop it from the relocated kernel.<br/>                                                                                                                                                       // Colorize: green
This can be done in the following way:                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    // image->imageBase - Address of loaded image                                                                                                                                                        // Colorize: green
    // image->imageSize == Boot part + .reloc section + Configure part + [De]compressed Kernel part                                                                                                      // Colorize: green
    // params->header.kernelLocation == image->imageBase + Boot part + .reloc section                                                                                                                    // Colorize: green
    // So imageSize will be equal to Configure part + [De]compressed Kernel part                                                                                                                         // Colorize: green
    u64 imageSize = image->imageSize - (params->header.kernelLocation - (u64)image->imageBase); // Remove Boot part and .reloc section                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As a result imageSize should be equal to total size of .config section and .kernel section.<br/>                                                                                                         // Colorize: green
But actually we have to allocate more memory for the kernel.                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
<p align="center">                                                                                                                                                                                       // Colorize: green
    <img src="https://github.com/Gris87/ngos/blob/master/docs/1.%20Booting/4.%20UEFI%20initialization/Kernel%20relocation.png?raw=true" alt="Image structure"/>                                          // Colorize: green
</p>                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As you can see we are also allocating space for page table, stack and for decompressed kernel if the kernel was compressed.<br/>                                                                         // Colorize: green
Page table should be properly aligned to page size. Therefore we are adding few bytes to imageSize variable to make it aligned.<br/>                                                                     // Colorize: green
It is expected that the location of relocated kernel will be also aligned to page size.                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    // We are going to allocate space for imageSize + page table + stack ( + decompressed Kernel part if it compressed)                                                                                  // Colorize: green
    //                                                                                                                                                                                                   // Colorize: green
    u64 allocSize =                                                                                                                                                                                      // Colorize: green
            ROUND_UP(imageSize, PAGE_SIZE)  // Use ROUND_UP in order to make space for page table to be aligned                                                                                          // Colorize: green
            + BOOT_PAGE_TABLE_SIZE                                                                                                                                                                       // Colorize: green
            + BOOT_STACK_SIZE                                                                                                                                                                            // Colorize: green
#if NGOS_BUILD_KERNEL_COMPRESSION != OPTION_KERNEL_COMPRESSION_NONE                                                                                                                                      // Colorize: green
            + kernelDescriptor->imageSize // Space for decompressed Kernel part                                                                                                                          // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
            ;                                                                                                                                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Page table grows from bottom to top while stack grows from top to bottom.<br/>                                                                                                                           // Colorize: green
There is may happen that stack overlap the page table area.<br/>                                                                                                                                         // Colorize: green
Stack size should be big enough in order to avoid it.                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
After that we are allocating space for relocated kernel and storing the results to boot parameters:                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    // Copy whole image except Boot part and .reloc section to address                                                                                                                                   // Colorize: green
    memcpy((void *)address, (void *)params->header.kernelLocation, imageSize);                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    params->header.kernelLocation      = address;                                                                                                                                                        // Colorize: green
    params->header.kernelSize          = imageSize;                                                                                                                                                      // Colorize: green
    params->header.allocatedKernelSize = allocSize;                                                                                                                                                      // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Exit Boot Services                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
At the end of UEFI initialization we are calling exitBootServices() function to release unnecessary resources.                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    if (exitBootServices(params) != NgosStatus::OK)                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        UEFI_LF(("Failed to exit boot services"));                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    UEFI_LI(("Exit boot services completed"));                                                                                                                                                           // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
If you check [exitBootServices()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/a_uefi/main/exitbootservices.cpp#L106) function you will know that we are getting memory map and trying to call UEFI::exitBootServices() with it.<br/> // Colorize: green
In case if the first attempt failed it means that memory map was changed and we have one more attempt to exit.                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
If everything is good we will store information about last known memory map to boot parameters.                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Jumping to relocated kernel                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We are ready to perform jump to the relocated kernel now.<br/>                                                                                                                                           // Colorize: green
As we already mention UEFI may load kernel image in any place of the memory and this can be a problem when we would like to switch to 32 bit mode while image loaded above 4 GB limit.                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Let's go back to [src/os/configure/asm/arch/x86_64/main.S](../../../src/os/configure/asm/arch/x86_64/main.S) file.                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ============================================================================= # =============================================================================                                          // Colorize: green
# Entry point                                                                   #                                                                                                                        // Colorize: green
#                                                                               #                                                                                                                        // Colorize: green
# RDX - address of systemTable                                                  #                                                                                                                        // Colorize: green
# RCX - address of imageHandle                                                  #                                                                                                                        // Colorize: green
# ============================================================================= # =============================================================================                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    movq    %rcx, %rdi                                                          # Put address of imageHandle to RDI                                                                                      // Colorize: green
    movq    %rdx, %rsi                                                          # Put address of systemTable to RSI                                                                                      // Colorize: green
    leaq    _start(%rip), %rdx                                                  # Put address of entry point to RDX                                                                                      // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    call    uefiMain                                                            # Call uefiMain function                                                                                                 // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    cmpq    $0, %rax                                                            # IF result == 0                                                                                                         // Colorize: green
    je      fail                                                                #   THEN jump to fail                                                                                                    // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    movq    %rax, %rsi                                                          # Put address of boot parameters to RSI                                                                                  // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As a result uefiMain() function should return address of boot parameters and 0 value in error case. In case of error we will jump to fail label and halt PC in forever loop.                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
But if everything was fine we will store the result to RSI register.                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Instructions below allows to get address of next instruction in relocated address space and perform jump to it.                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
# Jump to the relocated address                                                 #                                                                                                                        // Colorize: green
# ----------------------------------------------------------------------------- # -----------------------------------------------------------------------------                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    movq    ASM_OFFSET_BOOT_PARAM_KERNEL_LOCATION(%rsi), %rax                   # Get the relocated address of kernel                                                                                    // Colorize: green
    leaq    relocated_address(%rax), %rax                                       # Get address of relocated_address label in relocated address space                                                      // Colorize: green
    jmp     *%rax                                                               # Jump to relocated_address label in relocated address space                                                             // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
relocated_address:                                                              # Label for relocated address                                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
