NGOS                                                                                                                                                                                                     // Colorize: green
====                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
1.6. Kernel decompression                                                                                                                                                                                // Colorize: green
-------------------------                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As we already know from the previous [chapter](../2.%20First%20steps%20in%20the%20kernel/README.md) we jump to the C++ code after registers initialization with the instructions below:                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    pushq   %rsi                                                                # Push address of boot parameters (RSI) to the stack                                                                     // Colorize: green
    call    extractKernel                                                       # Call extractKernel function                                                                                            // Colorize: green
    popq    %rsi                                                                # Restore address of boot parameters back to RSI from the stack                                                          // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    cmpq    $0, %rax                                                            # IF result == 0                                                                                                         // Colorize: green
    je      fail                                                                #   THEN jump to fail                                                                                                    // Colorize: green
                                                                                #                                                                                                                        // Colorize: green
    jmp     *%rax                                                               # Jump to decompressed kernel                                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Let's go through [extractKernel()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/b_early/main/kernelextraction.cpp#L16) function and explain what we are doing.                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    EARLY_LT((" | kernelDescriptor = 0x%p, params = 0x%p, decompressedAddress = 0x%p, pageTable = 0x%p", kernelDescriptor, params, decompressedAddress, pageTable));                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    EARLY_ASSERT(kernelDescriptor,    "kernelDescriptor is null",    0);                                                                                                                                 // Colorize: green
    EARLY_ASSERT(params,              "params is null",              0);                                                                                                                                 // Colorize: green
    EARLY_ASSERT(decompressedAddress, "decompressedAddress is null", 0);                                                                                                                                 // Colorize: green
    EARLY_ASSERT(pageTable,           "pageTable is null",           0);                                                                                                                                 // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
As we already mention earlier we are providing LT logs for trace logging level at the very beginning of each function in order to provide information about currently executing function.<br/>           // Colorize: green
We are also doing basic checks for valid parameters at the beginning of function.                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#if NGOS_BUILD_KERNEL_COMPRESSION != OPTION_KERNEL_COMPRESSION_NONE                                                                                                                                      // Colorize: green
    if (decompress(kernelDescriptor->content, decompressedAddress, kernelDescriptor->contentSize, kernelDescriptor->imageSize) != NgosStatus::OK)                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        EARLY_LF(("Failed to decompress kernel image(0x%p) to address 0x%p", kernelDescriptor->content, decompressedAddress));                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    EARLY_LI(("Kernel decompression completed"));                                                                                                                                                        // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
If the kernel image was compressed we have to decompress it with the selected [compression method](../../0.%20Intro/3.%20Configuration/README.md#-----------ngos_build_kernel_compression-----------).<br/> // Colorize: green
Decompressed image should be placed in decompressedAddress space.                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Decompression algorithms implemented in [src/os/configure/src/bits64/b_early/main/decompressors](../../../src/os/configure/src/bits64/b_early/main/decompressors) folder.<br/>                           // Colorize: green
Here is the list of included headers:                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
#include "bits64/b_early/main/decompressors/gzip/decompress.h"                                                                                                                                           // Colorize: green
#include "bits64/b_early/main/decompressors/xz/decompress.h"                                                                                                                                             // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
### Extracting ELF image                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Included kernel image is actually a ELF file and its decompression is not enough yet.<br/>                                                                                                               // Colorize: green
We have to load it and place kernel binary image in some random place in the memory.                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    ElfHeader *elfHeader = (ElfHeader *)decompressedAddress;                                                                                                                                             // Colorize: green
    EARLY_LVVV(("elfHeader = 0x%p", elfHeader));                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
decompressedAddress points to address where we do the decompression of included kernel image. But it is also points to ELF Header of decompressed ELF file.                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    u64 elfMemorySize = getElfMemorySize(elfHeader);                                                                                                                                                     // Colorize: green
    EARLY_LVVV(("elfMemorySize = %u", elfMemorySize));                                                                                                                                                   // Colorize: green
    EARLY_TEST_ASSERT(elfMemorySize > 0, 0);                                                                                                                                                             // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Here we are calculating amount of memory required for extracted kernel binary image.                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    u64 physicalAddress = 0;                                                                                                                                                                             // Colorize: green
    u64 virtualAddress  = 0;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (getRandomLocation(params, pageTable, elfMemorySize, &physicalAddress, &virtualAddress) != NgosStatus::OK)                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        EARLY_LF(("Failed to find location for kernel"));                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return 0;                                                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    EARLY_LI(("Random location for kernel found"));                                                                                                                                                      // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We need to choose random location for kernel binary image for security reasons. This can be done with [getRandomLocation()](https://github.com/Gris87/ngos/blob/master/src/os/configure/src/bits64/b_early/main/randomization.cpp#L593) function.<br/> // Colorize: green
Detailed explanation for this function can be found at the next [chapter](../7.%20Kernel%20address%20space%20layout%20randomization/README.md).                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    EARLY_ASSERT_EXECUTION(loadElfToAddress(elfHeader, physicalAddress), 0);                                                                                                                             // Colorize: green
    EARLY_LI(("ELF loaded"));                                                                                                                                                                            // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Since we have found a random location for kernel we can put it there.                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
    EARLY_ASSERT_EXECUTION(handleRelocations(elfHeader, physicalAddress, virtualAddress), 0);                                                                                                            // Colorize: green
    EARLY_LI(("Relocations applied"));                                                                                                                                                                   // Colorize: green
```                                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
Kernel image compiled to be loaded at 0xFFFFFFFF80000000 virtual address.<br/>                                                                                                                           // Colorize: green
But we are choosing random virtual address in range 0xFFFFFFFF80000000 - 0xFFFFFFFFC0000000.<br/>                                                                                                        // Colorize: green
We should iterate all RELA entries in order to make them valid for the chosen virtual address.                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
We are ready now to perform jump to the extracted kernel binary image.<br/>                                                                                                                              // Colorize: green
It is expected that the entry point for kernel is located at the first byte.                                                                                                                             // Colorize: green
