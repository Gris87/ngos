#!/bin/bash
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PARAMETERS                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
WORKING_DIR=`pwd`                                                                                                                                                                                        # Colorize: green
BUILD_CONFIG=include/buildconfig.h                                                                                                                                                                       # Colorize: green
BUILD_LOG=/tmp/ngos_test_build.log                                                                                                                                                                       # Colorize: green
BUILD_CFG_BACKUP=/tmp/ngos_test_buildconfig2.h                                                                                                                                                           # Colorize: green
VM_LOG=/tmp/ngos_test_vm.log                                                                                                                                                                         # Colorize: green
GDB_FIFO=/tmp/ngos_test_gdb_fifo                                                                                                                                                                         # Colorize: green
GDB_LOG=/tmp/ngos_test_gdb.log                                                                                                                                                                           # Colorize: green
MEMORY_DUMP=/tmp/ngos_test_memory.dmp                                                                                                                                                                    # Colorize: green
EXPECTED_MEMORY_DUMP=assets/PIE_memory.dmp.hex                                                                                                                                                           # Colorize: green
VM_NAME="NGOS_dev"                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PROCESSING                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo -e "\e[36m==================================================\e[0m"                                                                                                                                  # Colorize: green
echo -e "\e[36m                     Test: PIE\e[0m"                                                                                                                                                      # Colorize: green
echo -e "\e[36m==================================================\e[0m"                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m-------------------- Building --------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ../../                                                                                                                                                                                                # Colorize: green
cp ${BUILD_CONFIG} ${BUILD_CFG_BACKUP}                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
tools/qt/build_config_maker/build/build_config_maker ${BUILD_CONFIG} --reset NGOS_BUILD_X86_64_VECTORIZATION_MODE=OPTION_X86_64_VECTORIZATION_MODE_SSE2 NGOS_BUILD_X86_64_FUSED_MULTIPLY_ADD=OPTION_X86_64_FUSED_MULTIPLY_ADD_NONE > ${BUILD_LOG} 2>&1 # Colorize: green
make test-debug >> ${BUILD_LOG} 2>&1                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ $? -ne 0 ]; then                                                                                                                                                                                    # Colorize: green
    cat ${BUILD_LOG} 2>&1                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    cp ${BUILD_CFG_BACKUP} ${BUILD_CONFIG}                                                                                                                                                               # Colorize: green
    cd ${WORKING_DIR}/                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    exit 1                                                                                                                                                                                               # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cp ${BUILD_CFG_BACKUP} ${BUILD_CONFIG}                                                                                                                                                                   # Colorize: green
cd ${WORKING_DIR}/                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m-------------- Checking for GOTPCREL -------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
#GOTPCREL_SEARCH=`grep -r GOTPCREL ../../src/os/configure/ | grep -v ^Binary | grep -v procesself.o`                                                                                                      # Colorize: green
#                                                                                                                                                                                                         # Colorize: green
#if [ "${GOTPCREL_SEARCH}" != "" ]; then                                                                                                                                                                  # Colorize: green
#    echo "${GOTPCREL_SEARCH}"                                                                                                                                                                            # Colorize: green
#    echo "GOTPCREL found in asm code"                                                                                                                                                                    # Colorize: green
#                                                                                                                                                                                                         # Colorize: green
#    exit 1                                                                                                                                                                                               # Colorize: green
#fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------ Starting QEMU -----------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ../../tools/vm                                                                                                                                                                                        # Colorize: green
./start_vm.sh qemu none > ${VM_LOG} 2>&1 &                                                                                                                                                               # Colorize: green
cd ${WORKING_DIR}/                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------ Starting GDB ------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
rm ${GDB_FIFO} 2> /dev/null                                                                                                                                                                              # Colorize: green
mkfifo ${GDB_FIFO}                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
tail -f ${GDB_FIFO} | gdb > ${GDB_LOG} 2>&1 &                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m-------------- Waiting for GDB debug -------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) set architecture i386:x86-64:intel"                                                                                                                                                          # Colorize: green
echo "set architecture i386:x86-64:intel" > ${GDB_FIFO}                                                                                                                                                  # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    GDB_READY=`grep "gdb debug is ready to go" ${VM_LOG} | head -n 1`                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${GDB_READY}" != "" ]; then                                                                                                                                                                    # Colorize: green
        break                                                                                                                                                                                            # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    sleep 1                                                                                                                                                                                              # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "${GDB_READY}"                                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) target remote :1234"                                                                                                                                                                         # Colorize: green
echo "target remote :1234" > ${GDB_FIFO}                                                                                                                                                                 # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------ Breakpoint initialization -----------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
KERNEL_LOCATION=`grep "Application started at address" ${VM_LOG} | head -n 1`                                                                                                                            # Colorize: green
echo "${KERNEL_LOCATION}"                                                                                                                                                                                # Colorize: green
KERNEL_LOCATION=`echo "${KERNEL_LOCATION}" | sed -r "s/.*Application started at address (0x[0-9a-fA-F]+).*/\1/g"`                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) x/50i ${KERNEL_LOCATION}"                                                                                                                                                                    # Colorize: green
echo "x/50i ${KERNEL_LOCATION}" > ${GDB_FIFO}                                                                                                                                                            # Colorize: green
sleep 1                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    JUMP_TO_RELOCATION_ADDRESS=`tail -n 50 ${GDB_LOG} | grep "jmpq   \*%rax" | head -n 1`                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${JUMP_TO_RELOCATION_ADDRESS}" != "" ]; then                                                                                                                                                   # Colorize: green
        break                                                                                                                                                                                            # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    sleep 1                                                                                                                                                                                              # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "${JUMP_TO_RELOCATION_ADDRESS}"                                                                                                                                                                     # Colorize: green
JUMP_TO_RELOCATION_ADDRESS=`echo "${JUMP_TO_RELOCATION_ADDRESS}" | sed -r "s/ *(0x[0-9a-fA-F]+):.*/\1/g"`                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) br *0x${JUMP_TO_RELOCATION_ADDRESS}"                                                                                                                                                         # Colorize: green
echo "br *0x${JUMP_TO_RELOCATION_ADDRESS}" > ${GDB_FIFO}                                                                                                                                                 # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) continue"                                                                                                                                                                                    # Colorize: green
echo "continue" > ${GDB_FIFO}                                                                                                                                                                            # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    BREAKPOINT=`tail -n 5 ${GDB_LOG} | grep "${JUMP_TO_RELOCATION_ADDRESS}" | grep " in " | head -n 1`                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${BREAKPOINT}" != "" ]; then                                                                                                                                                                   # Colorize: green
        break                                                                                                                                                                                            # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    sleep 1                                                                                                                                                                                              # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "${BREAKPOINT}"                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) nexti"                                                                                                                                                                                       # Colorize: green
echo "nexti" > ${GDB_FIFO}                                                                                                                                                                               # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) x/50i \$pc"                                                                                                                                                                                  # Colorize: green
echo "x/50i \$pc" > ${GDB_FIFO}                                                                                                                                                                          # Colorize: green
sleep 1                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
OLD_RELOCATION_ADDRESS=${JUMP_TO_RELOCATION_ADDRESS}                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    JUMP_TO_RELOCATION_ADDRESS=`tail -n 50 ${GDB_LOG} | grep "jmpq   \*%rax" | grep -v "${OLD_RELOCATION_ADDRESS}" | head -n 1`                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${JUMP_TO_RELOCATION_ADDRESS}" != "" ]; then                                                                                                                                                   # Colorize: green
        break                                                                                                                                                                                            # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    sleep 1                                                                                                                                                                                              # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "${JUMP_TO_RELOCATION_ADDRESS}"                                                                                                                                                                     # Colorize: green
JUMP_TO_RELOCATION_ADDRESS=`echo "${JUMP_TO_RELOCATION_ADDRESS}" | sed -r "s/ *(0x[0-9a-fA-F]+):.*/\1/g"`                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) br *0x${JUMP_TO_RELOCATION_ADDRESS}"                                                                                                                                                         # Colorize: green
echo "br *0x${JUMP_TO_RELOCATION_ADDRESS}" > ${GDB_FIFO}                                                                                                                                                 # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) continue"                                                                                                                                                                                    # Colorize: green
echo "continue" > ${GDB_FIFO}                                                                                                                                                                            # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    BREAKPOINT=`tail -n 5 ${GDB_LOG} | grep "${JUMP_TO_RELOCATION_ADDRESS}" | grep " in " | head -n 1`                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${BREAKPOINT}" != "" ]; then                                                                                                                                                                   # Colorize: green
        break                                                                                                                                                                                            # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    sleep 1                                                                                                                                                                                              # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "${BREAKPOINT}"                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m----------------- Dumping memory -----------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) dump binary memory ${MEMORY_DUMP} 0 0x000A0000"                                                                                                                                              # Colorize: green
echo "dump binary memory ${MEMORY_DUMP} 0 0x000A0000" > ${GDB_FIFO}                                                                                                                                      # Colorize: green
sleep 10                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
hexdump -C ${MEMORY_DUMP} | grep -v "^00001" | grep -v "^000872" | grep -v "^0009f2" | grep -v "^\*$" > ${MEMORY_DUMP}.hex                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------- Killing GDB ------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) quit"                                                                                                                                                                                        # Colorize: green
echo "quit" > ${GDB_FIFO}                                                                                                                                                                                # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "(gdb) y"                                                                                                                                                                                           # Colorize: green
echo "y" > ${GDB_FIFO}                                                                                                                                                                                   # Colorize: green
#sleep 1                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
GDB_LOGGER_PID=`ps -ef | grep "tail -f ${GDB_FIFO}" | grep -v grep | awk '{print $2}'`                                                                                                                   # Colorize: green
kill -9 ${GDB_LOGGER_PID} > /dev/null 2>&1                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------ Killing QEMU ------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
sudo virsh destroy  "${VM_NAME}"         2> /dev/null                                                                                                                                                    # Colorize: green
sudo virsh undefine "${VM_NAME}" --nvram 2> /dev/null                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m----------------- Checking result ----------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
diff ${MEMORY_DUMP}.hex ${EXPECTED_MEMORY_DUMP}                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ $? -ne 0 ]; then                                                                                                                                                                                    # Colorize: green
    echo "Memory dumps are different"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    exit 1                                                                                                                                                                                               # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo "OK"                                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
exit 0                                                                                                                                                                                                   # Colorize: green
