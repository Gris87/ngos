#!/bin/bash
                                                                                                                                                                                                         # Colorize: green
# This script helps to perform all the required setup for the server                                                                                                                                     # Colorize: green
# Author: Maxim Shvecov                                                                                                                                                                                  # Colorize: green
# Usage: sudo ./setup.sh [-h] [--help] [...]                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PARAMETERS                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
SILENT_MODE=$1                                                                                                                                                                                           # Colorize: green
STEPS=( step1_options step2_options step3_options step4_options )                                                                                                                                        # Colorize: green
STEPS_COUNT=${#STEPS[@]}                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ "${SILENT_MODE}" == "" ]; then                                                                                                                                                                      # Colorize: green
    SILENT_MODE=0                                                                                                                                                                                        # Colorize: green
else                                                                                                                                                                                                     # Colorize: green
    SILENT_MODE=1                                                                                                                                                                                        # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    VERIFICATION                                                                                                                                                                                        # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ ${EUID} -ne 0 ]; then                                                                                                                                                                               # Colorize: green
    echo "Please run as root"                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    exit 1                                                                                                                                                                                               # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    FUNCTIONS                                                                                                                                                                                           # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function ping_server                                                                                                                                                                                     # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER=$1                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    curl -k -s -w "%{time_total}" https://${SERVER}/rest/ping.php || return 1                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function send_post_request                                                                                                                                                                               # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER=$1                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    curl -k -s -X POST -H "Content-Type: application/json" -d @- ${SERVER} || return 1                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function execute_sql                                                                                                                                                                                     # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SQL=$1                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    mysql -u root -D ngos -e "${SQL}" || return 1                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function execute_sql_without_header                                                                                                                                                                      # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SQL=$1                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    mysql -u root -D ngos -NB -e "${SQL}" || return 1                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function install_sources                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    ./install.sh || return 1                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "NGOS webapp installed"                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function setup_server_name                                                                                                                                                                               # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER_NAME_VALUE=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';"`                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_NAME_VALUE}" == "" ]; then                                                                                                                                                            # Colorize: green
        SERVER_NAME=$1                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        while [ "${SERVER_NAME}" == "" ];                                                                                                                                                                # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            echo -n "Enter server name: "                                                                                                                                                                # Colorize: green
            read SERVER_NAME                                                                                                                                                                             # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        execute_sql "INSERT INTO properties (name, value) VALUES ('server_name', '${SERVER_NAME}');" || return 1                                                                                         # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        if [ ${SILENT_MODE} -eq 0 ]; then                                                                                                                                                                # Colorize: green
            while true                                                                                                                                                                                   # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "This operation is only required in case when your server DNS name changed."                                                                                                        # Colorize: green
                echo "It is your responsibility to update server list information on all other servers."                                                                                                 # Colorize: green
                echo -n "Do you really need to change server name? (y/N) "                                                                                                                               # Colorize: green
                read CONFIRM                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                if [ "${CONFIRM}" == "y" -o "${CONFIRM}" == "Y" ]; then                                                                                                                                  # Colorize: green
                    CONFIRM=1                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                elif [ "${CONFIRM}" == "" -o "${CONFIRM}" == "n" -o "${CONFIRM}" == "N" ]; then                                                                                                          # Colorize: green
                    CONFIRM=0                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                fi                                                                                                                                                                                       # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            CONFIRM=1                                                                                                                                                                                    # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ ${CONFIRM} -eq 1 ]; then                                                                                                                                                                    # Colorize: green
            SERVER_NAME=$1                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            while [ "${SERVER_NAME}" == "" ];                                                                                                                                                            # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo -n "Enter server name: "                                                                                                                                                            # Colorize: green
                read SERVER_NAME                                                                                                                                                                         # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${SERVER_NAME}" != "${SERVER_NAME_VALUE}" ]; then                                                                                                                                      # Colorize: green
                execute_sql "UPDATE properties SET value = '${SERVER_NAME}' WHERE name = 'server_name';" || return 1                                                                                     # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Server name changed to ${SERVER_NAME}"                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function generate_secret_key                                                                                                                                                                             # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SECRET_KEY_ID=`execute_sql_without_header "SELECT id FROM properties WHERE name = 'secret_key';"`                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SECRET_KEY_ID}" == "" ]; then                                                                                                                                                                # Colorize: green
        MY_SECRET_KEY=`cat /dev/urandom | tr -dc "a-zA-Z0-9" | fold -w 1000 | head -n 1`                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        execute_sql "INSERT INTO properties (name, value) VALUES ('secret_key', '${MY_SECRET_KEY}');" || return 1                                                                                        # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        if [ ${SILENT_MODE} -eq 0 ]; then                                                                                                                                                                # Colorize: green
            while true                                                                                                                                                                                   # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "This operation is only required in case when security violation detected."                                                                                                         # Colorize: green
                echo "It is your responsibility to update server list information on all other servers."                                                                                                 # Colorize: green
                echo -n "Do you really need to generate new secret key? (y/N) "                                                                                                                          # Colorize: green
                read CONFIRM                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                if [ "${CONFIRM}" == "y" -o "${CONFIRM}" == "Y" ]; then                                                                                                                                  # Colorize: green
                    CONFIRM=1                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                elif [ "${CONFIRM}" == "" -o "${CONFIRM}" == "n" -o "${CONFIRM}" == "N" ]; then                                                                                                          # Colorize: green
                    CONFIRM=0                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                fi                                                                                                                                                                                       # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            CONFIRM=1                                                                                                                                                                                    # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ ${CONFIRM} -eq 1 ]; then                                                                                                                                                                    # Colorize: green
            MY_SECRET_KEY=`cat /dev/urandom | tr -dc "a-zA-Z0-9" | fold -w 1000 | head -n 1`                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            execute_sql "UPDATE properties SET value = '${MY_SECRET_KEY}' WHERE name = 'secret_key';" || return 1                                                                                        # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Secret key:"                                                                                                                                                                                   # Colorize: green
    echo "${MY_SECRET_KEY}"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function assign_secret_key                                                                                                                                                                               # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER_NAME=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';"`                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_NAME}" == "" ]; then                                                                                                                                                                  # Colorize: green
        echo "Server name is invalid. Please specify new server name"                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MY_SECRET_KEY=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'secret_key';" | tr -dc "a-zA-Z0-9"`                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${#MY_SECRET_KEY} -ne 1000 ]; then                                                                                                                                                              # Colorize: green
        echo "Secret key is invalid. Please generate new secret key"                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER=$1                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER}" == "" ]; then                                                                                                                                                                       # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            clear                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo "Assign secret key to server:"                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            unset OPTIONS                                                                                                                                                                                # Colorize: green
            OPTION_NUM=1                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            for SERVER in `execute_sql_without_header "SELECT t1.address FROM servers AS t1 INNER JOIN regions as t2 ON t1.region_id = t2.id ORDER BY t2.name, t1.address;"`                             # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                REGION=`execute_sql_without_header "SELECT t2.name as region FROM servers AS t1 INNER JOIN regions as t2 ON t1.region_id = t2.id WHERE t1.address = '${SERVER}';"`                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                SERVER_LENGTH=${#SERVER}                                                                                                                                                                 # Colorize: green
                REGION_LENGTH=${#REGION}                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                printf "[%s] %s%$((60 - SERVER_LENGTH))s%s%$((30 - REGION_LENGTH))s" "${OPTION_NUM}" "${SERVER}" "" "${REGION}" ""                                                                       # Colorize: green
                execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${SERVER}';" | cut -c -20                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                OPTIONS[${OPTION_NUM}]=${SERVER}                                                                                                                                                         # Colorize: green
                OPTION_NUM=$((${OPTION_NUM} + 1))                                                                                                                                                        # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo "[0] Cancel"                                                                                                                                                                            # Colorize: green
            OPTIONS[0]="~~~CANCEL~~~"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo -n "Option: "                                                                                                                                                                           # Colorize: green
            read SELECTED_OPTION                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            SERVER=${OPTIONS[${SELECTED_OPTION}]}                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${SERVER}" != "" ]; then                                                                                                                                                               # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${SERVER}" == "~~~CANCEL~~~" ]; then                                                                                                                                                       # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER_ID=`execute_sql_without_header "SELECT id FROM servers WHERE address = '${SERVER}';"`                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_ID}" == "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Server ${SERVER} not found"                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SECRET_KEY=$2                                                                                                                                                                                        # Colorize: green
    SECRET_KEY=`echo "${SECRET_KEY}" | tr -dc "a-zA-Z0-9"`                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    while [ ${#SECRET_KEY} -ne 1000 ];                                                                                                                                                                   # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo -n "Enter secret key for server ${SERVER}: "                                                                                                                                                # Colorize: green
        read SECRET_KEY                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        SECRET_KEY=`echo "${SECRET_KEY}" | tr -dc "a-zA-Z0-9"`                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ ${#SECRET_KEY} -ne 1000 ]; then                                                                                                                                                             # Colorize: green
            echo "Invalid secret key"                                                                                                                                                                    # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MY_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${SERVER_NAME}';"`                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${MY_SECRET_KEY}" == "" -o "${MY_SECRET_KEY}" == "NULL" ]; then                                                                                                                                # Colorize: green
        execute_sql "UPDATE servers SET secret_key = '${SECRET_KEY}' WHERE address = '${SERVER}';" || return 1                                                                                           # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        for ADDRESS in `execute_sql_without_header "SELECT address FROM servers ORDER BY address;"`                                                                                                      # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            echo "Assigning secret key of server ${SERVER} on server ${ADDRESS}"                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            ANOTHER_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${ADDRESS}';"`                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            ASSIGNMENT_REQUEST_DATA=`cat << EOF                                                                                                                                                          # Colorize: green
                {                                                                                                                                                                                        # Colorize: green
                    "my_address":      "${SERVER_NAME}",                                                                                                                                                 # Colorize: green
                    "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                               # Colorize: green
                    "your_secret_key": "${ANOTHER_SECRET_KEY}",                                                                                                                                          # Colorize: green
                    "address":         "${SERVER}",                                                                                                                                                      # Colorize: green
                    "secret_key":      "${SECRET_KEY}"                                                                                                                                                   # Colorize: green
                }                                                                                                                                                                                        # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
            `                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            ASSIGNMENT_RESPONSE=`echo "${ASSIGNMENT_REQUEST_DATA}" | send_post_request https://${ADDRESS}/rest/assign_secret_key.php`                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${ASSIGNMENT_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                               # Colorize: green
                echo "Failed to assign secret key of server ${SERVER} on server ${ADDRESS}: ${ASSIGNMENT_RESPONSE}"                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                return 1                                                                                                                                                                                 # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Secret key assigned to server ${SERVER}"                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function update_sources                                                                                                                                                                                  # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    cp -r html/. /var/www/html               || return 1                                                                                                                                                 # Colorize: green
    chown -R www-data:www-data /var/www/html || return 1                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "NGOS webapp sources updated"                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function register_server                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER_NAME=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';"`                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_NAME}" == "" ]; then                                                                                                                                                                  # Colorize: green
        echo "Server name is invalid. Please specify new server name"                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MY_SECRET_KEY=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'secret_key';" | tr -dc "a-zA-Z0-9"`                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${#MY_SECRET_KEY} -ne 1000 ]; then                                                                                                                                                              # Colorize: green
        echo "Secret key is invalid. Please generate new secret key"                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER=$1                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    while [ "${SERVER}" == "" ];                                                                                                                                                                         # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo -n "Enter server name: "                                                                                                                                                                    # Colorize: green
        read SERVER                                                                                                                                                                                      # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER}" == "${SERVER_NAME}" ]; then                                                                                                                                                         # Colorize: green
        echo "${SERVER} is the localhost"                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER_ID=`execute_sql_without_header "SELECT id FROM servers WHERE address = '${SERVER}';"`                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_ID}" != "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Server ${SERVER} already registered"                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGION=$2                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION}" == "" ]; then                                                                                                                                                                       # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            clear                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo "Choose server location:"                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            OLD_IFS=${IFS}                                                                                                                                                                               # Colorize: green
            IFS=$'\n'                                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            unset OPTIONS                                                                                                                                                                                # Colorize: green
            OPTION_NUM=1                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            for REGION in `execute_sql_without_header "SELECT name FROM regions ORDER BY name;"`                                                                                                         # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "[${OPTION_NUM}] ${REGION}"                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                OPTIONS[${OPTION_NUM}]=${REGION}                                                                                                                                                         # Colorize: green
                OPTION_NUM=$((${OPTION_NUM} + 1))                                                                                                                                                        # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo "[0] Cancel"                                                                                                                                                                            # Colorize: green
            OPTIONS[0]="~~~CANCEL~~~"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            IFS=${OLD_IFS}                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo -n "Option: "                                                                                                                                                                           # Colorize: green
            read SELECTED_OPTION                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            REGION=${OPTIONS[${SELECTED_OPTION}]}                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${REGION}" != "" ]; then                                                                                                                                                               # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${REGION}" == "~~~CANCEL~~~" ]; then                                                                                                                                                       # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGION_ID=`execute_sql_without_header "SELECT id FROM regions WHERE name = '${REGION}';"`                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION_ID}" == "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Region ${REGION} not found"                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SECRET_KEY=$3                                                                                                                                                                                        # Colorize: green
    SECRET_KEY=`echo "${SECRET_KEY}" | tr -dc "a-zA-Z0-9"`                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    while [ ${#SECRET_KEY} -ne 1000 ];                                                                                                                                                                   # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo -n "Enter secret key for server ${SERVER}: "                                                                                                                                                # Colorize: green
        read SECRET_KEY                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        SECRET_KEY=`echo "${SECRET_KEY}" | tr -dc "a-zA-Z0-9"`                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ ${#SECRET_KEY} -ne 1000 ]; then                                                                                                                                                             # Colorize: green
            echo "Invalid secret key"                                                                                                                                                                    # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    PING_REQUEST_DATA=`cat << EOF                                                                                                                                                                        # Colorize: green
        {                                                                                                                                                                                                # Colorize: green
            "my_address":      "${SERVER_NAME}",                                                                                                                                                         # Colorize: green
            "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                                       # Colorize: green
            "your_secret_key": "${SECRET_KEY}"                                                                                                                                                           # Colorize: green
        }                                                                                                                                                                                                # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
    `                                                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    PING_RESPONSE=`echo "${PING_REQUEST_DATA}" | send_post_request https://${SERVER}/rest/ping.php`                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${PING_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                             # Colorize: green
        echo "Failed to ping server ${SERVER}: ${PING_RESPONSE}"                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    PING_TOTAL=0                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ((i = 0; i < 10; i++))                                                                                                                                                                           # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        PING_RESPONSE=`ping_server ${SERVER}`                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${PING_RESPONSE:0:15}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                    # Colorize: green
            echo "Failed to ping server ${SERVER}: ${PING_RESPONSE}"                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        PING_TOTAL=`echo "${PING_TOTAL} + ${PING_RESPONSE:15}" | bc`                                                                                                                                     # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    DELAY=`echo "${PING_TOTAL} * 100000 / 1" | bc`                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    execute_sql "INSERT INTO servers (region_id, address, delay, secret_key) VALUES ('${REGION_ID}', '${SERVER}', '${DELAY}', '${SECRET_KEY}');" || return 1                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ADDRESS in `execute_sql_without_header "SELECT address FROM servers WHERE address != '${SERVER_NAME}' ORDER BY address;"`                                                                        # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo "Registering server ${ADDRESS} on server ${SERVER}"                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ANOTHER_REGION_ID=`execute_sql_without_header  "SELECT region_id  FROM servers WHERE address = '${ADDRESS}';"`                                                                                   # Colorize: green
        ANOTHER_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${ADDRESS}';"`                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        REGISTER_REQUEST_DATA=`cat << EOF                                                                                                                                                                # Colorize: green
            {                                                                                                                                                                                            # Colorize: green
                "my_address":      "${SERVER_NAME}",                                                                                                                                                     # Colorize: green
                "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                                   # Colorize: green
                "your_secret_key": "${SECRET_KEY}",                                                                                                                                                      # Colorize: green
                "region_id":       ${ANOTHER_REGION_ID},                                                                                                                                                 # Colorize: green
                "address":         "${ADDRESS}",                                                                                                                                                         # Colorize: green
                "secret_key":      "${ANOTHER_SECRET_KEY}"                                                                                                                                               # Colorize: green
            }                                                                                                                                                                                            # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
        `                                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        REGISTER_RESPONSE=`echo "${REGISTER_REQUEST_DATA}" | send_post_request https://${SERVER}/rest/register.php`                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${REGISTER_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                     # Colorize: green
            echo "Failed to register server ${ADDRESS} on server ${SERVER}: ${REGISTER_RESPONSE}"                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ADDRESS in `execute_sql_without_header "SELECT address FROM servers WHERE address != '${SERVER}' AND address != '${SERVER_NAME}' ORDER BY address;"`                                             # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo "Registering server ${SERVER} on server ${ADDRESS}"                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ANOTHER_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${ADDRESS}';"`                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        REGISTER_REQUEST_DATA=`cat << EOF                                                                                                                                                                # Colorize: green
            {                                                                                                                                                                                            # Colorize: green
                "my_address":      "${SERVER_NAME}",                                                                                                                                                     # Colorize: green
                "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                                   # Colorize: green
                "your_secret_key": "${ANOTHER_SECRET_KEY}",                                                                                                                                              # Colorize: green
                "region_id":       ${REGION_ID},                                                                                                                                                         # Colorize: green
                "address":         "${SERVER}",                                                                                                                                                          # Colorize: green
                "secret_key":      "${SECRET_KEY}"                                                                                                                                                       # Colorize: green
            }                                                                                                                                                                                            # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
        `                                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        REGISTER_RESPONSE=`echo "${REGISTER_REQUEST_DATA}" | send_post_request https://${ADDRESS}/rest/register.php`                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${REGISTER_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                     # Colorize: green
            echo "Failed to register server ${ADDRESS} on server ${SERVER}: ${REGISTER_RESPONSE}"                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Server ${SERVER} registered"                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function change_server_location                                                                                                                                                                          # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    SERVER_NAME=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';"`                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_NAME}" == "" ]; then                                                                                                                                                                  # Colorize: green
        echo "Server name is invalid. Please specify new server name"                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MY_SECRET_KEY=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'secret_key';" | tr -dc "a-zA-Z0-9"`                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${#MY_SECRET_KEY} -ne 1000 ]; then                                                                                                                                                              # Colorize: green
        echo "Secret key is invalid. Please generate new secret key"                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER=$1                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER}" == "" ]; then                                                                                                                                                                       # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            clear                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo "Change location for server:"                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            unset OPTIONS                                                                                                                                                                                # Colorize: green
            OPTION_NUM=1                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            for SERVER in `execute_sql_without_header "SELECT t1.address FROM servers AS t1 INNER JOIN regions as t2 ON t1.region_id = t2.id ORDER BY t2.name, t1.address;"`                             # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                SERVER_LENGTH=${#SERVER}                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                printf "[%s] %s%$((60 - SERVER_LENGTH))s" "${OPTION_NUM}" "${SERVER}" ""                                                                                                                 # Colorize: green
                execute_sql_without_header "SELECT t2.name as region FROM servers AS t1 INNER JOIN regions as t2 ON t1.region_id = t2.id WHERE t1.address = '${SERVER}';" || return 1                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                OPTIONS[${OPTION_NUM}]=${SERVER}                                                                                                                                                         # Colorize: green
                OPTION_NUM=$((${OPTION_NUM} + 1))                                                                                                                                                        # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo "[0] Cancel"                                                                                                                                                                            # Colorize: green
            OPTIONS[0]="~~~CANCEL~~~"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo -n "Option: "                                                                                                                                                                           # Colorize: green
            read SELECTED_OPTION                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            SERVER=${OPTIONS[${SELECTED_OPTION}]}                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${SERVER}" != "" ]; then                                                                                                                                                               # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${SERVER}" == "~~~CANCEL~~~" ]; then                                                                                                                                                       # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER_ID=`execute_sql_without_header "SELECT id FROM servers WHERE address = '${SERVER}';"`                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_ID}" == "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Server ${SERVER} not found"                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGION=$2                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION}" == "" ]; then                                                                                                                                                                       # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            clear                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo "Choose server location for server ${SERVER}:"                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            OLD_IFS=${IFS}                                                                                                                                                                               # Colorize: green
            IFS=$'\n'                                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            unset OPTIONS                                                                                                                                                                                # Colorize: green
            OPTION_NUM=1                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            for REGION in `execute_sql_without_header "SELECT name FROM regions ORDER BY name;"`                                                                                                         # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "[${OPTION_NUM}] ${REGION}"                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                OPTIONS[${OPTION_NUM}]=${REGION}                                                                                                                                                         # Colorize: green
                OPTION_NUM=$((${OPTION_NUM} + 1))                                                                                                                                                        # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo "[0] Cancel"                                                                                                                                                                            # Colorize: green
            OPTIONS[0]="~~~CANCEL~~~"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            IFS=${OLD_IFS}                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            echo -n "Option: "                                                                                                                                                                           # Colorize: green
            read SELECTED_OPTION                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            REGION=${OPTIONS[${SELECTED_OPTION}]}                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${REGION}" != "" ]; then                                                                                                                                                               # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${REGION}" == "~~~CANCEL~~~" ]; then                                                                                                                                                       # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGION_ID=`execute_sql_without_header "SELECT id FROM regions WHERE name = '${REGION}';"`                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION_ID}" == "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Region ${REGION} not found"                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ADDRESS in `execute_sql_without_header "SELECT address FROM servers ORDER BY address;"`                                                                                                          # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo "Changing server ${SERVER} location on server ${ADDRESS}"                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ANOTHER_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${ADDRESS}';"`                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        LOCATION_REQUEST_DATA=`cat << EOF                                                                                                                                                                # Colorize: green
            {                                                                                                                                                                                            # Colorize: green
                "my_address":      "${SERVER_NAME}",                                                                                                                                                     # Colorize: green
                "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                                   # Colorize: green
                "your_secret_key": "${ANOTHER_SECRET_KEY}",                                                                                                                                              # Colorize: green
                "region_id":       ${REGION_ID},                                                                                                                                                         # Colorize: green
                "address":         "${SERVER}"                                                                                                                                                           # Colorize: green
            }                                                                                                                                                                                            # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
        `                                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        LOCATION_RESPONSE=`echo "${LOCATION_REQUEST_DATA}" | send_post_request https://${ADDRESS}/rest/location.php`                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${LOCATION_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                     # Colorize: green
            echo "Failed to change server ${SERVER} location on server ${ADDRESS}: ${LOCATION_RESPONSE}"                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Server ${SERVER} location changed to ${REGION}"                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function update_server_delays                                                                                                                                                                            # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    for SERVER in `execute_sql_without_header "SELECT address FROM servers ORDER BY address;"`                                                                                                           # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo "Updating delay to server: ${SERVER}"                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        PING_TOTAL=0                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        for ((i = 0; i < 10; i++))                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            PING_RESPONSE=`ping_server ${SERVER}`                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${PING_RESPONSE:0:15}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                # Colorize: green
                echo "Failed to ping server ${SERVER}: ${PING_RESPONSE}"                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                return 1                                                                                                                                                                                 # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            PING_TOTAL=`echo "${PING_TOTAL} + ${PING_RESPONSE:15}" | bc`                                                                                                                                 # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        DELAY=`echo "${PING_TOTAL} * 100000 / 1" | bc`                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        execute_sql "UPDATE servers SET delay = '${DELAY}' WHERE address = '${SERVER}';" || return 1                                                                                                     # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function validate_setup                                                                                                                                                                                  # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    if [ ! -f /var/www/html/rest/ping.php ]; then                                                                                                                                                        # Colorize: green
        echo "NGOS webapp not installed"                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SERVER_NAME=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';"`                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${SERVER_NAME}" == "" ]; then                                                                                                                                                                  # Colorize: green
        echo "Server name is invalid. Please specify new server name"                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MY_SECRET_KEY=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'secret_key';" | tr -dc "a-zA-Z0-9"`                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${#MY_SECRET_KEY} -ne 1000 ]; then                                                                                                                                                              # Colorize: green
        echo "Secret key is invalid. Please generate new secret key"                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${MY_SECRET_KEY}" != "`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${SERVER_NAME}';"`" ]; then                                                                 # Colorize: green
        echo "Server is not registered. Please register"                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGION_ID=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'region_id';"`                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION_ID}" == "" -o "${REGION_ID}" != "`execute_sql_without_header "SELECT region_id FROM servers WHERE address = '${SERVER_NAME}';"`" ]; then                                              # Colorize: green
        echo "Server is not registered. Please register"                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    INVALID_SERVERS=`execute_sql_without_header "SELECT address FROM servers WHERE secret_key IS NULL OR LENGTH(secret_key) != 1000 ORDER BY address;"`                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${INVALID_SERVERS}" != "" ]; then                                                                                                                                                              # Colorize: green
        echo "Servers with invalid secret keys:"                                                                                                                                                         # Colorize: green
        echo "${INVALID_SERVERS}"                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        echo ""                                                                                                                                                                                          # Colorize: green
        echo "Please assign valid secret keys"                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ADDRESS in `execute_sql_without_header "SELECT address FROM servers ORDER BY address;"`                                                                                                          # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        echo "Pinging server ${ADDRESS}"                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ANOTHER_SECRET_KEY=`execute_sql_without_header "SELECT secret_key FROM servers WHERE address = '${ADDRESS}';"`                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        PING_REQUEST_DATA=`cat << EOF                                                                                                                                                                    # Colorize: green
            {                                                                                                                                                                                            # Colorize: green
                "my_address":      "${SERVER_NAME}",                                                                                                                                                     # Colorize: green
                "my_secret_key":   "${MY_SECRET_KEY}",                                                                                                                                                   # Colorize: green
                "your_secret_key": "${ANOTHER_SECRET_KEY}"                                                                                                                                               # Colorize: green
            }                                                                                                                                                                                            # Colorize: green
EOF                                                                                                                                                                                                      # Colorize: green
        `                                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        PING_RESPONSE=`echo "${PING_REQUEST_DATA}" | send_post_request https://${ADDRESS}/rest/ping.php`                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${PING_RESPONSE}" != "{\"status\":\"OK\"}" ]; then                                                                                                                                         # Colorize: green
            echo "Failed to ping server ${ADDRESS}: ${PING_RESPONSE}"                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Everything is OK"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function print_server_name                                                                                                                                                                               # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    echo "Server name:"                                                                                                                                                                                  # Colorize: green
    execute_sql_without_header "SELECT value FROM properties WHERE name = 'server_name';" || return 1                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function print_secret_key                                                                                                                                                                                # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    echo "Secret key:"                                                                                                                                                                                   # Colorize: green
    execute_sql_without_header "SELECT value FROM properties WHERE name = 'secret_key';" || return 1                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function print_region                                                                                                                                                                                    # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    REGION_ID=`execute_sql_without_header "SELECT value FROM properties WHERE name = 'region_id';"`                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${REGION_ID}" == "" ]; then                                                                                                                                                                    # Colorize: green
        echo "Server is not registered. Please register"                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "Region:"                                                                                                                                                                                       # Colorize: green
    execute_sql_without_header "SELECT name FROM regions WHERE id = '${REGION_ID}';" || return 1                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function print_servers                                                                                                                                                                                   # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    echo "Servers:"                                                                                                                                                                                      # Colorize: green
    execute_sql "SELECT t1.address, t2.name as region, t1.delay, SUBSTRING(t1.secret_key, 1, 20) as secret_key FROM servers AS t1 INNER JOIN regions as t2 ON t1.region_id = t2.id ORDER BY t2.name, t1.address;" || return 1 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function uninstall_sources                                                                                                                                                                               # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    if [ -d /var/www/html ]; then                                                                                                                                                                        # Colorize: green
        if [ ${SILENT_MODE} -eq 0 ]; then                                                                                                                                                                # Colorize: green
            while true                                                                                                                                                                                   # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "This operation will remove all NGOS webapp sources and all NGOS applications stored on this server."                                                                               # Colorize: green
                echo -n "Do you really want to uninstall NGOS webapp sources? (y/N) "                                                                                                                    # Colorize: green
                read CONFIRM                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                if [ "${CONFIRM}" == "y" -o "${CONFIRM}" == "Y" ]; then                                                                                                                                  # Colorize: green
                    CONFIRM=1                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                elif [ "${CONFIRM}" == "" -o "${CONFIRM}" == "n" -o "${CONFIRM}" == "N" ]; then                                                                                                          # Colorize: green
                    CONFIRM=0                                                                                                                                                                            # Colorize: green
                    break                                                                                                                                                                                # Colorize: green
                fi                                                                                                                                                                                       # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            CONFIRM=1                                                                                                                                                                                    # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ ${CONFIRM} -eq 1 ]; then                                                                                                                                                                    # Colorize: green
            rm -rf /var/www/html || return 1                                                                                                                                                             # Colorize: green
        else                                                                                                                                                                                             # Colorize: green
            echo "Canceled"                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 1                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        echo "Directory \"/var/www/html\" not found"                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "NGOS webapp sources uninstalled"                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function drop_database                                                                                                                                                                                   # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    if [ ${SILENT_MODE} -eq 0 ]; then                                                                                                                                                                    # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            echo "This operation will remove all data stored in NGOS database."                                                                                                                          # Colorize: green
            echo -n "Do you really want to drop NGOS database? (y/N) "                                                                                                                                   # Colorize: green
            read CONFIRM                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${CONFIRM}" == "y" -o "${CONFIRM}" == "Y" ]; then                                                                                                                                      # Colorize: green
                CONFIRM=1                                                                                                                                                                                # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            elif [ "${CONFIRM}" == "" -o "${CONFIRM}" == "n" -o "${CONFIRM}" == "N" ]; then                                                                                                              # Colorize: green
                CONFIRM=0                                                                                                                                                                                # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        CONFIRM=1                                                                                                                                                                                        # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${CONFIRM} -eq 1 ]; then                                                                                                                                                                        # Colorize: green
        mysql -u root -e "DROP DATABASE ngos" || return 1                                                                                                                                                # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        echo "Canceled"                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        return 1                                                                                                                                                                                         # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "NGOS database dropped"                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function quit()                                                                                                                                                                                          # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    QUIT=1                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function step1_options()                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    TITLE="Initial setup"                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[0]="Install webapp sources on the server"                                                                                                                                                       # Colorize: green
    FUNC[0]="install_sources"                                                                                                                                                                            # Colorize: green
    ATTRS[0]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[1]="Setup server name"                                                                                                                                                                          # Colorize: green
    FUNC[1]="setup_server_name"                                                                                                                                                                          # Colorize: green
    ATTRS[1]="NAME"                                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[2]="Generate server secret key"                                                                                                                                                                 # Colorize: green
    FUNC[2]="generate_secret_key"                                                                                                                                                                        # Colorize: green
    ATTRS[2]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[3]="Assign secret key to server"                                                                                                                                                                # Colorize: green
    FUNC[3]="assign_secret_key"                                                                                                                                                                          # Colorize: green
    ATTRS[3]="SERVER SECRET_KEY"                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function step2_options()                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    TITLE="Common stuff"                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[0]="Update webapp sources"                                                                                                                                                                      # Colorize: green
    FUNC[0]="update_sources"                                                                                                                                                                             # Colorize: green
    ATTRS[0]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[1]="Register new server"                                                                                                                                                                        # Colorize: green
    FUNC[1]="register_server"                                                                                                                                                                            # Colorize: green
    ATTRS[1]="SERVER REGION SECRET_KEY"                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[2]="Change server location"                                                                                                                                                                     # Colorize: green
    FUNC[2]="change_server_location"                                                                                                                                                                     # Colorize: green
    ATTRS[2]="SERVER REGION"                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[3]="Update server delays"                                                                                                                                                                       # Colorize: green
    FUNC[3]="update_server_delays"                                                                                                                                                                       # Colorize: green
    ATTRS[3]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function step3_options()                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    TITLE="Verification"                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[0]="Validate setup"                                                                                                                                                                             # Colorize: green
    FUNC[0]="validate_setup"                                                                                                                                                                             # Colorize: green
    ATTRS[0]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[1]="Print server name"                                                                                                                                                                          # Colorize: green
    FUNC[1]="print_server_name"                                                                                                                                                                          # Colorize: green
    ATTRS[1]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[2]="Print secret key"                                                                                                                                                                           # Colorize: green
    FUNC[2]="print_secret_key"                                                                                                                                                                           # Colorize: green
    ATTRS[2]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[3]="Print region"                                                                                                                                                                               # Colorize: green
    FUNC[3]="print_region"                                                                                                                                                                               # Colorize: green
    ATTRS[3]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[4]="Print servers"                                                                                                                                                                              # Colorize: green
    FUNC[4]="print_servers"                                                                                                                                                                              # Colorize: green
    ATTRS[4]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function step4_options()                                                                                                                                                                                 # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    TITLE="Uninstall"                                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[0]="Uninstall webapp sources"                                                                                                                                                                   # Colorize: green
    FUNC[0]="uninstall_sources"                                                                                                                                                                          # Colorize: green
    ATTRS[0]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    TEXT[1]="Drop database"                                                                                                                                                                              # Colorize: green
    FUNC[1]="drop_database"                                                                                                                                                                              # Colorize: green
    ATTRS[1]=""                                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function display_menu                                                                                                                                                                                    # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    QUIT=0                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    while [ ${QUIT} -eq 0 ];                                                                                                                                                                             # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        clear                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        unset OPTIONS                                                                                                                                                                                    # Colorize: green
        OPTION_NUM=1                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        for ((s = 0; s < ${STEPS_COUNT}; s++))                                                                                                                                                           # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            ${STEPS[s]} || return 1                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo "-----------------------------------------"                                                                                                                                             # Colorize: green
            echo " Step $s: ${TITLE}"                                                                                                                                                                    # Colorize: green
            echo "-----------------------------------------"                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            OPTIONS_COUNT=${#TEXT[@]}                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            for ((i = 0; i < ${OPTIONS_COUNT}; i++))                                                                                                                                                     # Colorize: green
            do                                                                                                                                                                                           # Colorize: green
                echo "[${OPTION_NUM}] ${TEXT[i]}"                                                                                                                                                        # Colorize: green
                OPTIONS[${OPTION_NUM}]=${FUNC[i]}                                                                                                                                                        # Colorize: green
                OPTION_NUM=$((${OPTION_NUM} + 1))                                                                                                                                                        # Colorize: green
            done                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            unset TEXT                                                                                                                                                                                   # Colorize: green
            unset FUNC                                                                                                                                                                                   # Colorize: green
            unset ATTRS                                                                                                                                                                                  # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        echo "[0] Exit"                                                                                                                                                                                  # Colorize: green
        OPTIONS[0]="quit"                                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        echo ""                                                                                                                                                                                          # Colorize: green
        echo -n "Option: "                                                                                                                                                                               # Colorize: green
        read SELECTED_OPTION                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        COMMAND=${OPTIONS[${SELECTED_OPTION}]}                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${COMMAND}" != "" ]; then                                                                                                                                                                  # Colorize: green
            echo ""                                                                                                                                                                                      # Colorize: green
            ${COMMAND}                                                                                                                                                                                   # Colorize: green
            EXIT_CODE=$?                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ ${QUIT} -eq 0 ]; then                                                                                                                                                                   # Colorize: green
                echo ""                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                if [ ${EXIT_CODE} -eq 0 ]; then                                                                                                                                                          # Colorize: green
                    echo "Success"                                                                                                                                                                       # Colorize: green
                else                                                                                                                                                                                     # Colorize: green
                    echo "Failed"                                                                                                                                                                        # Colorize: green
                fi                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                echo ""                                                                                                                                                                                  # Colorize: green
                echo -n "Press enter to continue ..."                                                                                                                                                    # Colorize: green
                read                                                                                                                                                                                     # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function usage()                                                                                                                                                                                         # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    echo -n "Usage: sudo ./setup.sh"                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ((s = 0; s < ${STEPS_COUNT}; s++))                                                                                                                                                               # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        ${STEPS[s]} || return 1                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        OPTIONS_COUNT=${#TEXT[@]}                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        for ((i = 0; i < ${OPTIONS_COUNT}; i++))                                                                                                                                                         # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            echo -n " [--${FUNC[i]}"                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${ATTRS[i]}" != "" ]; then                                                                                                                                                             # Colorize: green
                echo -n " ${ATTRS[i]}"                                                                                                                                                                   # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            echo -n "]"                                                                                                                                                                                  # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        unset TEXT                                                                                                                                                                                       # Colorize: green
        unset FUNC                                                                                                                                                                                       # Colorize: green
        unset ATTRS                                                                                                                                                                                      # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo ""                                                                                                                                                                                              # Colorize: green
    echo ""                                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ((s = 0; s < ${STEPS_COUNT}; s++))                                                                                                                                                               # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        ${STEPS[s]} || return 1                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        OPTIONS_COUNT=${#TEXT[@]}                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        for ((i = 0; i < ${OPTIONS_COUNT}; i++))                                                                                                                                                         # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            FUNC_ATTRS=`echo "--${FUNC[i]} ${ATTRS[i]}"`                                                                                                                                                 # Colorize: green
            FUNC_ATTRS_LENGTH=${#FUNC_ATTRS}                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            printf "    %s%$((50 - FUNC_ATTRS_LENGTH))s - %s\n" "${FUNC_ATTRS}" "" "${TEXT[i]}"                                                                                                          # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        unset TEXT                                                                                                                                                                                       # Colorize: green
        unset FUNC                                                                                                                                                                                       # Colorize: green
        unset ATTRS                                                                                                                                                                                      # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function script_mode()                                                                                                                                                                                   # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    while true                                                                                                                                                                                           # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        COMMAND=$1                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${COMMAND}" == "" ]; then                                                                                                                                                                  # Colorize: green
            break                                                                                                                                                                                        # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${COMMAND}" == "-h" -o "${COMMAND}" == "--help" ]; then                                                                                                                                    # Colorize: green
            usage || return 1                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            return 0                                                                                                                                                                                     # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ATTRS=()                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        while true                                                                                                                                                                                       # Colorize: green
        do                                                                                                                                                                                               # Colorize: green
            ATTR=$2                                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${ATTR}" == "" ]; then                                                                                                                                                                 # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${ATTR}" == "-h" -o "${ATTR:0:2}" == "--" ]; then                                                                                                                                      # Colorize: green
                break                                                                                                                                                                                    # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            ATTRS+=("${ATTR}")                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            shift                                                                                                                                                                                        # Colorize: green
        done                                                                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        ${COMMAND:2} "${ATTRS[@]}" || return 1                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        shift                                                                                                                                                                                            # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    return 0                                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PROCESSING                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ ${SILENT_MODE} -eq 0 ]; then                                                                                                                                                                        # Colorize: green
    display_menu || exit 1                                                                                                                                                                               # Colorize: green
else                                                                                                                                                                                                     # Colorize: green
    script_mode "$@" || exit 1                                                                                                                                                                           # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
exit 0                                                                                                                                                                                                   # Colorize: green
