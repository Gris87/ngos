#!/bin/bash
                                                                                                                                                                                                         # Colorize: green
# This script helps to trace over all linux kernel instructions                                                                                                                                          # Colorize: green
# Author: Maxim Shvetsov                                                                                                                                                                                  # Colorize: green
# Usage: ./linux.sh                                                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PARAMETERS                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
OS_NAME=linux                                                                                                                                                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
CURRENT_PATH=`pwd`                                                                                                                                                                                        # Colorize: green
TEMP_LOG=`mktemp -t ngos_tracer_${OS_NAME}_kernel_XXXX.log`                                                                                                                                                                      # Colorize: green
GDB_FIFO=`mktemp -t ngos_tracer_${OS_NAME}_gdb_fifo_XXXX`                                                                                                                                                                        # Colorize: green
GDB_LOG=`mktemp -t ngos_tracer_${OS_NAME}_gdb_XXXX.log`                                                                                                                                                                          # Colorize: green
LAST_BREAKPOINT_FILE=`mktemp -t ngos_tracer_${OS_NAME}_breakpoint_XXXX.txt`                                                                                                                                                      # Colorize: green
LAST_REGISTERS_FILE=`mktemp -t ngos_tracer_${OS_NAME}_registers_XXXX.txt`                                                                                                                                                       # Colorize: green
OUTPUT_FILE=`mktemp -t ngos_tracer_${OS_NAME}_tracer_XXXX.txt`                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
BZ_IMAGE_ELF=../../../${OS_NAME}/arch/x86/boot/compressed/vmlinux                                                                                                                                        # Colorize: green
VM_LINUX_ELF=../../../${OS_NAME}/vmlinux                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
INITIAL_BREAKPOINT=0x3FFA3343                                                                                                                                                                            # Colorize: green
INITIAL_ADDRESS=0x39E6B4F0                                                                                                                                                                               # Colorize: green
PREFERRED_ADDRESS=0x01400000                                                                                                                                                                             # Colorize: green
RELOCATED_ADDRESS=0x035214B0                                                                                                                                                                             # Colorize: green
RANDOM_PHYSICAL_ADDRESS=0x03600000                                                                                                                                                                       # Colorize: green
RANDOM_VIRTUAL_ADDRESS=0xFFFFFFFF81000000                                                                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
NEXTI_FILTERS=(                                                                                                                                                                                          # Colorize: green
    -E                                                                                                                                                                                                   # Colorize: green
    -e "<efi_call>"                                                                                                                                                                                      # Colorize: green
    -e "<efi_low_alloc>"                                                                                                                                                                                 # Colorize: green
    -e "<efi_high_alloc>"                                                                                                                                                                                # Colorize: green
    -e "<efi_get_memory_map>"                                                                                                                                                                            # Colorize: green
    -e "<memset>"                                                                                                                                                                                        # Colorize: green
    -e "<memcpy>"                                                                                                                                                                                        # Colorize: green
    -e "<memmove>"                                                                                                                                                                                       # Colorize: green
    -e "<memcmp>"                                                                                                                                                                                        # Colorize: green
    -e "<strstr>"                                                                                                                                                                                        # Colorize: green
    -e "<strlen>"                                                                                                                                                                                        # Colorize: green
    -e "<strnlen>"                                                                                                                                                                                       # Colorize: green
    -e "<strcmp>"                                                                                                                                                                                        # Colorize: green
    -e "<strncmp>"                                                                                                                                                                                       # Colorize: green
    -e "<__gunzip>"                                                                                                                                                                                      # Colorize: green
    -e "<_get_random_bytes>"                                                                                                                                                                             # Colorize: green
    -e "<printk>"                                                                                                                                                                                        # Colorize: green
    -e "<scnprintf>"                                                                                                                                                                                     # Colorize: green
    -e "<vsnprintf>"                                                                                                                                                                                     # Colorize: green
    -e "<print_filtered>"                                                                                                                                                                                # Colorize: green
    -e "<sort>"                                                                                                                                                                                          # Colorize: green
)                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
NEXT_FILTERS=(                                                                                                                                                                                           # Colorize: green
    -E                                                                                                                                                                                                   # Colorize: green
    -e "rep \w+"                                                                                                                                                                                         # Colorize: green
)                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
FINISH_FILTERS=(                                                                                                                                                                                         # Colorize: green
    -E                                                                                                                                                                                                   # Colorize: green
    -e "placeholder123456789"                                                                                                                                                                            # Colorize: green
)                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    FUNCTIONS                                                                                                                                                                                           # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
function execute_gdb_command                                                                                                                                                                             # Colorize: green
{                                                                                                                                                                                                        # Colorize: green
    COMMAND=$1                                                                                                                                                                                           # Colorize: green
    VERBOSE=$2                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    COMMAND_ID=`date +%s%N`                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${VERBOSE}" == "-v" ]; then                                                                                                                                                                    # Colorize: green
        echo "(gdb) ${COMMAND}"                                                                                                                                                                          # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "echo ${COMMAND}\n"                   > ${GDB_FIFO}                                                                                                                                             # Colorize: green
    echo "echo >>>>>>>> BEGIN ${COMMAND_ID}\n" > ${GDB_FIFO}                                                                                                                                             # Colorize: green
    echo "${COMMAND}"                          > ${GDB_FIFO}                                                                                                                                             # Colorize: green
    echo "echo <<<<<<<< END ${COMMAND_ID}\n"   > ${GDB_FIFO}                                                                                                                                             # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    while true                                                                                                                                                                                           # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        END_INDEX=`grep -a -n -m 1 "<<<<<<<< END ${COMMAND_ID}" ${GDB_LOG} | cut -d : -f 1`                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${END_INDEX}" != "" ]; then                                                                                                                                                                # Colorize: green
            break                                                                                                                                                                                        # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    START_INDEX=`grep -a -n -m 1 ">>>>>>>> BEGIN ${COMMAND_ID}" ${GDB_LOG} | cut -d : -f 1`                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    END_INDEX=$((${END_INDEX} - 1))                                                                                                                                                                      # Colorize: green
    LINE_COUNT=$((${END_INDEX} - ${START_INDEX}))                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    head -n ${END_INDEX} ${GDB_LOG} | tail -n ${LINE_COUNT} | sed "s/(gdb) //g"                                                                                                                          # Colorize: green
    truncate -s 0 ${GDB_LOG}                                                                                                                                                                             # Colorize: green
}                                                                                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
#    PROCESSING                                                                                                                                                                                          # Colorize: green
###########################################################################################                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo -e "\e[36m==================================================\e[0m"                                                                                                                                  # Colorize: green
echo -e "\e[36m                    Linux tracer\e[0m"                                                                                                                                                    # Colorize: green
echo -e "\e[36m==================================================\e[0m"                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ "`pwd | grep tools/tracers`" == "" -o ! -f ${OS_NAME}.sh ]; then                                                                                                                                    # Colorize: green
    echo "Please run this script from the script local folder"                                                                                                                                           # Colorize: green
    exit 1                                                                                                                                                                                               # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m----------------- Initialization -----------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ../../tools/gdb                                                                                                                                                                                       # Colorize: green
./install.sh                                                                                                                                                                                             # Colorize: green
cd ${CURRENT_PATH}/                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m-------------------- Building --------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ../../..                                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ ! -d ${OS_NAME} ]; then                                                                                                                                                                             # Colorize: green
    git clone https://github.com/torvalds/linux.git                                                                                                                                                      # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ${OS_NAME}/                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ ! -f ngos_tracer ]; then                                                                                                                                                                            # Colorize: green
    git reset --hard                                                                                                                                                                                     # Colorize: green
    git clean -df                                                                                                                                                                                        # Colorize: green
    git checkout master                                                                                                                                                                                  # Colorize: green
    git branch -D ngos_tracer                                                                                                                                                                            # Colorize: green
    git pull                                                                                                                                                                                             # Colorize: green
    git checkout v4.20 -b ngos_tracer                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    cp -r ${CURRENT_PATH}/assets/${OS_NAME}/. ./                                                                                                                                                          # Colorize: green
    git apply ngos_tracer.patch                                                                                                                                                                          # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    make -j`nproc` && touch ngos_tracer || exit 1                                                                                                                                                        # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
cd ${CURRENT_PATH}/                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------ Starting QEMU -----------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
BREAKPOINT=`cat ${LAST_BREAKPOINT_FILE} 2> /dev/null`                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ `echo "${BREAKPOINT}" | grep 0xffffffff8` != "" ]; then                                                                                                                                             # Colorize: green
    cd ../../tools/vm                                                                                                                                                                                    # Colorize: green
    ./start_vm.sh qemu-kvm none ${OS_NAME} > ${TEMP_LOG} 2>&1 &                                                                                                                                          # Colorize: green
    cd ${CURRENT_PATH}/                                                                                                                                                                                   # Colorize: green
else                                                                                                                                                                                                     # Colorize: green
    cd ../../tools/vm                                                                                                                                                                                    # Colorize: green
    ./start_vm.sh qemu none ${OS_NAME} > ${TEMP_LOG} 2>&1 &                                                                                                                                              # Colorize: green
    cd ${CURRENT_PATH}/                                                                                                                                                                                   # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m------------------ Starting GDB ------------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
GDB_LOGGER_PID=`ps -ef | grep "tail -f ${GDB_FIFO}" | grep -v grep | awk '{print $2}'`                                                                                                                   # Colorize: green
kill -9 ${GDB_LOGGER_PID} > /dev/null 2>&1                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
rm ${GDB_FIFO} 2> /dev/null                                                                                                                                                                              # Colorize: green
mkfifo ${GDB_FIFO}                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
tail -f ${GDB_FIFO} | gdb >> ${GDB_LOG} 2>&1 &                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
echo -e "\e[33m-------------- Waiting for GDB debug -------------\e[0m"                                                                                                                                  # Colorize: green
echo ""                                                                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
EFI_PE_ENTRY_OFFSET=`readelf -s ${BZ_IMAGE_ELF} | grep efi_pe_entry | sed -e "s/^[[:space:]]*//" -e "s/[[:space:]]*$//" | awk '{ print $2 }'`                                                            # Colorize: green
RELOCATED_OFFSET=`readelf    -s ${BZ_IMAGE_ELF} | grep relocated    | sed -e "s/^[[:space:]]*//" -e "s/[[:space:]]*$//" | awk '{ print $2 }'`                                                            # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
sleep 5                                                                                                                                                                                                  # Colorize: green
execute_gdb_command "set width 200" -v                                                                                                                                                                   # Colorize: green
execute_gdb_command "set listsize 1" -v                                                                                                                                                                  # Colorize: green
execute_gdb_command "set architecture i386:x86-64:intel" -v                                                                                                                                              # Colorize: green
execute_gdb_command "target remote :1234" -v                                                                                                                                                             # Colorize: green
execute_gdb_command "add-symbol-file-all ${BZ_IMAGE_ELF} ${INITIAL_ADDRESS}-0x${EFI_PE_ENTRY_OFFSET}" -v                                                                                                 # Colorize: green
execute_gdb_command "add-symbol-file-all ${BZ_IMAGE_ELF} ${PREFERRED_ADDRESS}" -v                                                                                                                        # Colorize: green
execute_gdb_command "add-symbol-file-all ${BZ_IMAGE_ELF} ${RELOCATED_ADDRESS}-0x${RELOCATED_OFFSET}" -v                                                                                                  # Colorize: green
execute_gdb_command "add-symbol-file-all ${VM_LINUX_ELF} -0xFFFFFFFF81000000+${RANDOM_PHYSICAL_ADDRESS}" -v                                                                                              # Colorize: green
execute_gdb_command "add-symbol-file-all ${VM_LINUX_ELF} -0xFFFFFFFF81000000+${RANDOM_VIRTUAL_ADDRESS}" -v                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
if [ "${BREAKPOINT}" != "" ]; then                                                                                                                                                                       # Colorize: green
    if [ `echo "${BREAKPOINT}" | grep 0xffffffff8` != "" ]; then                                                                                                                                         # Colorize: green
        execute_gdb_command "tbreak *0x3FF93288" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x39E6A4F0" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x39E6A57E" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x01400200" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x014002E7" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x035224C0" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *0x03522501" -v                                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *${RANDOM_PHYSICAL_ADDRESS}" -v                                                                                                                                      # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
        execute_gdb_command "tbreak *${RANDOM_PHYSICAL_ADDRESS}+0x5B" -v                                                                                                                                 # Colorize: green
        execute_gdb_command "continue" -v                                                                                                                                                                # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    execute_gdb_command "tbreak *${BREAKPOINT}" -v                                                                                                                                                       # Colorize: green
    execute_gdb_command "continue" -v                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo ""                       >> ${OUTPUT_FILE}                                                                                                                                                      # Colorize: green
    echo "Terminated. Continuing" >> ${OUTPUT_FILE}                                                                                                                                                      # Colorize: green
    echo ""                       >> ${OUTPUT_FILE}                                                                                                                                                      # Colorize: green
else                                                                                                                                                                                                     # Colorize: green
    rm ${LAST_BREAKPOINT_FILE}     > /dev/null 2>&1                                                                                                                                                      # Colorize: green
    rm ${LAST_REGISTERS_FILE}      > /dev/null 2>&1                                                                                                                                                      # Colorize: green
    rm ${LAST_REGISTERS_FILE}.tmp  > /dev/null 2>&1                                                                                                                                                      # Colorize: green
    rm ${OUTPUT_FILE}              > /dev/null 2>&1                                                                                                                                                      # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    execute_gdb_command "tbreak *${INITIAL_BREAKPOINT}" -v                                                                                                                                               # Colorize: green
    execute_gdb_command "continue" -v                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    execute_gdb_command "info all-registers" | grep -v "rip" > ${LAST_REGISTERS_FILE}                                                                                                                    # Colorize: green
fi                                                                                                                                                                                                       # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
while true                                                                                                                                                                                               # Colorize: green
do                                                                                                                                                                                                       # Colorize: green
    INSTRUCTION=`execute_gdb_command "x/i \\\$pc"`                                                                                                                                                       # Colorize: green
    echo -ne "\r\033[K${INSTRUCTION}"                                                                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    INSTRUCTION_ADDRESS_NICE=`echo "${INSTRUCTION}" | cut -d : -f 1 | cut -c 4-`                                                                                                                         # Colorize: green
    INSTRUCTION_ADDRESS=`echo "${INSTRUCTION_ADDRESS_NICE}" | cut -d \< -f 1`                                                                                                                            # Colorize: green
    INSTRUCTION=`echo "${INSTRUCTION}" | cut -d : -f 2`                                                                                                                                                  # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    echo "${INSTRUCTION_ADDRESS}" > ${LAST_BREAKPOINT_FILE}                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MEMORY_LOCATIONS=(`echo "${INSTRUCTION}" | grep -o -E -e "\*?(-?0x[0-9a-f]+)?\((%.{2,3})\)" -e "# +(0x[0-9a-f]+)" -e "\*(%.{2,3})" -e "\*(0x[0-9a-f]+)" | sed -r "s/^# +//g" | sed -r "s/^\*(.*)/\*\1 \1/g"`) # Colorize: green
    MEMORY_VALUES_BEFORE=()                                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for LOCATION in "${MEMORY_LOCATIONS[@]}"                                                                                                                                                             # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        MEMORY_DUMP_ARG=`echo "${LOCATION}" | sed -r "s/(-?0x[0-9a-f]+)?\((%.{2,3})\)/\1 + \2/g" | sed -r "s/^ \+ //g" | sed -r "s/^\* \+ /\*/g" | sed -r "s/%/\$/g" | sed -r "s/^\*(.*)/\*\(\1\)/g"`    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        MEMORY_VALUE=`execute_gdb_command "x/1xg ${MEMORY_DUMP_ARG}"`                                                                                                                                    # Colorize: green
        MEMORY_VALUES_BEFORE+=("${MEMORY_VALUE}")                                                                                                                                                        # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    SOURCE_LINE=                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    mapfile -t SOURCE_LINES < <( execute_gdb_command "list *${INSTRUCTION_ADDRESS}" )                                                                                                                    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ ${#SOURCE_LINES[@]} -eq 2 ]; then                                                                                                                                                               # Colorize: green
        CODE_LINE=`echo "${SOURCE_LINES[1]}" | sed -r "s/\t/    /g"`                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        SOURCE_LINE=`printf "%-100s %s" "${CODE_LINE}" "${SOURCE_LINES[0]}"`                                                                                                                             # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    IGNORED="Ignored."                                                                                                                                                                                   # Colorize: green
    FILTERING_DATA="${INSTRUCTION_ADDRESS_NICE} ${INSTRUCTION} ${MEMORY_VALUES_BEFORE[@]} ${SOURCE_LINE}"                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "`echo "${FILTERING_DATA}" | grep "${NEXTI_FILTERS[@]}"`" != "" ]; then                                                                                                                         # Colorize: green
        execute_gdb_command "nexti" > /dev/null 2>&1                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "`echo "${INSTRUCTION}" | grep jmpq`" != "" ]; then                                                                                                                                         # Colorize: green
            execute_gdb_command "finish" > /dev/null 2>&1                                                                                                                                                # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    elif [ "`echo "${FILTERING_DATA}" | grep "${NEXT_FILTERS[@]}"`" != "" ]; then                                                                                                                        # Colorize: green
        NEXT_INSTRUCTION=`execute_gdb_command "x/2i \\\$pc" | tail -n 1`                                                                                                                                 # Colorize: green
        NEXT_INSTRUCTION_ADDRESS_NICE=`echo "${NEXT_INSTRUCTION}" | cut -d : -f 1 | cut -c 4-`                                                                                                           # Colorize: green
        NEXT_INSTRUCTION_ADDRESS=`echo "${NEXT_INSTRUCTION_ADDRESS_NICE}" | cut -d \< -f 1`                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        execute_gdb_command "tbreak *${NEXT_INSTRUCTION_ADDRESS}" > /dev/null 2>&1                                                                                                                       # Colorize: green
        execute_gdb_command "continue" > /dev/null 2>&1                                                                                                                                                  # Colorize: green
    elif [ "`echo "${FILTERING_DATA}" | grep "${FINISH_FILTERS[@]}"`" != "" ]; then                                                                                                                      # Colorize: green
        execute_gdb_command "finish" > /dev/null 2>&1                                                                                                                                                    # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        IGNORED=                                                                                                                                                                                         # Colorize: green
        execute_gdb_command "stepi" > /dev/null 2>&1                                                                                                                                                     # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MEMORY_VALUES_AFTER=()                                                                                                                                                                               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for LOCATION in "${MEMORY_LOCATIONS[@]}"                                                                                                                                                             # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        MEMORY_DUMP_ARG=`echo "${LOCATION}" | sed -r "s/(-?0x[0-9a-f]+)?\((%.{2,3})\)/\1 + \2/g" | sed -r "s/^ \+ //g" | sed -r "s/^\* \+ /\*/g" | sed -r "s/%/\$/g" | sed -r "s/^\*(.*)/\*\(\1\)/g"`    # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        MEMORY_VALUE=`execute_gdb_command "x/1xg ${MEMORY_DUMP_ARG}"`                                                                                                                                    # Colorize: green
        MEMORY_VALUES_AFTER+=("${MEMORY_VALUE}")                                                                                                                                                         # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    MEMORY_CHANGES=                                                                                                                                                                                      # Colorize: green
    MEMORY_COUNT=${#MEMORY_LOCATIONS[@]}                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    for ((i = 0; i < ${MEMORY_COUNT}; i++))                                                                                                                                                              # Colorize: green
    do                                                                                                                                                                                                   # Colorize: green
        LOCATION=${MEMORY_LOCATIONS[$i]}                                                                                                                                                                 # Colorize: green
        VALUE_BEFORE=${MEMORY_VALUES_BEFORE[$i]}                                                                                                                                                         # Colorize: green
        VALUE_AFTER=${MEMORY_VALUES_AFTER[$i]}                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        LOCATION_BEFORE=`echo "${VALUE_BEFORE}" | cut -d : -f 1`                                                                                                                                         # Colorize: green
        LOCATION_AFTER=`echo "${VALUE_AFTER}" | cut -d : -f 1`                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
        if [ "${LOCATION_BEFORE}" == "${LOCATION_AFTER}" ]; then                                                                                                                                         # Colorize: green
            if [ "${MEMORY_CHANGES}" != "" ]; then                                                                                                                                                       # Colorize: green
                MEMORY_CHANGES+=", "                                                                                                                                                                     # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            VALUE_BEFORE=`echo "${VALUE_BEFORE}" | cut -d : -f 2 | cut -c 2-`                                                                                                                            # Colorize: green
            VALUE_AFTER=`echo "${VALUE_AFTER}" | cut -d : -f 2 | cut -c 2-`                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${LOCATION}" != "${LOCATION_BEFORE}" ]; then                                                                                                                                           # Colorize: green
                MEMORY_CHANGES+="${LOCATION} == "                                                                                                                                                        # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            MEMORY_CHANGES+="${LOCATION_BEFORE}: ${VALUE_BEFORE}"                                                                                                                                        # Colorize: green
                                                                                                                                                                                                         # Colorize: green
            if [ "${VALUE_BEFORE}" != "${VALUE_AFTER}" ]; then                                                                                                                                           # Colorize: green
                MEMORY_CHANGES+=" => ${VALUE_AFTER}"                                                                                                                                                     # Colorize: green
            fi                                                                                                                                                                                           # Colorize: green
        fi                                                                                                                                                                                               # Colorize: green
    done                                                                                                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    execute_gdb_command "info all-registers" | grep -v "rip" > ${LAST_REGISTERS_FILE}.tmp                                                                                                                # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    REGISTERS_DIFF=`diff --changed-group-format="%<%>" --unchanged-group-format="" --old-line-format="%l => " --new-line-format="%l ; " ${LAST_REGISTERS_FILE} ${LAST_REGISTERS_FILE}.tmp`               # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    if [ "${IGNORED}" != "" ]; then                                                                                                                                                                      # Colorize: green
        DETAILS="${IGNORED} ${MEMORY_CHANGES}"                                                                                                                                                           # Colorize: green
    else                                                                                                                                                                                                 # Colorize: green
        DETAILS="${MEMORY_CHANGES}"                                                                                                                                                                      # Colorize: green
    fi                                                                                                                                                                                                   # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    INSTRUCTION_ADDRESS_NICE=`echo "${INSTRUCTION_ADDRESS_NICE}" | sed -r "s/\t/    /g"`                                                                                                                 # Colorize: green
    INSTRUCTION=`echo              "${INSTRUCTION}"              | sed -r "s/\t/    /g"`                                                                                                                 # Colorize: green
    DETAILS=`echo                  "${DETAILS}"                  | sed -r "s/\t/    /g"`                                                                                                                 # Colorize: green
    REGISTERS_DIFF=`echo           "${REGISTERS_DIFF}"           | sed -r "s/\t/    /g"`                                                                                                                 # Colorize: green
    SOURCE_LINE=`echo              "${SOURCE_LINE}"              | sed -r "s/\t/    /g"`                                                                                                                 # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    RESULT_LINE=`printf "%-60s:%-80s // %-100s // %-340s // %s\n" "${INSTRUCTION_ADDRESS_NICE}" "${INSTRUCTION}" "${DETAILS}" "${REGISTERS_DIFF}" "${SOURCE_LINE}"`                                      # Colorize: green
    echo "${RESULT_LINE}" >> ${OUTPUT_FILE}                                                                                                                                                              # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
    mv ${LAST_REGISTERS_FILE}.tmp ${LAST_REGISTERS_FILE}                                                                                                                                                 # Colorize: green
done                                                                                                                                                                                                     # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
                                                                                                                                                                                                         # Colorize: green
exit 0                                                                                                                                                                                                   # Colorize: green
