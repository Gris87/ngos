#include "elfobject.h"                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/shared/common/elf/programheadertableentry.h>                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
ElfObject::ElfObject()                                                                                                                                                                                   // Colorize: green
    : mBytes()                                                                                                                                                                                           // Colorize: green
    , mProgramBytes()                                                                                                                                                                                    // Colorize: green
    , mNameToSectionMap()                                                                                                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ElfObject::read(const QString &path)                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Read file to mBytes                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile file(path);                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!file.open(QIODevice::ReadOnly))                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mBytes = file.readAll();                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        file.close();                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that file is big enough                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mBytes.size() < (qint64)sizeof(ElfHeader))                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "File is too small";                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    ElfHeader *header = (ElfHeader *)mBytes.data();                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Verify that ELF header is valid                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!verifyHeader(header))                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF header is invalid";                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get program bytes from program header table entries                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < header->programHeaderTableEntryCount; ++i)                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            ElfProgramHeaderTableEntry *entry = (ElfProgramHeaderTableEntry *)(mBytes.data() + header->programHeaderTableOffset + i * header->programHeaderTableEntrySize);                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mProgramBytes.append(mBytes.data() + entry->offset, entry->fileSize);                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QList<ElfSectionHeaderTableEntry *> sectionHeaderTableEntries;                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Fill section header table entries                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < header->sectionHeaderTableEntryCount; ++i)                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            sectionHeaderTableEntries.append((ElfSectionHeaderTableEntry *)(mBytes.data() + header->sectionHeaderTableOffset + i * header->sectionHeaderTableEntrySize));                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    ElfSectionHeaderTableEntry *sectionWithNames = sectionHeaderTableEntries.at(header->sectionHeaderTableNamesIndex);                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Map sections with their names                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < sectionHeaderTableEntries.size(); ++i)                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            ElfSectionHeaderTableEntry *entry = sectionHeaderTableEntries.at(i);                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mNameToSectionMap.insert(QString::fromLatin1(mBytes.data() + sectionWithNames->offset + entry->nameOffset), entry);                                                                          // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
qint64 ElfObject::getFileSize() const                                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return mBytes.size();                                                                                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
const QByteArray& ElfObject::getProgramBytes() const                                                                                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return mProgramBytes;                                                                                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
ElfSectionHeaderTableEntry* ElfObject::getSection(QString name)                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return mNameToSectionMap.value(name, nullptr);                                                                                                                                                       // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ElfObject::verifyHeader(ElfHeader *header)                                                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(header != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF signature                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.signature != ELF_SIGNATURE)                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF signature is invalid";                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF file class                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.fileClass != ElfClass::CLASS_64)                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF file class is invalid";                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF file data                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.fileData != ElfData::LEAST_SIGNIFICANT_BYTE)                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF file data is invalid";                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF file version                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.version != ElfFileVersion::CURRENT)                                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF file version is invalid";                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF OS ABI                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.osAbi != ElfOsAbi::SYSTEM_V)                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF OS ABI is invalid";                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF ABI version                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->identification.abiVersion != 0)                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF OS ABI is invalid";                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF type                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            header->type != ElfType::EXECUTABLE                                                                                                                                                         // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            header->type != ElfType::DYNAMIC_LIBRARY                                                                                                                                                    // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF type is invalid";                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF machine                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->machine != ElfMachine::MACHINE_X86_64)                                                                                                                                              // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF machine is invalid";                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF version                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->version != ElfVersion::CURRENT)                                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF version is invalid";                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF entry point                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            header->entryPoint >= (quint64)mBytes.size()                                                                                                                                                // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            header->entryPoint != 0xFFFFFFFF80000000                                                                                                                                                    // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF entry point is invalid";                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF program header table offset                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->programHeaderTableOffset >= (quint64)mBytes.size())                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF program header table offset is invalid";                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF section header table offset                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->sectionHeaderTableOffset >= (quint64)mBytes.size())                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF section header table offset is invalid";                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF flags                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->flags != FLAGS(ElfHeaderFlag::NONE))                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF flags is invalid";                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF header size                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->headerSize != sizeof(ElfHeader))                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF header size is invalid";                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF program header table entry size                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->programHeaderTableEntrySize != sizeof(ElfProgramHeaderTableEntry))                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF program header table entry size is invalid";                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF number of program header table entries                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->programHeaderTableEntryCount != 1)                                                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF number of program header table entries is invalid";                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF section header table entry size                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->sectionHeaderTableEntrySize != sizeof(ElfSectionHeaderTableEntry))                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF section header table entry size is invalid";                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF number of section header table entries                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->sectionHeaderTableEntryCount <= 0)                                                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF number of section header table entries is invalid";                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check ELF index of entry with section names                                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (header->sectionHeaderTableNamesIndex >= header->sectionHeaderTableEntryCount)                                                                                                              // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "ELF index of entry with section names is invalid";                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
