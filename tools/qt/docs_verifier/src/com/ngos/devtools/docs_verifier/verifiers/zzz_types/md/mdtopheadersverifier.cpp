#include "mdtopheadersverifier.h"                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDir>                                                                                                                                                                                          // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QFileInfo>                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/docs_verifier/other/docsverificationfiletype.h>                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
MdTopHeadersVerifier::MdTopHeadersVerifier()                                                                                                                                                             // Colorize: green
    : BaseDocsVerifier(DocsVerificationFileType::MD)                                                                                                                                                     // Colorize: green
    , mSectionIdRegExp("^(\\d+\\.).*$") // 1.                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MdTopHeadersVerifier::verify(DocsWorkerThread *worker, const QString &path, const QString & /*content*/, const QStringList &lines)                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString relativePath = getRelativePath(worker, path);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (relativePath.startsWith("docs/"))                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        relativePath = relativePath.mid(5);                                                                                                                                                              // Colorize: green
        checkForNgosHeader(worker, path, lines);                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (relativePath != "")                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString subsectionName = getSubsectionName(worker, path, relativePath.split('/'));                                                                                                           // Colorize: green
            checkForSubsectionHeader(worker, path, lines, subsectionName);                                                                                                                               // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QString sectionName = !lines.isEmpty() ? lines.constFirst() : "";                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (sectionName != "")                                                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            checkForSectionHeader(worker, path, lines, sectionName);                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            worker->addError(path, 0, "First line should be a header");                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QString MdTopHeadersVerifier::getRelativePath(DocsWorkerThread *worker, QString path) const                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString projectFolder;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get project root folder                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        projectFolder = path.left(path.lastIndexOf('/'));                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        do                                                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (QFile::exists(projectFolder + "/ngos.files"))                                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                break;                                                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            qint64 index = projectFolder.lastIndexOf('/');                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (index < 0)                                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                worker->addError(path, -1, "Failed to get relative path");                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return "";                                                                                                                                                                               // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            projectFolder = projectFolder.left(index);                                                                                                                                                   // Colorize: green
        } while(true);                                                                                                                                                                                   // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (path.endsWith("/README.md"))                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        path.remove(path.length() - 10, 10);                                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, -1, "File name should be README.md");                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return path.mid(projectFolder.length() + 1);                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QString MdTopHeadersVerifier::getSubsectionName(DocsWorkerThread *worker, QString path, const QStringList &pathParts) const                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString subsectionName;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    for (qint64 i = 0; i < pathParts.size() - 1; ++i)                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QString                 pathPart = pathParts.at(i);                                                                                                                                              // Colorize: green
        QRegularExpressionMatch match    = mSectionIdRegExp.match(pathPart);                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (match.hasMatch())                                                                                                                                                                            // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            subsectionName.append(match.captured(1));                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            worker->addError(path, -1, QString("Subsection name %1 should start with digit")                                                                                                             // Colorize: green
                                                .arg(pathPart)                                                                                                                                           // Colorize: green
            );                                                                                                                                                                          // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString                 lastPathPart = pathParts.constLast();                                                                                                                           // Colorize: green
    QRegularExpressionMatch match        = mSectionIdRegExp.match(lastPathPart);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (match.hasMatch())                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        subsectionName.append(lastPathPart);                                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, -1, QString("Subsection name %1 should start with digit")                                                                                                                 // Colorize: green
                                            .arg(lastPathPart)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return subsectionName;                                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MdTopHeadersVerifier::checkForNgosHeader(DocsWorkerThread *worker, const QString &path, const QStringList &lines) const                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 0                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(0) != "NGOS"                                                                                                                                                                            // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, 0, "Invalid line. Expected: NGOS");                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 1                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(1) != "===="                                                                                                                                                                            // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, 1, "Invalid line. Expected: ====");                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 2                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(2) != ""                                                                                                                                                                                // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addWarning(path, 2, "Expected blank line after section");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MdTopHeadersVerifier::checkForSectionHeader(DocsWorkerThread *worker, const QString &path, const QStringList &lines, const QString &sectionName) const                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString sectionHeader(sectionName.length(), '=');                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 1                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(1) != sectionHeader                                                                                                                                                                     // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, 1, QString("Invalid line. Expected: %1")                                                                                                                                  // Colorize: green
                                            .arg(sectionHeader)                                                                                                                                          // Colorize: green
        );                                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 2                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(2) != ""                                                                                                                                                                                // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addWarning(path, 2, "Expected blank line after section");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MdTopHeadersVerifier::checkForSubsectionHeader(DocsWorkerThread *worker, const QString &path, const QStringList &lines, const QString &subsectionName) const                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 3                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(3) != subsectionName                                                                                                                                                                    // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, 3, QString("Invalid line. Expected: %1")                                                                                                                                  // Colorize: green
                                            .arg(subsectionName)                                                                                                                                         // Colorize: green
        );                                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString subsectionHeader(subsectionName.length(), '-');                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 4                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(4) != subsectionHeader                                                                                                                                                                  // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, 4, QString("Invalid line. Expected: %1")                                                                                                                                  // Colorize: green
                                            .arg(subsectionHeader)                                                                                                                                       // Colorize: green
        );                                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (                                                                                                                                                                                                 // Colorize: green
        lines.size() <= 5                                                                                                                                                                                // Colorize: green
        ||                                                                                                                                                                                               // Colorize: green
        lines.at(5) != ""                                                                                                                                                                                // Colorize: green
       )                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addWarning(path, 5, "Expected blank line after section");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
MdTopHeadersVerifier mdTopHeadersVerifierInstance;                                                                                                                                                       // Colorize: green
