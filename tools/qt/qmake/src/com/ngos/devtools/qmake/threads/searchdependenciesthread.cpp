#include "searchdependenciesthread.h"                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QFileInfo>                                                                                                                                                                                     // Colorize: green
#include <QIODevice>                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QStringList                   SearchDependenciesThread::sIncludes;                                                                                                                                       // Colorize: green
QSet<QString>                 SearchDependenciesThread::sSources;                                                                                                                                        // Colorize: green
qint64                        SearchDependenciesThread::sNumberOfThreads;                                                                                                                                // Colorize: green
qint64                        SearchDependenciesThread::sNumberOfBlockedThreads;                                                                                                                         // Colorize: green
QHash<QString, QSet<QString>> SearchDependenciesThread::sDependencies;                                                                                                                                   // Colorize: green
QMutex                        SearchDependenciesThread::sSourcesMutex;                                                                                                                                   // Colorize: green
QSemaphore                    SearchDependenciesThread::sSourcesSemaphore;                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
SearchDependenciesThread::SearchDependenciesThread(const QString &workingDirectory)                                                                                                                      // Colorize: green
    : mWorkingDirectory(workingDirectory)                                                                                                                                                                // Colorize: green
    , mErrors()                                                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void SearchDependenciesThread::init(const QStringList &includes, const QStringList &sources, qint64 numberOfThreads)                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    sIncludes               = includes;                                                                                                                                                                  // Colorize: green
    sSources                = QSet<QString>(sources.begin(), sources.end());                                                                                                                             // Colorize: green
    sNumberOfThreads        = numberOfThreads;                                                                                                                                                           // Colorize: green
    sNumberOfBlockedThreads = 0;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    sSourcesSemaphore.release(sSources.size());                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QString SearchDependenciesThread::takeSource()                                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    bool skipSemaphore = false;                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Increase amount of blocked threads and skip semaphore if there are no more threads and sources                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QMutexLocker lock(&sSourcesMutex);                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        ++sNumberOfBlockedThreads;                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            sNumberOfBlockedThreads >= sNumberOfThreads                                                                                                                                                  // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            sSources.isEmpty()                                                                                                                                                                           // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            skipSemaphore = true;                                                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!skipSemaphore)                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        sSourcesSemaphore.acquire();                                                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Return path to source and decrease amount of blocked threads                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QMutexLocker lock(&sSourcesMutex);                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!sSources.isEmpty())                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            --sNumberOfBlockedThreads;                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString res = *sSources.constBegin();                                                                                                                                                        // Colorize: green
            sSources.erase(sSources.constBegin());                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return res;                                                                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        sSourcesSemaphore.release();                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return "";                                                                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void SearchDependenciesThread::addDependencies(const QString &source, const QSet<QString> &dependencies)                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QMutexLocker lock(&sSourcesMutex);                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    sDependencies.insert(source, dependencies);                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QSetIterator<QString> it(dependencies);                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    while (it.hasNext())                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        const QString &dependency = it.next();                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            !sSources.contains(dependency)                                                                                                                                                               // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            !sDependencies.contains(dependency)                                                                                                                                                          // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            sSources.insert(dependency);                                                                                                                                                                 // Colorize: green
            sSourcesSemaphore.release();                                                                                                                                                                 // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QHash<QString, QSet<QString>> SearchDependenciesThread::buildDependenciesMap()                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QHash<QString, QSet<QString>> res;  // Source => Set of dependencies                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QHashIterator<QString, QSet<QString>> it(sDependencies);                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    while (it.hasNext())                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        it.next();                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        buildDependenciesForSource(it.key(), res);                                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return res;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QSet<QString> SearchDependenciesThread::buildDependenciesForSource(const QString &source, QHash<QString, QSet<QString>> &dependenciesMap)                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (dependenciesMap.contains(source))                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        return dependenciesMap.value(source);                                                                                                                                                            // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QSet<QString> res = sDependencies.value(source);                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    dependenciesMap.insert(source, res); // Insert here to avoid infinite loops                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QSet<QString> newDependencies;                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QSetIterator<QString> it(res);                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    while (it.hasNext())                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        newDependencies.unite(buildDependenciesForSource(it.next(), dependenciesMap));                                                                                                                   // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    res.unite(newDependencies);                                                                                                                                                                          // Colorize: green
    dependenciesMap.insert(source, res);                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return res;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void SearchDependenciesThread::addError(const QString &error)                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mErrors.append(error);                                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
const QStringList& SearchDependenciesThread::getErrors() const                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return mErrors;                                                                                                                                                                                      // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool SearchDependenciesThread::handleSource(const QString &source)                                                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString fileName = source.startsWith('/') ? source : (mWorkingDirectory + '/' + source);                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString content;                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read file content                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile file(fileName);                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!file.open(QIODevice::ReadOnly))                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addError(QString("Failed to read file \"%1\"").arg(fileName));                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        content = QString::fromUtf8(file.readAll());                                                                                                                                                     // Colorize: green
        file.close();                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QSet<QString> dependencies;                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Iterate over lines and find set of dependencies                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QStringList lines = content.split('\n');                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 0; i < lines.size(); ++i)                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString line = lines.at(i).trimmed();                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (line.startsWith("#include "))                                                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                line = line.mid(9).trimmed();                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (                                                                                                                                                                                     // Colorize: green
                    line.length() >= 2                                                                                                                                                                    // Colorize: green
                    &&                                                                                                                                                                                   // Colorize: green
                    (                                                                                                                                                                                    // Colorize: green
                     (                                                                                                                                                                                   // Colorize: green
                      line.startsWith('\"')                                                                                                                                                              // Colorize: green
                      &&                                                                                                                                                                                 // Colorize: green
                      line.endsWith('\"')                                                                                                                                                                // Colorize: green
                     )                                                                                                                                                                                   // Colorize: green
                     ||                                                                                                                                                                                  // Colorize: green
                     (                                                                                                                                                                                   // Colorize: green
                      line.startsWith('<')                                                                                                                                                               // Colorize: green
                      &&                                                                                                                                                                                 // Colorize: green
                      line.endsWith('>')                                                                                                                                                                 // Colorize: green
                     )                                                                                                                                                                                   // Colorize: green
                    )                                                                                                                                                                                    // Colorize: green
                   )                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QString includedFile = line.mid(1, line.length() - 2);                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    // Try find absolute file path for the included file                                                                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        QString parentFolder = fileName.left(fileName.lastIndexOf('/') + 1);                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        if (QFile::exists(parentFolder + includedFile))                                                                                                                                  // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            dependencies.insert(QFileInfo(parentFolder + includedFile).absoluteFilePath());                                                                                              // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                        else                                                                                                                                                                             // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            if (QFile::exists(mWorkingDirectory + '/' + includedFile))                                                                                                                   // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                dependencies.insert(QFileInfo(mWorkingDirectory + '/' + includedFile).absoluteFilePath());                                                                               // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                            else                                                                                                                                                                         // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                bool found = false;                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                for (qint64 j = 0; j < sIncludes.size(); ++j)                                                                                                                            // Colorize: green
                                {                                                                                                                                                                        // Colorize: green
                                    QString path = mWorkingDirectory + '/' + sIncludes.at(j) + '/' + includedFile;                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                    if (QFile::exists(path))                                                                                                                                             // Colorize: green
                                    {                                                                                                                                                                    // Colorize: green
                                        found = true;                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                        dependencies.insert(QFileInfo(path).absoluteFilePath());                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                        break;                                                                                                                                                           // Colorize: green
                                    }                                                                                                                                                                    // Colorize: green
                                }                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                if (                                                                                                                                                                     // Colorize: green
                                    !found                                                                                                                                                               // Colorize: green
                                    &&                                                                                                                                                                   // Colorize: green
                                    includedFile != "com/ngos/kernel/other/brk/brk.h"   // TODO: Why?                                                                                                    // Colorize: green
                                    &&                                                                                                                                                                   // Colorize: green
                                    includedFile != "com/ngos/kernel/other/ioremap/ioremap.h"                                                                                                            // Colorize: green
                                    &&                                                                                                                                                                   // Colorize: green
                                    includedFile != "com/ngos/kernel/other/uefi/uefi.h"                                                                                                                  // Colorize: green
                                   )                                                                                                                                                                     // Colorize: green
                                {                                                                                                                                                                        // Colorize: green
                                    addError(QString("Failed to find included file \"%1\"").arg(includedFile));                                                                                          // Colorize: green
                                }                                                                                                                                                                        // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    addDependencies(source, dependencies);                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void SearchDependenciesThread::run()                                                                                                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    do                                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QString source = takeSource();                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (source == "")                                                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!handleSource(source))                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addDependencies(source, QSet<QString>());                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    } while(true);                                                                                                                                                                                       // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
