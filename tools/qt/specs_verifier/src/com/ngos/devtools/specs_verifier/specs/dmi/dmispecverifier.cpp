#include "dmispecverifier.h"                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QEventLoop>                                                                                                                                                                                    // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QNetworkAccessManager>                                                                                                                                                                         // Colorize: green
#include <QNetworkReply>                                                                                                                                                                                 // Colorize: green
#include <QNetworkRequest>                                                                                                                                                                               // Colorize: green
#include <QProcess>                                                                                                                                                                                      // Colorize: green
#include <QTemporaryDir>                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define DMI_SPECIFICATION_URL "https://www.dmtf.org/sites/default/files/standards/documents/DSP0134_3.4.0.pdf" // Version: 3.4.0 / 2020-07-17                                                            // Colorize: green
#define DMI_PDF               "dmi.pdf"                                                                                                                                                                  // Colorize: green
#define DMI_TXT               "dmi.txt"                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define DMI_ENTRY_HEADER_H "src/os/shared/common/src/com/ngos/shared/common/dmi/lib/dmientryheader.h"                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
DmiSpecVerifier::DmiSpecVerifier()                                                                                                                                                                       // Colorize: green
    : SpecVerifier()                                                                                                                                                                                     // Colorize: green
    , mDmiTypeToNgosTypeMap()                                                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mDmiTypeToNgosTypeMap.insert("BYTE",  "good_U8");                                                                                                                                                // Colorize: green
    mDmiTypeToNgosTypeMap.insert("WORD",  "good_U16");                                                                                                                                                // Colorize: green
    mDmiTypeToNgosTypeMap.insert("DWORD", "good_U32");                                                                                                                                                // Colorize: green
    mDmiTypeToNgosTypeMap.insert("QWORD", "good_U64");                                                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void DmiSpecVerifier::verify(SpecVerifyThread *thread)                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString specContent;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!downloadSpecification(thread, DMI_SPECIFICATION_URL, specContent))                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        return;                                                                                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    checkWithSpecification(thread, specContent);                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool DmiSpecVerifier::downloadSpecification(SpecVerifyThread *thread, const QString &url, QString &specContent)                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(url    != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QTemporaryDir tempDir;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Create temporary directory                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!tempDir.isValid())                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to create temporary directory for DMI specification");                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    tempDir.setAutoRemove(false);                                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Download specification                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QNetworkAccessManager  manager;                                                                                                                                                                  // Colorize: green
        QNetworkReply         *reply;                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Send network request                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QNetworkRequest request;                                                                                                                                                                     // Colorize: green
            request.setUrl(QUrl(url));                                                                                                                                                 // Colorize: green
            reply = manager.get(request);                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Wait for finish                                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QEventLoop waitLoop;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QObject::connect(reply, SIGNAL(finished()),                                 &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
            QObject::connect(reply, SIGNAL(errorOccurred(QNetworkReply::NetworkError)), &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            waitLoop.exec();                                                                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Check status code                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QVariant statusCode = reply->attribute(QNetworkRequest::HttpStatusCodeAttribute);                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (statusCode.toInt() != 200)                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to get DMI specification from: %1")                                                                                                                     // Colorize: green
                                            .arg(url)                                                                                                                                  // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                delete reply;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return false;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QByteArray content = reply->readAll();                                                                                                                                                           // Colorize: green
        delete reply;                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Write documentation to file                                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QFile file(tempDir.path() + "/" + DMI_PDF);                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (!file.open(QIODevice::WriteOnly))                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError("Failed to create temporary file for DMI specification");                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return false;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            file.write(content);                                                                                                                                                                         // Colorize: green
            file.close();                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Convert PDF to text                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QProcess process;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        process.setWorkingDirectory(tempDir.path());                                                                                                                                                     // Colorize: green
        process.start("pdftotext", QStringList() << DMI_PDF << DMI_TXT);                                                                                                                                 // Colorize: green
        process.waitForFinished(-1);                                                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read specification text                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile file(tempDir.path() + "/" + DMI_TXT);                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!file.open(QIODevice::ReadOnly))                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to open DMI specification");                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        specContent += QString::fromUtf8(file.readAll());                                                                                                                                                 // Colorize: green
        file.close();                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void DmiSpecVerifier::checkWithSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    qint64 errorsBefore = thread->getErrors().size();                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check code with specification                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        checkDmiSpecification(thread, specContent);                                                                                                                                                      // Colorize: green
        checkDmiEntryHeader(thread, specContent);                                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (thread->getErrors().size() == errorsBefore)                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Code verified with DMI specification");                                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Found error in code with DMI specification");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void DmiSpecVerifier::checkDmiSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString versionText;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init versionText                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        versionText =                                                                                                                                                                                    // Colorize: green
            "1\n"                                                                                                                                                                                        // Colorize: green
            "2\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Document Identifier: DSP0134\n"                                                                                                                                                             // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "3\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Date: 2020-07-17\n"                                                                                                                                                                         // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "4\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Version: 3.4.0\n"                                                                                                                                                                           // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "6\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "System Management BIOS (SMBIOS) Reference\n"                                                                                                                                                // Colorize: green
            "Specification\n"                                                                                                                                                                            // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "7\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Supersedes: 3.3.0\n"                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "8\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Document Class: Normative\n"                                                                                                                                                                // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "9\n"                                                                                                                                                                                        // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Document Status: Published\n"                                                                                                                                                               // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "10\n"                                                                                                                                                                                       // Colorize: green
            "11\n"                                                                                                                                                                                       // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Document Language: en-US";                                                                                                                                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(versionText))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("DMI specification version didn't match with the stored one");                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void DmiSpecVerifier::checkDmiEntryHeader(SpecVerifyThread *thread, const QString &specContent)                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString headerText;                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init headerText                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        headerText =                                                                                                                                                                                     // Colorize: green
            "901\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "6.1.2\n"                                                                                                                                                                                    // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "902\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Each SMBIOS structure begins with a four-byte header as shown in Table 3.\n"                                                                                                                // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Structure header format\n"                                                                                                                                                                  // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Table 3  Structure header format description\n"                                                                                                                                            // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "903\n"                                                                                                                                                                                      // Colorize: green
            "Offset\n"                                                                                                                                                                                   // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Name\n"                                                                                                                                                                                     // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Length\n"                                                                                                                                                                                   // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Description\n"                                                                                                                                                                              // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "00h\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Type\n"                                                                                                                                                                                     // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "BYTE\n"                                                                                                                                                                                     // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Specifies the type of structure. Types 0 through 127 (7Fh) are reserved for and\n"                                                                                                          // Colorize: green
            "defined by this specification. Types 128 through 256 (80h to FFh) are available for\n"                                                                                                      // Colorize: green
            "system- and OEM-specific information.\n"                                                                                                                                                    // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "01h\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Length\n"                                                                                                                                                                                   // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "BYTE\n"                                                                                                                                                                                     // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Specifies the length of the formatted area of the structure, starting at the Type field.\n"                                                                                                 // Colorize: green
            "The length of the structures string-set is not included.\n"                                                                                                                                // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "02h\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Handle\n"                                                                                                                                                                                   // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "WORD\n"                                                                                                                                                                                     // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Specifies the structures handle, a unique 16-bit number in the range 0 to 0FFFEh\n"                                                                                                        // Colorize: green
            "(for version 2.0) or 0 to 0FEFFh (for version 2.1 and later). The handle can be used\n"                                                                                                     // Colorize: green
            "with the Get SMBIOS Structure function to retrieve a specific structure; the handle\n"                                                                                                      // Colorize: green
            "numbers are not required to be contiguous. For version 2.1 and later, handle\n"                                                                                                             // Colorize: green
            "values in the range 0FF00h to 0FFFFh are reserved for use by this specification. [1]\n"                                                                                                     // Colorize: green
            "If the system configuration changes, a previously assigned handle might no longer\n"                                                                                                        // Colorize: green
            "exist. However, after a handle has been assigned by the BIOS, the BIOS cannot\n"                                                                                                            // Colorize: green
            "re-assign that handle number to another structure.\n"                                                                                                                                       // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "[1]\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "The UEFI Platform Initialization Specification reserves handle number FFFEh for its EFI_SMBIOS_PROTOCOL.Add() function\n"                                                                   // Colorize: green
            "to mean assign an unused handle number automatically. This number is not used for any other purpose by the SMBIOS\n"                                                                      // Colorize: green
            "specification.";                                                                                                                                                                            // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(headerText))                                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("DMI header specification didn't match with the stored one");                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList lines = headerText.split('\n');                                                                                                                                                          // Colorize: green
    qint64      i     = 0;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Skip lines                                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            lines.at(10) != "Table 3  Structure header format description"                                                                                                                              // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(11) != ""                                                                                                                                                                           // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(12) != "903"                                                                                                                                                                        // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(13) != "Offset"                                                                                                                                                                     // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(14) != ""                                                                                                                                                                           // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(15) != "Name"                                                                                                                                                                       // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(16) != ""                                                                                                                                                                           // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(17) != "Length"                                                                                                                                                                     // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(18) != ""                                                                                                                                                                           // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(19) != "Description"                                                                                                                                                                // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            lines.at(20) != ""                                                                                                                                                                           // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to parse DMI header specification");                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        i = 21;                                                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList fieldNames;                                                                                                                                                                              // Colorize: green
    QStringList fieldTypes;                                                                                                                                                                              // Colorize: green
    QStringList fieldDescriptions;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get fields                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        while (i < lines.size())                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString offset = lines.at(i);                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (offset == "[1]")                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                break;                                                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i += 2;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString name = lines.at(i);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i += 2;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString type = lines.at(i);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i += 2;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString description = lines.at(i);                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            while (i < lines.size() - 1 && lines.at(i + 1) != "")                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                ++i;                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                description.append(' ');                                                                                                                                                                 // Colorize: green
                description.append(lines.at(i));                                                                                                                                                         // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            fieldNames.append(name);                                                                                                                                                                     // Colorize: green
            fieldTypes.append(type);                                                                                                                                                                     // Colorize: green
            fieldDescriptions.append(description);                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i += 2;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (i >= lines.size())                                                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to parse DMI header specification");                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QHash<QString, QString> dmiFieldNamesToNgosFieldNames; // DMI field name => NGOS field name                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Fill dmiFieldNamesToNgosFieldNames                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        dmiFieldNamesToNgosFieldNames.insert("Type",   "type");                                                                                                                           // Colorize: green
        dmiFieldNamesToNgosFieldNames.insert("Length", "length");                                                                                                                                     // Colorize: green
        dmiFieldNamesToNgosFieldNames.insert("Handle", "handle");                                                                                                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList headerLines;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        headerLines.append(QString("// Verified with DmiSpecVerifier [BEGIN] // %1")                                                                                                                      // Colorize: green
                                    .arg(DMI_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
        headerLines.append("struct DmiEntryHeader");                                                                                                                                                          // Colorize: green
        headerLines.append("{");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (i = 0; i < fieldNames.size(); ++i)                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString type = mDmiTypeToNgosTypeMap.value(fieldTypes.at(i), fieldTypes.at(i));                                                                                                                            // Colorize: green
            QString name = dmiFieldNamesToNgosFieldNames.value(fieldNames.at(i), "");                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (name == "")                                                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to convert DMI field name: %1")                                                                                                                         // Colorize: green
                                            .arg(fieldNames.at(i))                                                                                                                                              // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            headerLines.append(QString("    %1 %2;%3 // %4")                                                                                                                                             // Colorize: green
                                        .arg(type, -12, QChar(' '))                                                                                                                                      // Colorize: green
                                        .arg(name)                                                                                                                                                       // Colorize: green
                                        .arg("", 6 - name.length(), QChar(' '))                                                                                                                          // Colorize: green
                                        .arg(fieldDescriptions.at(i))                                                                                                                                    // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        headerLines.append("} __attribute__((packed));");                                                                                                                                                                        // Colorize: green
        headerLines.append(QString("// Verified with DmiSpecVerifier [END] // %1")                                                                                                                      // Colorize: green
                                    .arg(DMI_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Replace well known types for fields                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        headerLines.replaceInStrings("    good_U8      type;", "    DmiEntryType type;");                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(headerLines, thread->getPath() + "/" + DMI_ENTRY_HEADER_H))                                                                                                                          // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check DMI header with specification");                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
DmiSpecVerifier dmiSpecVerifierInstance;                                                                                                                                                                 // Colorize: green
