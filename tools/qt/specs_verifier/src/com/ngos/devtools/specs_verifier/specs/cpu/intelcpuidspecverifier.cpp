#include "intelcpuidspecverifier.h"                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QEventLoop>                                                                                                                                                                                    // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QNetworkAccessManager>                                                                                                                                                                         // Colorize: green
#include <QNetworkReply>                                                                                                                                                                                 // Colorize: green
#include <QNetworkRequest>                                                                                                                                                                               // Colorize: green
#include <QProcess>                                                                                                                                                                                      // Colorize: green
#include <QTemporaryDir>                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/shared/common/ngos/types.h>                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define INTEL_SPECIFICATION_URL "https://cdrdv2.intel.com/v1/dl/getContent/671199" // Version: April 2022                                                                                                           // Colorize: green
#define INTEL_PDF               "intelcpuid.pdf"                                                                                                                                                             // Colorize: green
#define INTEL_TXT               "intelcpuid.txt"                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define INTEL_CPUID00000000EAX_H "src/os/shared/common/src/com/ngos/shared/common/cpu/lib/cpuid/cpuid00000000eax.h"                                                                                        // Colorize: green
#define INTEL_CPUID_VENDOR_H     "src/os/shared/common/src/com/ngos/shared/common/cpu/lib/cpuid/cpuidvendor.h"                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
IntelCpuidSpecVerifier::IntelCpuidSpecVerifier()                                                                                                                                                             // Colorize: green
    : SpecVerifier()                                                                                                                                                                                     // Colorize: green
    , mHexRegExp(".* ([0-9a-fA-F]+)h .*")                                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void IntelCpuidSpecVerifier::verify(SpecVerifyThread *thread)                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString specContent;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!downloadSpecification(thread, INTEL_SPECIFICATION_URL, specContent))                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        return;                                                                                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Replace some special characters                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                            // Colorize: green
        specContent.replace(QChar(0x00AE), "(R)");  // Replace registered sign character    // https://www.compart.com/en/unicode/U+00AE                                                                 // Colorize: green
        specContent.replace(QChar(0x2014), '-');    // Replace em dash                      // https://www.compart.com/en/unicode/U+2014                                                                 // Colorize: green
        specContent.replace(QChar(0x2018), '\'');   // Replace left single quotation mark   // https://www.compart.com/en/unicode/U+2018                                                                 // Colorize: green
        specContent.replace(QChar(0x2019), '\'');   // Replace right double quotation mark  // https://www.compart.com/en/unicode/U+2019                                                                 // Colorize: green
        specContent.replace(QChar(0x201C), '\"');   // Replace left double quotation mark   // https://www.compart.com/en/unicode/U+201C                                                                 // Colorize: green
        specContent.replace(QChar(0x201D), '\"');   // Replace right double quotation mark  // https://www.compart.com/en/unicode/U+201D                                                                 // Colorize: green
        specContent.replace(QChar(0x2022), '*');    // Replace bullet                       // https://www.compart.com/en/unicode/U+2022                                                                 // Colorize: green
        specContent.replace(QChar(0x2122), "(TM)"); // Replace trade mark sign character    // https://www.compart.com/en/unicode/U+2122                                                                 // Colorize: green
    }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    checkWithSpecification(thread, specContent);                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool IntelCpuidSpecVerifier::downloadSpecification(SpecVerifyThread *thread, const QString &url, QString &specContent)                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(url    != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QTemporaryDir tempDir;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Create temporary directory                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!tempDir.isValid())                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to create temporary directory for INTEL CPUID specification");                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Download specification                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QNetworkAccessManager  manager;                                                                                                                                                                  // Colorize: green
        QNetworkReply         *reply;                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Send network request                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QNetworkRequest request;                                                                                                                                                                     // Colorize: green
            request.setUrl(QUrl(url));                                                                                                                                                 // Colorize: green
            reply = manager.get(request);                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Wait for finish                                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QEventLoop waitLoop;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QObject::connect(reply, SIGNAL(finished()),                                 &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
            QObject::connect(reply, SIGNAL(errorOccurred(QNetworkReply::NetworkError)), &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            waitLoop.exec();                                                                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Check status code                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QVariant statusCode = reply->attribute(QNetworkRequest::HttpStatusCodeAttribute);                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (statusCode.toInt() != 200)                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to get INTEL CPUID specification from: %1")                                                                                                               // Colorize: green
                                            .arg(url)                                                                                                                                  // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                delete reply;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return false;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QByteArray content = reply->readAll();                                                                                                                                                           // Colorize: green
        delete reply;                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Write documentation to file                                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QFile file(tempDir.path() + "/" + INTEL_PDF);                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (!file.open(QIODevice::WriteOnly))                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError("Failed to create temporary file for INTEL CPUID specification");                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return false;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            file.write(content);                                                                                                                                                                         // Colorize: green
            file.close();                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Convert PDF to text                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QProcess process;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        process.setWorkingDirectory(tempDir.path());                                                                                                                                                     // Colorize: green
        process.start("pdftotext", QStringList() << INTEL_PDF << INTEL_TXT);                                                                                                                                 // Colorize: green
        process.waitForFinished(-1);                                                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read specification text                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile file(tempDir.path() + "/" + INTEL_TXT);                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!file.open(QIODevice::ReadOnly))                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to open INTEL CPUID specification");                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        specContent += QString::fromUtf8(file.readAll());                                                                                                                                                 // Colorize: green
        file.close();                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void IntelCpuidSpecVerifier::checkWithSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    qint64 errorsBefore = thread->getErrors().size();                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check code with specification                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        checkIntelSpecification(thread, specContent);                                                                                                                                                    // Colorize: green
        checkCpuid00000000Eax(thread, specContent);                                                                                                                                                      // Colorize: green
        checkCpuidVendor(thread, specContent);                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (thread->getErrors().size() == errorsBefore)                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Code verified with INTEL CPUID specification");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Found error in code with INTEL CPUID specification");                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void IntelCpuidSpecVerifier::checkIntelSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString versionText;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init versionText                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        versionText =                                                                                                                                                                                    // Colorize: green
            "Intel(R) 64 and IA-32 Architectures\n"                                                                                                                                                        // Colorize: green
            "Software Developer's Manual\n"                                                                                                                                                              // Colorize: green
            "Volume 2A:\n"                                                                                                                                                                               // Colorize: green
            "Instruction Set Reference, A-L\n"                                                                                                                                                           // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "NOTE: The Intel(R) 64 and IA-32 Architectures Software Developer's Manual consists of ten volumes:\n"                                                                                         // Colorize: green
            "Basic Architecture, Order Number 253665; Instruction Set Reference A-L, Order Number 253666;\n"                                                                                             // Colorize: green
            "Instruction Set Reference M-U, Order Number 253667; Instruction Set Reference V-Z, Order Number\n"                                                                                          // Colorize: green
            "326018; Instruction Set Reference, Order Number 334569; System Programming Guide, Part 1, Order\n"                                                                                          // Colorize: green
            "Number 253668; System Programming Guide, Part 2, Order Number 253669; System Programming\n"                                                                                                 // Colorize: green
            "Guide, Part 3, Order Number 326019; System Programming Guide, Part 4, Order Number 332831;\n"                                                                                               // Colorize: green
            "Model-Specific Registers, Order Number 335592. Refer to all ten volumes when evaluating your design\n"                                                                                      // Colorize: green
            "needs.\n"                                                                                                                                                                                   // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Order Number: 253666-077US\n"                                                                                                                                                               // Colorize: green
            "April 2022";                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(versionText))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("INTEL CPUID specification version didn't match with the stored one");                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void IntelCpuidSpecVerifier::checkCpuid00000000Eax(SpecVerifyThread *thread, const QString &specContent)                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString cpuidText1;                                                                                                                                                                                 // Colorize: green
    QString cpuidText2;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init cpuidText1 and cpuidText2                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        cpuidText1 =                                                                                                                                                                                    // Colorize: green
            "EAX\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "Maximum Input Value for Basic CPUID Information.";                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        cpuidText2 =                                                                                                                                                                                      // Colorize: green
            "INPUT EAX = 0: Returns CPUID's Highest Value for Basic Processor Information and the Vendor Identification String\n"                                                                        // Colorize: green
            "When CPUID executes with EAX set to 0, the processor returns the highest value the CPUID recognizes for\n"                                                                                  // Colorize: green
            "returning basic processor information. The value is returned in the EAX register and is processor specific.";                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            !specContent.contains(cpuidText1)                                                                                                                                                            // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            !specContent.contains(cpuidText2)                                                                                                                                                            // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("CPUID 00000000 EAX specification didn't match with the stored one");                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList cpuidLines;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        cpuidLines.append(QString("// Verified with IntelCpuidSpecVerifier [BEGIN] // %1")                                                                                                                      // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
        cpuidLines.append("struct Cpuid00000000Eax");                                                                                                                                                    // Colorize: green
        cpuidLines.append("{");                                                                                                                                                                          // Colorize: green
        cpuidLines.append("    union");                                                                                                                                                                  // Colorize: green
        cpuidLines.append("    {");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("        struct");                                                                                                                                                             // Colorize: green
        cpuidLines.append("        {");                                                                                                                                                                  // Colorize: green
        cpuidLines.append("            CpuidLeaf largestFunction;");                                                                                                                                     // Colorize: green
        cpuidLines.append("        };");                                                                                                                                                                 // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("        good_U32 value32;");                                                                                                                                                  // Colorize: green
        cpuidLines.append("    };");                                                                                                                                                                     // Colorize: green
        cpuidLines.append("} __attribute__((packed));");                                                                                                                                                 // Colorize: green
        cpuidLines.append(QString("// Verified with IntelCpuidSpecVerifier [END] // %1")                                                                                                                      // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(cpuidLines, thread->getPath() + "/" + INTEL_CPUID00000000EAX_H))                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check CPUID 00000000 EAX with specification");                                                                                                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void IntelCpuidSpecVerifier::checkCpuidVendor(SpecVerifyThread *thread, const QString &specContent)                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString cpuidText1;                                                                                                                                                                                 // Colorize: green
    QString cpuidText2;                                                                                                                                                                                 // Colorize: green
    QString cpuidText3;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init cpuidText1, cpuidText2 and cpuidText3                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        cpuidText1 =                                                                                                                                                                                      // Colorize: green
            "EBX\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "\"Genu\"\n"                                                                                                                                                                                 // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "ECX\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "\"ntel\"\n"                                                                                                                                                                                 // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "EDX\n"                                                                                                                                                                                      // Colorize: green
            "\n"                                                                                                                                                                                         // Colorize: green
            "\"ineI\"";                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        cpuidText2 =                                                                                                                                                                                      // Colorize: green
            "INPUT EAX = 0: Returns CPUID's Highest Value for Basic Processor Information and the Vendor Identification String\n"                                                                        // Colorize: green
            "When CPUID executes with EAX set to 0, the processor returns the highest value the CPUID recognizes for\n"                                                                                  // Colorize: green
            "returning basic processor information. The value is returned in the EAX register and is processor specific.";                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        cpuidText3 =                                                                                                                                                                                      // Colorize: green
            "A vendor identification string is also returned in EBX, EDX, and ECX. For Intel processors, the string is \"GenuineIntel\" and is expressed:\n"                                               // Colorize: green
            "EBX := 756e6547h (* \"Genu\", with G in the low eight bits of BL *)\n"                                                                                                                        // Colorize: green
            "EDX := 49656e69h (* \"ineI\", with i in the low eight bits of DL *)\n"                                                                                                                        // Colorize: green
            "ECX := 6c65746eh (* \"ntel\", with n in the low eight bits of CL *)";                                                                                                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            !specContent.contains(cpuidText1)                                                                                                                                                            // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            !specContent.contains(cpuidText2)                                                                                                                                                            // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            !specContent.contains(cpuidText3)                                                                                                                                                            // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("CPUID Vendor specification didn't match with the stored one");                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList cpuidLines;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        cpuidLines.append(QString("// Verified with IntelCpuidSpecVerifier [BEGIN] // %1")                                                                                                                      // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
        cpuidLines.append("struct CpuidVendor");                                                                                                                                                         // Colorize: green
        cpuidLines.append("{");                                                                                                                                                                          // Colorize: green
        cpuidLines.append("    inline bool isIntel() const");                                                                                                                                            // Colorize: green
        cpuidLines.append("    {");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("        COMMON_LT((\"\"));");                                                                                                                                                   // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("        return uints[0] == VENDOR_INTEL_1");                                                                                                                                  // Colorize: green
        cpuidLines.append("                &&");                                                                                                                                                         // Colorize: green
        cpuidLines.append("                uints[1] == VENDOR_INTEL_2");                                                                                                                                 // Colorize: green
        cpuidLines.append("                &&");                                                                                                                                                         // Colorize: green
        cpuidLines.append("                uints[2] == VENDOR_INTEL_3;");                                                                                                                                // Colorize: green
        cpuidLines.append("    }");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("    inline bool isAMD() const");                                                                                                                                              // Colorize: green
        cpuidLines.append("    {");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("        COMMON_LT((\"\"));");                                                                                                                                                   // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("        return uints[0] == VENDOR_AMD_1");                                                                                                                                    // Colorize: green
        cpuidLines.append("                &&");                                                                                                                                                         // Colorize: green
        cpuidLines.append("                uints[1] == VENDOR_AMD_2");                                                                                                                                   // Colorize: green
        cpuidLines.append("                &&");                                                                                                                                                         // Colorize: green
        cpuidLines.append("                uints[2] == VENDOR_AMD_3;");                                                                                                                                  // Colorize: green
        cpuidLines.append("    }");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("    union");                                                                                                                                                                  // Colorize: green
        cpuidLines.append("    {");                                                                                                                                                                      // Colorize: green
        cpuidLines.append("        struct");                                                                                                                                                             // Colorize: green
        cpuidLines.append("        {");                                                                                                                                                                  // Colorize: green
        cpuidLines.append("            good_U32 uints[3];");                                                                                                                                             // Colorize: green
        cpuidLines.append("        };");                                                                                                                                                                 // Colorize: green
        cpuidLines.append("");                                                                                                                                                                           // Colorize: green
        cpuidLines.append("        good_Char8 chars[12];");                                                                                                                                              // Colorize: green
        cpuidLines.append("    };");                                                                                                                                                                     // Colorize: green
        cpuidLines.append("} __attribute__((packed));");                                                                                                                                                 // Colorize: green
        cpuidLines.append(QString("// Verified with IntelCpuidSpecVerifier [END] // %1")                                                                                                                      // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList fileLines = readLinesFromFile(thread->getPath() + "/" + INTEL_CPUID_VENDOR_H);                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFileLines(cpuidLines, fileLines))                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check CPUID Vendor with specification");                                                                                                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList vendorHexes;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get vendor hexes                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QStringList lines = cpuidText3.split('\n');                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 0; i < lines.size(); ++i)                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QRegularExpressionMatch match = mHexRegExp.match(lines.at(i));                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (match.hasMatch())                                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                vendorHexes.append(match.captured(1));                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList vendorLines;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        vendorLines.append(QString("// Verified with IntelCpuidSpecVerifier [BEGIN] // %1")                                                                                                                      // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 0; i < vendorHexes.size(); ++i)                                                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString     hex   = vendorHexes.at(i).toUpper();                                                                                                                                             // Colorize: green
            quint32     uint  = hex.toULongLong(nullptr, 16);                                                                                                                                            // Colorize: green
            good_Char8 *chars = reinterpret_cast<good_Char8 *>(&uint);                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            vendorLines.append(QString("#define VENDOR_INTEL_%1 0x%2   // %3%4%5%6")                                                                                                                     // Colorize: green
                                        .arg(i + 1)                                                                                                                                                      // Colorize: green
                                        .arg(hex, 8, QChar('0'))                                                                                                                                         // Colorize: green
                                        .arg(chars[0])                                                                                                                                                   // Colorize: green
                                        .arg(chars[1])                                                                                                                                                   // Colorize: green
                                        .arg(chars[2])                                                                                                                                                   // Colorize: green
                                        .arg(chars[3])                                                                                                                                                   // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        vendorLines.append(QString("// Verified with IntelCpuidSpecVerifier [END] // %1")                                                                                                                // Colorize: green
                                    .arg(INTEL_SPECIFICATION_URL)                                                                                                                                           // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFileLines(vendorLines, fileLines))                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check CPUID Intel Vendor with specification");                                                                                                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
IntelCpuidSpecVerifier intelCpuidSpecVerifier;                                                                                                                                                               // Colorize: green
