#include "pespecverifier.h"                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QEventLoop>                                                                                                                                                                                    // Colorize: green
#include <QNetworkAccessManager>                                                                                                                                                                         // Colorize: green
#include <QNetworkReply>                                                                                                                                                                                 // Colorize: green
#include <QNetworkRequest>                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PE_SPECIFICATION_URL "https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" // Version 11/11/2021                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PE_HEADER_H      "tools/qt/image_builder/src/com/ngos/devtools/image_builder/pe/peheader.h"                                                                                                      // Colorize: green
#define PE_COFF_HEADER_H "tools/qt/image_builder/src/com/ngos/devtools/image_builder/pe/coffheader.h"                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PESpecVerifier::PESpecVerifier()                                                                                                                                                                         // Colorize: green
    : SpecVerifier()                                                                                                                                                                                     // Colorize: green
    , mPeTypeToNgosTypeMap()                                                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mPeTypeToNgosTypeMap.insert("1", "quint8");                                                                                                                                                          // Colorize: green
    mPeTypeToNgosTypeMap.insert("2", "quint16");                                                                                                                                                         // Colorize: green
    mPeTypeToNgosTypeMap.insert("4", "quint32");                                                                                                                                                         // Colorize: green
    mPeTypeToNgosTypeMap.insert("8", "quint64");                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::verify(SpecVerifyThread *thread)                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString specContent;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Download specification                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QNetworkAccessManager  manager;                                                                                                                                                                  // Colorize: green
        QNetworkReply         *reply;                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Send network request                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QNetworkRequest request;                                                                                                                                                                     // Colorize: green
            request.setUrl(QUrl(PE_SPECIFICATION_URL));                                                                                                                                                  // Colorize: green
            reply = manager.get(request);                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Wait for finish                                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QEventLoop waitLoop;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QObject::connect(reply, SIGNAL(finished()),                                 &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
            QObject::connect(reply, SIGNAL(errorOccurred(QNetworkReply::NetworkError)), &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            waitLoop.exec();                                                                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Check status code                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QVariant statusCode = reply->attribute(QNetworkRequest::HttpStatusCodeAttribute);                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (statusCode.toInt() != 200)                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to get PE specification from: %1").arg(PE_SPECIFICATION_URL));                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                delete reply;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        specContent = QString::fromUtf8(reply->readAll());                                                                                                                                               // Colorize: green
        delete reply;                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Replace some special characters                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        specContent.replace('\t', "    "); // Replace tabulation                                                                                                                                         // Colorize: green
        specContent.remove('\r');          // Remove \r                                                                                                                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    checkWithSpecification(thread, specContent);                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkWithSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    qint64 errorsBefore = thread->getErrors().size();                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check code with specification                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        checkPeSpecification(thread, specContent);                                                                                                                                                       // Colorize: green
        checkPeHeader(thread, specContent);                                                                                                                                                              // Colorize: green
        checkPeHeaderSignature(thread, specContent);                                                                                                                                                     // Colorize: green
        checkPeCoffHeader(thread, specContent);                                                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (thread->getErrors().size() == errorsBefore)                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Code verified with PE specification");                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Found error in code with PE specification");                                                                                                                                 // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString versionText;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init versionText                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        versionText =                                                                                                                                                                                    // Colorize: green
            "                                                    <li>\n"                                                                                                                                 // Colorize: green
            "Article                                                    </li>\n"                                                                                                                         // Colorize: green
            "                                                    <li>\n"                                                                                                                                 // Colorize: green
            "                                                        <time class=\"is-invisible\" data-article-date aria-label=\"Article review date\" datetime=\"2021-11-11T19:51:00Z\" data-article-date-source=\"git\">11/11/2021</time>\n" // Colorize: green
            "                                                    </li>";                                                                                                                                 // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(versionText))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("PE specification version didn't match with the stored one");                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeHeader(SpecVerifyThread *thread, const QString &specContent)                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString fileHeadersText;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init fileHeadersText                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        fileHeadersText =                                                                                                                                                                                // Colorize: green
            "<h2 id=\"file-headers\">File Headers</h2>\n"                                                                                                                                                // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#ms-dos-stub-image-only\" data-linktype=\"self-bookmark\">MS-DOS Stub (Image Only)</a></li>\n"                                                                                // Colorize: green
            "<li><a href=\"#signature-image-only\" data-linktype=\"self-bookmark\">Signature (Image Only)</a></li>\n"                                                                                    // Colorize: green
            "<li><a href=\"#coff-file-header-object-and-image\" data-linktype=\"self-bookmark\">COFF File Header (Object and Image)</a>\n"                                                               // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#machine-types\" data-linktype=\"self-bookmark\">Machine Types</a></li>\n"                                                                                                    // Colorize: green
            "<li><a href=\"#characteristics\" data-linktype=\"self-bookmark\">Characteristics</a></li>\n"                                                                                                // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "</li>\n"                                                                                                                                                                                    // Colorize: green
            "<li><a href=\"#optional-header-image-only\" data-linktype=\"self-bookmark\">Optional Header (Image Only)</a>\n"                                                                             // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#optional-header-standard-fields-image-only\" data-linktype=\"self-bookmark\">Optional Header Standard Fields (Image Only)</a></li>\n"                                        // Colorize: green
            "<li><a href=\"#optional-header-windows-specific-fields-image-only\" data-linktype=\"self-bookmark\">Optional Header Windows-Specific Fields (Image Only)</a></li>\n"                        // Colorize: green
            "<li><a href=\"#optional-header-data-directories-image-only\" data-linktype=\"self-bookmark\">Optional Header Data Directories (Image Only)</a></li>\n"                                      // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "</li>\n"                                                                                                                                                                                    // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "<p>The PE file header consists of a Microsoft MS-DOS stub, the PE signature, the COFF file header, and an optional header. A COFF object file header consists of a COFF file header and an optional header. In both cases, the file headers are followed immediately by section headers.</p>"; // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(fileHeadersText))                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to check PE Header with specification");                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList peHeaderLines;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        peHeaderLines.append("struct PEHeader");                                                                                                                                                         // Colorize: green
        peHeaderLines.append("{");                                                                                                                                                                       // Colorize: green
        peHeaderLines.append("    void print(); // TEST: NO");                                                                                                                                           // Colorize: green
        peHeaderLines.append("    bool verify(); // TEST: NO");                                                                                                                                          // Colorize: green
        peHeaderLines.append("");                                                                                                                                                                        // Colorize: green
        peHeaderLines.append("    quint32            signature;");                                                                                                                                       // Colorize: green
        peHeaderLines.append("    COFFHeader         coffHeader;");                                                                                                                                      // Colorize: green
        peHeaderLines.append("    PEOptHeader        optHeader;");                                                                                                                                       // Colorize: green
        peHeaderLines.append("    ImageSectionHeader sections[(quint64)Section::MAXIMUM];");                                                                                                             // Colorize: green
        peHeaderLines.append("};");                                                                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(peHeaderLines, thread->getPath() + "/" + PE_HEADER_H))                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check PE Header with specification");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeHeaderSignature(SpecVerifyThread *thread, const QString &specContent)                                                                                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString signatureText;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init signatureText                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        signatureText =                                                                                                                                                                                  // Colorize: green
            "<h3 id=\"signature-image-only\">Signature (Image Only)</h3>\n"                                                                                                                              // Colorize: green
            "<p>After the MS-DOS stub, at the file offset specified at offset 0x3c, is a 4-byte signature that identifies the file as a PE format image file. This signature is &quot;PE\0\0&quot; (the letters &quot;P&quot; and &quot;E&quot; followed by two null bytes).</p>"; // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(signatureText))                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to check PE Header signature with specification");                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList signatureLines;                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        signatureLines.append("#define PE_HEADER_SIGNATURE 0x00004550 // PE\\0\\0");                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(signatureLines, thread->getPath() + "/" + PE_HEADER_H))                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check PE Header signature with specification");                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeCoffHeader(SpecVerifyThread *thread, const QString &specContent)                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString coffHeaderText;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init coffHeaderText                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        coffHeaderText =                                                                                                                                                                                 // Colorize: green
            "<h3 id=\"coff-file-header-object-and-image\">COFF File Header (Object and Image)</h3>\n"                                                                                                    // Colorize: green
            "<p>At the beginning of an object file, or immediately after the signature of an image file, is a standard COFF file header in the following format. Note that the Windows loader limits the number of sections to 96.</p>\n" // Colorize: green
            "<table>\n"                                                                                                                                                                                  // Colorize: green
            "<thead>\n"                                                                                                                                                                                  // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<th>Offset</th>\n"                                                                                                                                                                          // Colorize: green
            "<th>Size</th>\n"                                                                                                                                                                            // Colorize: green
            "<th>Field</th>\n"                                                                                                                                                                           // Colorize: green
            "<th>Description</th>\n"                                                                                                                                                                     // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "</thead>\n"                                                                                                                                                                                 // Colorize: green
            "<tbody>\n"                                                                                                                                                                                  // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>0 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>2 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>Machine <br/></td>\n"                                                                                                                                                                   // Colorize: green
            "<td>The number that identifies the type of target machine. For more information, see <a href=\"#machine-types\" data-linktype=\"self-bookmark\">Machine Types</a>. <br/></td>\n"            // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>2 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>2 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>NumberOfSections <br/></td>\n"                                                                                                                                                          // Colorize: green
            "<td>The number of sections. This indicates the size of the section table, which immediately follows the headers. <br/></td>\n"                                                              // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>4 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>4 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>TimeDateStamp <br/></td>\n"                                                                                                                                                             // Colorize: green
            "<td>The low 32 bits of the number of seconds since 00:00 January 1, 1970 (a C run-time time_t value), which indicates when the file was created. <br/></td>\n"                              // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>8 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>4 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>PointerToSymbolTable <br/></td>\n"                                                                                                                                                      // Colorize: green
            "<td>The file offset of the COFF symbol table, or zero if no COFF symbol table is present. This value should be zero for an image because COFF debugging information is deprecated. <br/></td>\n" // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>12 <br/></td>\n"                                                                                                                                                                        // Colorize: green
            "<td>4 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>NumberOfSymbols <br/></td>\n"                                                                                                                                                           // Colorize: green
            "<td>The number of entries in the symbol table. This data can be used to locate the string table, which immediately follows the symbol table. This value should be zero for an image because COFF debugging information is deprecated. <br/></td>\n" // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>16 <br/></td>\n"                                                                                                                                                                        // Colorize: green
            "<td>2 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>SizeOfOptionalHeader <br/></td>\n"                                                                                                                                                      // Colorize: green
            "<td>The size of the optional header, which is required for executable files but not for object files. This value should be zero for an object file. For a description of the header format, see <a href=\"#optional-header-image-only\" data-linktype=\"self-bookmark\">Optional Header (Image Only)</a>. <br/></td>\n" // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "<tr>\n"                                                                                                                                                                                     // Colorize: green
            "<td>18 <br/></td>\n"                                                                                                                                                                        // Colorize: green
            "<td>2 <br/></td>\n"                                                                                                                                                                         // Colorize: green
            "<td>Characteristics <br/></td>\n"                                                                                                                                                           // Colorize: green
            "<td>The flags that indicate the attributes of the file. For specific flag values, see <a href=\"#characteristics\" data-linktype=\"self-bookmark\">Characteristics</a>. <br/></td>\n"       // Colorize: green
            "</tr>\n"                                                                                                                                                                                    // Colorize: green
            "</tbody>\n"                                                                                                                                                                                 // Colorize: green
            "</table>";                                                                                                                                                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(coffHeaderText))                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to check PE COFF Header with specification");                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList lines = coffHeaderText.split('\n');                                                                                                                                                      // Colorize: green
    qint64      i     = 0;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Skip lines                                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            lines.at(2) != "<table>"                                                                                                                                                                     // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(3) != "<thead>"                                                                                                                                                                     // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(4) != "<tr>"                                                                                                                                                                        // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(5) != "<th>Offset</th>"                                                                                                                                                             // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(6) != "<th>Size</th>"                                                                                                                                                               // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(7) != "<th>Field</th>"                                                                                                                                                              // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(8) != "<th>Description</th>"                                                                                                                                                        // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(9) != "</tr>"                                                                                                                                                                       // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(10) != "</thead>"                                                                                                                                                                   // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(11) != "<tbody>"                                                                                                                                                                    // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            lines.at(12) != "<tr>"                                                                                                                                                                       // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to parse PE COFF Header specification");                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        i = 13;                                                                                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList fieldTypes;                                                                                                                                                                              // Colorize: green
    QStringList fieldNames;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get fields                                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        while (i < lines.size())                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString line = lines.at(i);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (line == "</table>")                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                break;                                                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            ++i;                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            fieldTypes.append(lines[i].remove("<td>").remove("</td>").remove("<br/>").trimmed());                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            ++i;                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            fieldNames.append(lines[i].remove("<td>").remove("</td>").remove("<br/>").trimmed());                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i += 4;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList coffHeaderLines;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        coffHeaderLines.append("struct COFFHeader");                                                                                                                                                     // Colorize: green
        coffHeaderLines.append("{");                                                                                                                                                                     // Colorize: green
        coffHeaderLines.append("    void print(); // TEST: NO");                                                                                                                                         // Colorize: green
        coffHeaderLines.append("    bool verify(); // TEST: NO");                                                                                                                                        // Colorize: green
        coffHeaderLines.append("");                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (i = 0; i < fieldTypes.size(); ++i)                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString type = mPeTypeToNgosTypeMap.value(fieldTypes.at(i), "");                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (type == "")                                                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to convert PE type: %1").arg(fieldTypes.at(i)));                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString name = fieldNames.at(i);                                                                                                                                                             // Colorize: green
            name = name.at(0).toLower() + name.mid(1);                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            coffHeaderLines.append(QString("    %1 %2;").arg(type, -30, QChar(' ')).arg(name));                                                                                                          // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        coffHeaderLines.append("};");                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Replace well known types for fields                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        coffHeaderLines.replaceInStrings("    quint16                        machine;",         "    COFFHeaderMachine              machine;");                                                          // Colorize: green
        coffHeaderLines.replaceInStrings("    quint16                        characteristics;", "    COFFHeaderCharacteristicsFlags characteristics;");                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(coffHeaderLines, thread->getPath() + "/" + PE_COFF_HEADER_H))                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check PE COFF Header with specification");                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PESpecVerifier peSpecVerifierInstance;                                                                                                                                                                   // Colorize: green
