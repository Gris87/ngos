#include "pespecverifier.h"                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QEventLoop>                                                                                                                                                                                    // Colorize: green
#include <QNetworkAccessManager>                                                                                                                                                                         // Colorize: green
#include <QNetworkReply>                                                                                                                                                                                 // Colorize: green
#include <QNetworkRequest>                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PE_SPECIFICATION_URL "https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" // Version 11/11/2021                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PE_HEADER_H "tools/qt/image_builder/src/com/ngos/devtools/image_builder/pe/peheader.h"                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PESpecVerifier::PESpecVerifier()                                                                                                                                                                         // Colorize: green
    : SpecVerifier()                                                                                                                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::verify(SpecVerifyThread *thread)                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString specContent;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Download specification                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QNetworkAccessManager  manager;                                                                                                                                                                  // Colorize: green
        QNetworkReply         *reply;                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Send network request                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QNetworkRequest request;                                                                                                                                                                     // Colorize: green
            request.setUrl(QUrl(PE_SPECIFICATION_URL));                                                                                                                                                  // Colorize: green
            reply = manager.get(request);                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Wait for finish                                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QEventLoop waitLoop;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QObject::connect(reply, SIGNAL(finished()),                                 &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
            QObject::connect(reply, SIGNAL(errorOccurred(QNetworkReply::NetworkError)), &waitLoop, SLOT(quit()));                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            waitLoop.exec();                                                                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Check status code                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QVariant statusCode = reply->attribute(QNetworkRequest::HttpStatusCodeAttribute);                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (statusCode.toInt() != 200)                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addError(QString("Failed to get PE specification from: %1").arg(PE_SPECIFICATION_URL));                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                delete reply;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        specContent = QString::fromUtf8(reply->readAll());                                                                                                                                               // Colorize: green
        delete reply;                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Replace some special characters                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        specContent.replace('\t', "    "); // Replace tabulation                                                                                                                                         // Colorize: green
        specContent.remove('\r');          // Remove \r                                                                                                                                                  // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    checkWithSpecification(thread, specContent);                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkWithSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    qint64 errorsBefore = thread->getErrors().size();                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check code with specification                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        checkPeSpecification(thread, specContent);                                                                                                                                                       // Colorize: green
        checkPeHeader(thread, specContent);                                                                                                                                                         // Colorize: green
        checkPeHeaderSignature(thread, specContent);                                                                                                                                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (thread->getErrors().size() == errorsBefore)                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Code verified with PE specification");                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addMessage("Found error in code with PE specification");                                                                                                                                 // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeSpecification(SpecVerifyThread *thread, const QString &specContent)                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString versionText;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init versionText                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        versionText =                                                                                                                                                                                    // Colorize: green
            "                                                    <li>\n"                                                                                                                                 // Colorize: green
            "Article                                                    </li>\n"                                                                                                                         // Colorize: green
            "                                                    <li>\n"                                                                                                                                 // Colorize: green
            "                                                        <time class=\"is-invisible\" data-article-date aria-label=\"Article review date\" datetime=\"2021-11-11T19:51:00Z\" data-article-date-source=\"git\">11/11/2021</time>\n" // Colorize: green
            "                                                    </li>";                                                                                                                                 // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(versionText))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("PE specification version didn't match with the stored one");                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeHeader(SpecVerifyThread *thread, const QString &specContent)                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString fileHeadersText;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init fileHeadersText                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        fileHeadersText =                                                                                                                                                                                // Colorize: green
            "<h2 id=\"file-headers\">File Headers</h2>\n"                                                                                                                                                // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#ms-dos-stub-image-only\" data-linktype=\"self-bookmark\">MS-DOS Stub (Image Only)</a></li>\n"                                                                                // Colorize: green
            "<li><a href=\"#signature-image-only\" data-linktype=\"self-bookmark\">Signature (Image Only)</a></li>\n"                                                                                    // Colorize: green
            "<li><a href=\"#coff-file-header-object-and-image\" data-linktype=\"self-bookmark\">COFF File Header (Object and Image)</a>\n"                                                               // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#machine-types\" data-linktype=\"self-bookmark\">Machine Types</a></li>\n"                                                                                                    // Colorize: green
            "<li><a href=\"#characteristics\" data-linktype=\"self-bookmark\">Characteristics</a></li>\n"                                                                                                // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "</li>\n"                                                                                                                                                                                    // Colorize: green
            "<li><a href=\"#optional-header-image-only\" data-linktype=\"self-bookmark\">Optional Header (Image Only)</a>\n"                                                                             // Colorize: green
            "<ul>\n"                                                                                                                                                                                     // Colorize: green
            "<li><a href=\"#optional-header-standard-fields-image-only\" data-linktype=\"self-bookmark\">Optional Header Standard Fields (Image Only)</a></li>\n"                                        // Colorize: green
            "<li><a href=\"#optional-header-windows-specific-fields-image-only\" data-linktype=\"self-bookmark\">Optional Header Windows-Specific Fields (Image Only)</a></li>\n"                        // Colorize: green
            "<li><a href=\"#optional-header-data-directories-image-only\" data-linktype=\"self-bookmark\">Optional Header Data Directories (Image Only)</a></li>\n"                                      // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "</li>\n"                                                                                                                                                                                    // Colorize: green
            "</ul>\n"                                                                                                                                                                                    // Colorize: green
            "<p>The PE file header consists of a Microsoft MS-DOS stub, the PE signature, the COFF file header, and an optional header. A COFF object file header consists of a COFF file header and an optional header. In both cases, the file headers are followed immediately by section headers.</p>"; // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(fileHeadersText))                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to check PE Header with specification");                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList peHeaderLines;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        peHeaderLines.append("struct PEHeader");                                                                                                                                                         // Colorize: green
        peHeaderLines.append("{");                                                                                                                                                                       // Colorize: green
        peHeaderLines.append("    void print(); // TEST: NO");                                                                                                                                           // Colorize: green
        peHeaderLines.append("    bool verify(); // TEST: NO");                                                                                                                                          // Colorize: green
        peHeaderLines.append("");                                                                                                                                                                        // Colorize: green
        peHeaderLines.append("    quint32            signature;");                                                                                                                                       // Colorize: green
        peHeaderLines.append("    COFFHeader         coffHeader;");                                                                                                                                      // Colorize: green
        peHeaderLines.append("    PEOptHeader        optHeader;");                                                                                                                                       // Colorize: green
        peHeaderLines.append("    ImageSectionHeader sections[(quint64)Section::MAXIMUM];");                                                                                                             // Colorize: green
        peHeaderLines.append("};");                                                                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(peHeaderLines, thread->getPath() + "/" + PE_HEADER_H))                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check PE Header with specification");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PESpecVerifier::checkPeHeaderSignature(SpecVerifyThread *thread, const QString &specContent)                                                                                                        // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread      != nullptr);                                                                                                                                                                    // Colorize: green
    Q_ASSERT(specContent != "");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString signatureText;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Init signatureText                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        signatureText =                                                                                                                                                                                  // Colorize: green
            "<h3 id=\"signature-image-only\">Signature (Image Only)</h3>\n"                                                                                                                              // Colorize: green
            "<p>After the MS-DOS stub, at the file offset specified at offset 0x3c, is a 4-byte signature that identifies the file as a PE format image file. This signature is &quot;PE\0\0&quot; (the letters &quot;P&quot; and &quot;E&quot; followed by two null bytes).</p>"; // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that specification contains required text                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!specContent.contains(signatureText))                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addError("Failed to check PE Header signature with specification");                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList signatureLines;                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Prepare lines for comparison with source code                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        signatureLines.append("#define PE_HEADER_SIGNATURE 0x00004550 // PE\\0\\0");                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!checkLinesInFile(signatureLines, thread->getPath() + "/" + PE_HEADER_H))                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addError("Failed to check PE Header signature with specification");                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PESpecVerifier peSpecVerifierInstance;                                                                                                                                                                   // Colorize: green
