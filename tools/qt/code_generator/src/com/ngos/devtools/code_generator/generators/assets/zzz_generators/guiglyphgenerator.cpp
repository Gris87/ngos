#include "guiglyphgenerator.h"                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QDataStream>                                                                                                                                                                                   // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <ft2build.h>                                                                                                                                                                                    // Colorize: green
#include FT_FREETYPE_H                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/shared/console/console.h>                                                                                                                                                    // Colorize: green
#include <com/ngos/shared/common/assets/lib/glyphdata.h>                                                                                                                                                // Colorize: green
#include <com/ngos/shared/common/assets/lib/glyphoffset.h>                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define FILE_PATH "assets/glyphs/gui.bin"                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define FONT_SIZE   50                                                                                                                                                                                   // Colorize: green
#define START_INDEX 0x20                                                                                                                                                                                 // Colorize: green
#define END_INDEX   0x7F                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
GuiGlyphGenerator::GuiGlyphGenerator()                                                                                                                                                                   // Colorize: green
    : AssetsGenerator()                                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool GuiGlyphGenerator::generate(const QString &path)                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QByteArray fontBytes;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read bytes from font file                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile fontFile(":/assets/fonts/gui.ttf"); // Ignore CppPunctuationVerifier                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!fontFile.open(QIODevice::ReadOnly))                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to open file assets/fonts/gui.ttf");                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QByteArray fontBytes = fontFile.readAll();                                                                                                                                                       // Colorize: green
        fontFile.close();                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    FT_Library library;                                                                                                                                                                                  // Colorize: green
    FT_Face    face;                                                                                                                                                                                     // Colorize: green
    FT_Error   error;                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Initialize FreeType library                                                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        error = FT_Init_FreeType(&library);                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (error)                                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to initialize FreeType library. Error: %1")                                                                                                                     // Colorize: green
                                    .arg(error)                                                                                                                                                          // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Load face from memory                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        error = FT_New_Memory_Face(library, (FT_Byte *)fontBytes.data(), fontBytes.size(), 0, &face);                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (error)                                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to load face from memory. Error: %1")                                                                                                                           // Colorize: green
                                    .arg(error)                                                                                                                                                          // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Set font size                                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        error = FT_Set_Char_Size(face, 0, FONT_SIZE * 64, 0, 0);                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (error)                                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to change font size. Error: %1")                                                                                                                                // Colorize: green
                                    .arg(error)                                                                                                                                                          // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QByteArray  offsetsData((END_INDEX - START_INDEX) * sizeof(GlyphOffset), 0);                                                                                                                                                // Colorize: green
    QByteArray  glyphData;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    GlyphOffset *offsets = reinterpret_cast<GlyphOffset *>(offsetsData.data());                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Draw glyphs and store data to offsets and glyphData                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = START_INDEX; i < END_INDEX; ++i)                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Put offset to buffer                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                quint64 offset = offsetsData.size() + glyphData.size();                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (offset > 65535)                                                                                                                                                                      // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("u16 is not enough for offsets"));                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return false;                                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                offsets[i - START_INDEX].offset = offset;                                                                                                                                                       // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Load glyph                                                                                                                                                                                // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                error = FT_Load_Glyph(face, FT_Get_Char_Index(face, i), FT_LOAD_DEFAULT);                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (error)                                                                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to load glyph for char 0x%1. Error: %2")                                                                                                                // Colorize: green
                                            .arg(i, 2, 16, QChar('0'))                                                                                                                                   // Colorize: green
                                            .arg(error)                                                                                                                                                  // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    continue;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Render glyph                                                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                error = FT_Render_Glyph(face->glyph, FT_RENDER_MODE_NORMAL);                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (error)                                                                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to render glyph for char 0x%1. Error: %2")                                                                                                              // Colorize: green
                                            .arg(i, 2, 16, QChar('0'))                                                                                                                                   // Colorize: green
                                            .arg(error)                                                                                                                                                  // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    continue;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Store glyph data                                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                GlyphData glyph;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                glyph.width        = face->glyph->advance.x / 64;                                                                                                                                        // Colorize: green
                glyph.bitmapLeft   = face->glyph->bitmap_left;                                                                                                                                           // Colorize: green
                glyph.bitmapTop    = face->glyph->bitmap_top;                                                                                                                                            // Colorize: green
                glyph.bitmapWidth  = face->glyph->bitmap.width;                                                                                                                                          // Colorize: green
                glyph.bitmapHeight = face->glyph->bitmap.rows;                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                glyphData.append(reinterpret_cast<char *>(&glyph),                     sizeof(glyph));                                                                                                   // Colorize: green
                glyphData.append(reinterpret_cast<char *>(face->glyph->bitmap.buffer), face->glyph->bitmap.rows * face->glyph->bitmap.pitch); // TODO: Why pitch?                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Free face                                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        error = FT_Done_Face(face);                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (error)                                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to free face. Error: %1")                                                                                                                                       // Colorize: green
                                    .arg(error)                                                                                                                                                          // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Free FreeType library                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        error = FT_Done_FreeType(library);                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (error)                                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to free FreeType library. Error: %1")                                                                                                                           // Colorize: green
                                    .arg(error)                                                                                                                                                          // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QByteArray data = offsetsData + glyphData;                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return save(path  + "/bootloader/"                       + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/cputest/"         + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/devicemanager/"   + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/hddtest/"         + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/memorytest/"      + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/networktest/"     + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/bootloader_tools/partitionwizard/" + FILE_PATH, data)                                                                                                                          // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            save(path + "/installer/"                        + FILE_PATH, data);                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
GuiGlyphGenerator guiGlyphGeneratorInstance;                                                                                                                                                             // Colorize: green
