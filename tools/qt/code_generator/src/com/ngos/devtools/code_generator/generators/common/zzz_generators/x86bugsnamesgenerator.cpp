#include "x86bugsnamesgenerator.h"                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QRegularExpression>                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/shared/console/console.h>                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define ORIGINAL_FILE_PATH "/src/os/shared/common/src/com/ngos/shared/common/cpu/lib/x86bug.h"                                                                                                        // Colorize: green
#define FILE_PATH          "/src/os/shared/common/src/com/ngos/shared/common/cpu/lib/generated/x86bugsnames.cpp"                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
X86BugsNamesGenerator::X86BugsNamesGenerator()                                                                                                                                                   // Colorize: green
    : CommonGenerator()                                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool X86BugsNamesGenerator::generate(const QString &path)                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QStringList originalLines;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read lines from original file                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QFile file(path + ORIGINAL_FILE_PATH);                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!file.open(QIODevice::ReadOnly))                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err(QString("Failed to open file: %1")                                                                                                                                              // Colorize: green
                                    .arg(path + ORIGINAL_FILE_PATH)                                                                                                                                      // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return false;                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        originalLines = QString::fromUtf8(file.readAll()).split('\n');                                                                                                                                   // Colorize: green
        file.close();                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList bugs;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Parse bugs from original file                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < originalLines.size(); ++i)                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString originalLine = originalLines.at(i).trimmed();                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (originalLine.contains("WORD_BIT("))                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                bugs.append(originalLine);                                                                                                                                                           // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QStringList lines;                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Add include lines                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        lines.append("#include \"x86bugsnames.h\"");                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        addThreeBlankLines(lines);                                                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    lines.append("const char8* x86BugsNames[static_cast<enum_t>(x86BugWord::MAXIMUM) * 32] = ");                                                                                                 // Colorize: green
    lines.append("{");                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Generate x86BugsNames content                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QRegularExpression regexp("^ *(\\w+) *= *WORD_BIT\\(([\\w:]+), *(\\d+)\\),?(?: *\\/\\/[^\"]*\"([^\"]*)\")?.*$"); // CPU_MELTDOWN = WORD_BIT(x86BugWord::NGOS_COMMON_FLAGS, 1), // "meltdown"             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QStringList wordBlock;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        quint64 currentWord     = 0;                                                                                                                                                                     // Colorize: green
        QString lastBugWord = "";                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 0; i < bugs.size(); ++i)                                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString bug = bugs.at(i);                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QRegularExpressionMatch match = regexp.match(bug);                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (!match.hasMatch())                                                                                                                                                                       // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                Console::err(QString("Bug declaration is invalid: %1")                                                                                                                               // Colorize: green
                                        .arg(bug)                                                                                                                                                    // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return false;                                                                                                                                                                            // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString bugName    = match.captured(1).toLower();                                                                                                                                        // Colorize: green
            QString bugWord    = match.captured(2);                                                                                                                                                  // Colorize: green
            QString bugBit     = match.captured(3);                                                                                                                                                  // Colorize: green
            QString bugAltName = match.captured(4);                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Get bug name                                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (!bugAltName.isNull())                                                                                                                                                            // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    bugName = bugAltName;                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (bugName.startsWith('_'))                                                                                                                                                     // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        bugName.remove(0, 1);                                                                                                                                                        // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            quint64 bit;                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Get bug bit                                                                                                                                                                           // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                bool ok;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                bit = bugBit.toULongLong(&ok);                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (!ok)                                                                                                                                                                                 // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Bug declaration is invalid: %1")                                                                                                                           // Colorize: green
                                            .arg(bug)                                                                                                                                                // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return false;                                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (bit >= 32)                                                                                                                                                                // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("bit is invalid for bug: %1")                                                                                                                               // Colorize: green
                                            .arg(bug)                                                                                                                                                // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return false;                                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (bugWord != lastBugWord)                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (lastBugWord != "")                                                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    // Add word block to lines                                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        if (currentWord > 0)                                                                                                                                                             // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            lines.append("");                                                                                                                                                            // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        lines.append(QString("    // word %1")                                                                                                                                           // Colorize: green
                                                .arg(currentWord)                                                                                                                                        // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                        lines.append("");                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        lines.append(wordBlock);                                                                                                                                                         // Colorize: green
                        ++currentWord;                                                                                                                                                                   // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                lastBugWord = bugWord;                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Fill word block with empty strings                                                                                                                                                    // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    wordBlock.clear();                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    for (qint64 i = 0; i < 32; ++i)                                                                                                                                                      // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        wordBlock.append(QString("    \"\", %1 // WORD_BIT(%2, %3)")                                                                                                      // Colorize: green
                                                    .arg("", 20, QChar(' '))                                                                                                                 // Colorize: green
                                                    .arg(bugWord)                                                                                                                                    // Colorize: green
                                                    .arg(i)                                                                                                                 // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Replace line in word block for specified bit                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                wordBlock[bit] = QString("    \"%1\", %2 // WORD_BIT(%3, %4)")                                                                                                            // Colorize: green
                                            .arg(bugName)                                                                                                                                            // Colorize: green
                                            .arg("", 20 - bugName.length(), QChar(' '))                                                                                                                 // Colorize: green
                                            .arg(bugWord)                                                                                                                                            // Colorize: green
                                            .arg(bit);                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Add word block to lines                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (currentWord > 0)                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                lines.append("");                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            lines.append(QString("    // word %1")                                                                                                                                                       // Colorize: green
                                    .arg(currentWord)                                                                                                                                                    // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
            lines.append("");                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            lines.append(wordBlock);                                                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    lines.append("};");                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return save(path + FILE_PATH, lines);                                                                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
X86BugsNamesGenerator x86BugsNamesGeneratorInstance;                                                                                                                                             // Colorize: green
