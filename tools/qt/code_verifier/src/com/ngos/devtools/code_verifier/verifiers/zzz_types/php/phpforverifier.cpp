#include "phpforverifier.h"                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/code_verifier/other/codeverificationfiletype.h>                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PhpForVerifier::PhpForVerifier()                                                                                                                                                                         // Colorize: green
    : BaseCodeVerifier(CodeVerificationFileType::PHP)                                                                                                                                                    // Colorize: green
    , mInitRegexp("^\\$(\\w) = .+$")                   // $i = 0                                                                                                                                                 // Colorize: green
    , mConditionRegexp("^\\$(\\w) [<>]=? .+$")         // $i < 5                                                                                                                                                 // Colorize: green
    , mStepRegexp("^[+-]{0,2}\\$(\\w)(?: [+-]= .+)?$") // ++$i or $i += 2                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void PhpForVerifier::verify(CodeWorkerThread *worker, const QString &path, const QString &/*content*/, const QStringList &lines)                                                                         // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    for (qint64 i = 0; i < lines.size(); ++i)                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QString line = lines.at(i);                                                                                                                                                                      // Colorize: green
        VERIFIER_IGNORE(line, "// Ignore PhpForVerifier");                                                                                                                                               // Colorize: green
        removeComments(line);                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (line.trimmed().startsWith("for ("))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QStringList variablesStack;                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            i = verifyCycleFor(worker, path, lines, i, variablesStack);                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
qint64 PhpForVerifier::verifyCycleFor(CodeWorkerThread *worker, const QString &path, const QStringList &lines, qint64 row, QStringList &variablesStack)                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QString line = lines.at(row);                                                                                                                                                                        // Colorize: green
    removeComments(line);                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    qint64 index = line.indexOf('(');                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (index >= 0)                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        qint64 index2 = line.lastIndexOf(')');                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (index2 >= 0)                                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QStringList fields = line.mid(index + 1, index2 - index - 1).split(';');                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (fields.size() == 3)                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QRegularExpressionMatch initMatch      = mInitRegexp.match(fields.at(0).trimmed());                                                                                                      // Colorize: green
                QRegularExpressionMatch conditionMatch = mConditionRegexp.match(fields.at(1).trimmed());                                                                                                 // Colorize: green
                QRegularExpressionMatch stepMatch      = mStepRegexp.match(fields.at(2).trimmed());                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check that syntax correct                                                                                                                                                             // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (!initMatch.hasMatch())                                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        worker->addError(path, row, QString("Unexpected initialization field: %1")                                                                                                       // Colorize: green
                                                            .arg(fields.at(0).trimmed())                                                                                                                 // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (!conditionMatch.hasMatch())                                                                                                                                                      // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        worker->addError(path, row, QString("Unexpected condition field: %1")                                                                                                            // Colorize: green
                                                            .arg(fields.at(1).trimmed())                                                                                                                 // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (!stepMatch.hasMatch())                                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        worker->addError(path, row, QString("Unexpected step field: %1")                                                                                                                 // Colorize: green
                                                            .arg(fields.at(2).trimmed())                                                                                                                 // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QString varName = initMatch.captured(1);                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check variable name in condition                                                                                                                                                      // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (conditionMatch.captured(1) != varName)                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        worker->addError(path, row, QString("Invalid variable usage. Expected %1")                                                                                                       // Colorize: green
                                                            .arg(varName)                                                                                                                                // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check variable name in step                                                                                                                                                           // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (stepMatch.captured(1) != varName)                                                                                                                                                // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        worker->addError(path, row, QString("Invalid variable usage. Expected %1")                                                                                                       // Colorize: green
                                                            .arg(varName)                                                                                                                                // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (variablesStack.contains(varName))                                                                                                                                                    // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    worker->addError(path, row, "Variable already specified earlier");                                                                                                                   // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QString spaces = line.left(line.indexOf("for ("));                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                qint64 endRow = row + 1;                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Find end line                                                                                                                                                                         // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    while (endRow < lines.size() && lines.at(endRow) != spaces + '}')                                                                                                                    // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        ++endRow;                                                                                                                                                                        // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Process for cycles recursively                                                                                                                                                        // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    variablesStack.append(varName);                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    for (qint64 i = row + 1; i <= endRow; ++i)                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        QString line = lines.at(i);                                                                                                                                                      // Colorize: green
                        VERIFIER_IGNORE(line, "// Ignore PhpForVerifier");                                                                                                                               // Colorize: green
                        removeComments(line);                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        if (line.trimmed().startsWith("for ("))                                                                                                                                          // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            i = verifyCycleFor(worker, path, lines, i, variablesStack);                                                                                                                  // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    variablesStack.removeOne(varName);                                                                                                                                                   // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return endRow;                                                                                                                                                                           // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                worker->addError(path, row, "Invalid format");                                                                                                                                           // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            worker->addError(path, row, "Expected closing bracket )");                                                                                                                                   // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        worker->addError(path, row, "Expected opening bracket (");                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return row;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PhpForVerifier phpForVerifierInstance;                                                                                                                                                                   // Colorize: green
