#include "imagebuilder.h"                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <QIODevice>                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <buildconfig.h>                                                                                                                                                                                 // Colorize: green
#include <com/ngos/configure/other/kerneldescriptor.h>                                                                                                                                                   // Colorize: green
#include <com/ngos/devtools/shared/console/console.h>                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PE_LOCATION_OFFSET 0x3C                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define SECTION_ALIGNMENT  0x40                                                                                                                                                                          // Colorize: green
#define RELOC_SECTION_SIZE SECTION_ALIGNMENT                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define TEXT_SECTION_NAME 0x000000747865742E // .text                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#if NGOS_BUILD_KERNEL_COMPRESSION == OPTION_KERNEL_COMPRESSION_XZ                                                                                                                                        // Colorize: green
#define COMPRESSED_EXTENSION ".xz"                                                                                                                                                                       // Colorize: green
#elif NGOS_BUILD_KERNEL_COMPRESSION == OPTION_KERNEL_COMPRESSION_GZIP                                                                                                                                    // Colorize: green
#define COMPRESSED_EXTENSION ".gz"                                                                                                                                                                       // Colorize: green
#else                                                                                                                                                                                                    // Colorize: green
#define COMPRESSED_EXTENSION ""                                                                                                                                                                          // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
ImageBuilder::ImageBuilder(const QString &bootElfPath, const QString &configureElfPath, const QString &kernelElfPath, const QString &textElfPath, const QString &resultImagePath)                        // Colorize: green
    : mBootElfPath(bootElfPath)                                                                                                                                                                          // Colorize: green
    , mConfigureElfPath(configureElfPath)                                                                                                                                                                // Colorize: green
    , mKernelElfPath(kernelElfPath)                                                                                                                                                                      // Colorize: green
    , mTextElfPath(textElfPath)                                                                                                                                                                          // Colorize: green
    , mResultImagePath(resultImagePath)                                                                                                                                                                  // Colorize: green
    , mBootElfObject()                                                                                                                                                                                   // Colorize: green
    , mConfigureElfObject()                                                                                                                                                                              // Colorize: green
    , mKernelElfObject()                                                                                                                                                                                 // Colorize: green
    , mKernelElf()                                                                                                                                                                                       // Colorize: green
    , mPEHeader(nullptr)                                                                                                                                                                                 // Colorize: green
    , mBootStart(-1)                                                                                                                                                                                     // Colorize: green
    , mBootEnd(-1)                                                                                                                                                                                       // Colorize: green
    , mRelocStart(-1)                                                                                                                                                                                    // Colorize: green
    , mRelocEnd(-1)                                                                                                                                                                                      // Colorize: green
    , mConfigStart(-1)                                                                                                                                                                                   // Colorize: green
    , mConfigEnd(-1)                                                                                                                                                                                     // Colorize: green
    , mKernelStart(-1)                                                                                                                                                                                   // Colorize: green
    , mKernelEnd(-1)                                                                                                                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Nothing                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
qint64 ImageBuilder::process()                                                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Read elf files                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        // Read boot.elf                                                                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                    // Colorize: green
            if (!mBootElfObject.read(mBootElfPath))                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                                // Colorize: green
                Console::err(QString("Failed to read %1 file")                                                                                                                                           // Colorize: green
                                        .arg(mBootElfPath)                                                                                                                                               // Colorize: green
                );                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                             // Colorize: green
                return 1;                                                                                                                                                                                    // Colorize: green
            }                                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                             // Colorize: green
        if (mTextElfPath == "")                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Read configure.elf                                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (!mConfigureElfObject.read(mConfigureElfPath))                                                                                                                                        // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to read %1 file")                                                                                                                                       // Colorize: green
                                            .arg(mConfigureElfPath)                                                                                                                                      // Colorize: green
                    );                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return 1;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Read kernel.elf                                                                                                                                                                           // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (!mKernelElfObject.read(mKernelElfPath))                                                                                                                                              // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to read %1 file")                                                                                                                                       // Colorize: green
                                            .arg(mKernelElfPath)                                                                                                                                         // Colorize: green
                    );                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return 1;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Read content of kernel.elf (compressed/decompressed)                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QFile file(mKernelElfPath + COMPRESSED_EXTENSION);                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (!file.open(QIODevice::ReadOnly))                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to read %1 file")                                                                                                                                       // Colorize: green
                                            .arg(mKernelElfPath + COMPRESSED_EXTENSION)                                                                                                                  // Colorize: green
                    );                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return 1;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                mKernelElf = file.readAll();                                                                                                                                                             // Colorize: green
                file.close();                                                                                                                                                                            // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Read text.elf                                                                                                                                                                             // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (!mConfigureElfObject.read(mTextElfPath))                                                                                                                                             // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    Console::err(QString("Failed to read %1 file")                                                                                                                                       // Colorize: green
                                            .arg(mTextElfPath)                                                                                                                                           // Colorize: green
                    );                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return 1;                                                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check for .bss section                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mConfigureElfObject.getSection(".bss") != nullptr)                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (mTextElfPath == "")                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                Console::err("Configure part image should not contain .bss section. Try to use __attribute__ ((section (\".noinit\"))) for your variables");                                             // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                Console::err("Text section should not contain .bss section. Try to use __attribute__ ((section (\".noinit\"))) for your variables");                                                     // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Add bytes to result image and configure ranges                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        mResultImage.append(mBootElfObject.getProgramBytes());                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mBootStart = 0;                                                                                                                                                                                  // Colorize: green
        mBootEnd   = mResultImage.size();                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mResultImage.append(RELOC_SECTION_SIZE, 0);                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mRelocStart = mBootEnd;                                                                                                                                                                          // Colorize: green
        mRelocEnd   = mResultImage.size();                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mResultImage.append(mConfigureElfObject.getProgramBytes());                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mConfigStart = mRelocEnd;                                                                                                                                                                        // Colorize: green
        mConfigEnd   = mResultImage.size();                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Add kernel image if needed and align last section                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mTextElfPath == "")                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Add kernel descriptor with kernel elf file (compressed/decompressed)                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                KernelDescriptor kernelDescriptor;                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                kernelDescriptor.imageSize   = mKernelElfObject.getFileSize();                                                                                                                           // Colorize: green
                kernelDescriptor.contentSize = mKernelElf.size();                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                mResultImage.append((char *)&kernelDescriptor, sizeof(kernelDescriptor));                                                                                                                // Colorize: green
                mResultImage.append(mKernelElf);                                                                                                                                                         // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Make kernel section aligned with SECTION_ALIGNMENT                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qint8 alignmentNeeded = mResultImage.size() & (SECTION_ALIGNMENT - 1);                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (alignmentNeeded > 0)                                                                                                                                                                 // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    mResultImage.append(SECTION_ALIGNMENT - alignmentNeeded, 0);                                                                                                                         // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mKernelStart = mConfigEnd;                                                                                                                                                                   // Colorize: green
            mKernelEnd   = mResultImage.size();                                                                                                                                                          // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Make text section aligned with SECTION_ALIGNMENT                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qint8 alignmentNeeded = mResultImage.size() & (SECTION_ALIGNMENT - 1);                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (alignmentNeeded > 0)                                                                                                                                                                 // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    mResultImage.append(SECTION_ALIGNMENT - alignmentNeeded, 0);                                                                                                                         // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mConfigEnd = mResultImage.size();                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check for magic numbers that applicable for UEFI boot image                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            readUInt16(0)      != 0x5A4D // MZ                                                                                                                                                           // Colorize: green
            ||                                                                                                                                                                                           // Colorize: green
            readUInt16(0x01FE) != 0xAA55 // Magic number for bootsector                                                                                                                                  // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Invalid Boot part image");                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get PE Header                                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        qint32 peHeaderLocation = getPeHeaderLocation();                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (peHeaderLocation < 0)                                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to find PE Header");                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        Console::out(QString("PE Header location: 0x%1")                                                                                                                                                 // Colorize: green
                                .arg(peHeaderLocation, 8, 16, QChar('0'))                                                                                                                                // Colorize: green
        );                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mPEHeader = getPeHeader(peHeaderLocation);                                                                                                                                                       // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Update PE Optional Header                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!updatePeOptionalHeader())                                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to update PE Optional Header");                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Update .reloc section                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!updateRelocSection())                                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to update .reloc section");                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Update .config section                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!updateConfigSection())                                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to update .config section");                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Update .kernel section                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!updateKernelSection())                                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to update .kernel section");                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Print PE Header                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        Console::out("");                                                                                                                                                                                // Colorize: green
        mPEHeader->print();                                                                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Verify PE Header                                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!mPEHeader->verify())                                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Invalid PE Header");                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Write result image                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!writeResultImage())                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            Console::err("Failed to write disk image");                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return 1;                                                                                                                                                                                    // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return 0;                                                                                                                                                                                            // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ImageBuilder::writeResultImage()                                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QFile file(mResultImagePath);                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (!file.open(QIODevice::WriteOnly))                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        Console::err(QString("Failed to open file \"%1\"")                                                                                                                                               // Colorize: green
                                .arg(mResultImagePath)                                                                                                                                                   // Colorize: green
        );                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return false;                                                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    file.write(mResultImage);                                                                                                                                                                            // Colorize: green
    file.close();                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
qint32 ImageBuilder::getPeHeaderLocation()                                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    qint32 peHeaderLocation = readUInt32(PE_LOCATION_OFFSET);                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (peHeaderLocation < mResultImage.size())                                                                                                                                                          // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (readUInt32(peHeaderLocation) == PE_HEADER_SIGNATURE)                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            return peHeaderLocation;                                                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return -1;                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
PEHeader* ImageBuilder::getPeHeader(qint32 offset)                                                                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return reinterpret_cast<PEHeader *>(mResultImage.data() + offset);                                                                                                                                                   // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ImageBuilder::updatePeOptionalHeader()                                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mPEHeader->optionalHeader.addressOfEntryPoint = mConfigStart;                                                                                                                                             // Colorize: green
    mPEHeader->optionalHeader.sizeOfImage         = mResultImage.size();                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ImageBuilder::updateRelocSection()                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    quint32 offset = mRelocStart;                                                                                                                                                                        // Colorize: green
    quint32 size   = mRelocEnd - mRelocStart;                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    writeUInt32(offset,     offset + 4);                                                                                                                                                                 // Colorize: green
    writeUInt32(offset + 4, 123456789);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    SectionHeader &section = mPEHeader->sections[(quint64)Section::RELOC];                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    section.virtualSize      = size;                                                                                                                                                                     // Colorize: green
    section.virtualAddress   = offset;                                                                                                                                                                   // Colorize: green
    section.sizeOfRawData    = size;                                                                                                                                                                     // Colorize: green
    section.pointerToRawData = offset;                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ImageBuilder::updateConfigSection()                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    quint32 offset = mConfigStart;                                                                                                                                                                       // Colorize: green
    quint32 size   = mConfigEnd - mConfigStart;                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    SectionHeader &section = mPEHeader->sections[(quint64)Section::CONFIG];                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    section.virtualSize      = size;                                                                                                                                                                     // Colorize: green
    section.virtualAddress   = offset;                                                                                                                                                                   // Colorize: green
    section.sizeOfRawData    = size;                                                                                                                                                                     // Colorize: green
    section.pointerToRawData = offset;                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (mTextElfPath != "")                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        *reinterpret_cast<quint64 *>(section.name) = TEXT_SECTION_NAME;                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool ImageBuilder::updateKernelSection()                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    SectionHeader &section = mPEHeader->sections[(quint64)Section::KERNEL];                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (mTextElfPath == "")                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        quint32 offset = mKernelStart;                                                                                                                                                                   // Colorize: green
        quint32 size   = mKernelEnd - mKernelStart;                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        section.virtualSize      = size;                                                                                                                                                                 // Colorize: green
        section.virtualAddress   = offset;                                                                                                                                                               // Colorize: green
        section.sizeOfRawData    = size;                                                                                                                                                                 // Colorize: green
        section.pointerToRawData = offset;                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        memset(&section, 0, sizeof(SectionHeader));                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        --mPEHeader->coffHeader.numberOfSections;                                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return true;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
quint8 ImageBuilder::readUInt8(qint64 offset)                                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return *reinterpret_cast<quint8 *>(mResultImage.data() + offset);                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
quint16 ImageBuilder::readUInt16(qint64 offset)                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return *reinterpret_cast<quint16 *>(mResultImage.data() + offset);                                                                                                                                                   // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
quint32 ImageBuilder::readUInt32(qint64 offset)                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return *reinterpret_cast<quint32 *>(mResultImage.data() + offset);                                                                                                                                                   // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
quint64 ImageBuilder::readUInt64(qint64 offset)                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    return *reinterpret_cast<quint64 *>(mResultImage.data() + offset);                                                                                                                                                   // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void ImageBuilder::writeUInt8(qint64 offset, quint8 value)                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    *reinterpret_cast<quint8 *>(mResultImage.data() + offset) = value;                                                                                                                                                   // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void ImageBuilder::writeUInt16(qint64 offset, quint16 value)                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    *reinterpret_cast<quint16 *>(mResultImage.data() + offset) = value;                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void ImageBuilder::writeUInt32(qint64 offset, quint32 value)                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    *reinterpret_cast<quint32 *>(mResultImage.data() + offset) = value;                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void ImageBuilder::writeUInt64(qint64 offset, quint64 value)                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    *reinterpret_cast<quint64 *>(mResultImage.data() + offset) = value;                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
