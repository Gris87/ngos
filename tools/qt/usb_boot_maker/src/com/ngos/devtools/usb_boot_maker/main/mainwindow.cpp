#include "mainwindow.h"                                                                                                                                                                                  // Colorize: green
#include "usb_boot_maker/ui/ui_mainwindow.h"                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QActionGroup>                                                                                                                                                                                  // Colorize: green
#include <QDateTime>                                                                                                                                                                                     // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QDir>                                                                                                                                                                                          // Colorize: green
#include <QJsonArray>                                                                                                                                                                                    // Colorize: green
#include <QJsonDocument>                                                                                                                                                                                 // Colorize: green
#include <QJsonObject>                                                                                                                                                                                   // Colorize: green
#include <QMessageBox>                                                                                                                                                                                   // Colorize: green
#include <QNetworkRequest>                                                                                                                                                                               // Colorize: green
#include <QProcess>                                                                                                                                                                                      // Colorize: green
#include <QSettings>                                                                                                                                                                                     // Colorize: green
#include <QUrl>                                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/usb_boot_maker/main/aboutdialog.h>                                                                                                                                           // Colorize: green
#include <com/ngos/shared/common/macro/applications.h>                                                                                                                                                   // Colorize: green
#include <com/ngos/shared/common/macro/servers.h>                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define PROGRESS_BAR_INITIAL 5                                                                                                                                                                           // Colorize: green
#define PROGRESS_BAR_BURNING 40                                                                                                                                                                          // Colorize: green
#define PROGRESS_BAR_MAXIMUM 100                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
const QStringList servers =                                                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    NGOS_MASTER_SERVER                                                                                                                                                                                   // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
const QStringList applications =                                                                                                                                                                         // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    NGOS_APPLICATION_BOOTLOADER,                                                                                                                                                                         // Colorize: green
    NGOS_APPLICATION_INSTALLER                                                                                                                                                                           // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
MainWindow::MainWindow(QWidget *parent)                                                                                                                                                                  // Colorize: green
    : QMainWindow(parent)                                                                                                                                                                                // Colorize: green
    , ui(new Ui::MainWindow())                                                                                                                                                                           // Colorize: green
    , mTranslator(new QTranslator(this))                                                                                                                                                                 // Colorize: green
    , mUpdateTimer(new QTimer(this))                                                                                                                                                                     // Colorize: green
    , mManager(new QNetworkAccessManager(this))                                                                                                                                                          // Colorize: green
    , mTemporaryDir(nullptr)                                                                                                                                                                             // Colorize: green
    , mBurnThread(nullptr)                                                                                                                                                                               // Colorize: green
#ifdef Q_OS_LINUX                                                                                                                                                                                        // Colorize: green
    , mUsbMonitorThread(new UsbMonitorThread())                                                                                                                                                          // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
    , mState(UsbBootMakerState::INITIAL)                                                                                                                                                                 // Colorize: green
    , mRequestTime(0)                                                                                                                                                                                    // Colorize: green
    , mReplies()                                                                                                                                                                                         // Colorize: green
    , mLatestVersions()                                                                                                                                                                                  // Colorize: green
    , mSelectedVersionInfo()                                                                                                                                                                             // Colorize: green
    , mCurrentApplication(0)                                                                                                                                                                             // Colorize: green
    , mVersionFiles()                                                                                                                                                                                    // Colorize: green
    , mLanguage()                                                                                                                                                                                        // Colorize: green
    , mLanguageActions()                                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->setupUi(this);                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Setup mUpdateTimer                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        mUpdateTimer->setSingleShot(true);                                                                                                                                                               // Colorize: green
        connect(mUpdateTimer, SIGNAL(timeout()), this, SLOT(updateUsbDevices()));                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Setup mManager                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        connect(mManager, SIGNAL(sslErrors(QNetworkReply *, const QList<QSslError> &)), this, SLOT(ignoreSslErrors(QNetworkReply *, const QList<QSslError> &)));                                         // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Setup mUsbMonitorThread                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
#ifdef Q_OS_LINUX                                                                                                                                                                                        // Colorize: green
        connect(mUsbMonitorThread, SIGNAL(usbStatusChanged(quint16)), this, SLOT(usbStatusChanged(quint16)));                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mUsbMonitorThread->start();                                                                                                                                                                      // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    prepareLanguages();                                                                                                                                                                                  // Colorize: green
    loadWindowState();                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    updateUsbDevices();                                                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
MainWindow::~MainWindow()                                                                                                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Delete temporary directory                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mTemporaryDir != nullptr)                                                                                                                                                                    // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            delete mTemporaryDir;                                                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Terminate and delete burn thread                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mBurnThread != nullptr)                                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            mBurnThread->blockSignals(true);                                                                                                                                                             // Colorize: green
            mBurnThread->stop();                                                                                                                                                                         // Colorize: green
            mBurnThread->wait();                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            delete mBurnThread;                                                                                                                                                                          // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Terminate and delete USB monitor thread                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
#ifdef Q_OS_LINUX                                                                                                                                                                                        // Colorize: green
        mUsbMonitorThread->blockSignals(true);                                                                                                                                                           // Colorize: green
        mUsbMonitorThread->stop();                                                                                                                                                                       // Colorize: green
        mUsbMonitorThread->wait();                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        delete mUsbMonitorThread;                                                                                                                                                                        // Colorize: green
#endif                                                                                                                                                                                                   // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clear deviceComboBox                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < ui->deviceComboBox->count(); ++i)                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            delete ui->deviceComboBox->itemData(i).value<UsbDeviceInfo *>();                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        ui->deviceComboBox->clear();                                                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    abortReplies();                                                                                                                                                                                      // Colorize: green
    saveWindowState();                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    delete ui;                                                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::on_actionExit_triggered()                                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    close();                                                                                                                                                                                             // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::on_actionAbout_triggered()                                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    AboutDialog dialog(this);                                                                                                                                                                            // Colorize: green
    dialog.exec();                                                                                                                                                                                       // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::on_startButton_clicked()                                                                                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (mState == UsbBootMakerState::INITIAL)                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QString message = tr("Do you really want to format disk \"%1\"?\nAll data on the device will be destroyed!")                                                                                     // Colorize: green
                                .arg(ui->deviceComboBox->currentText());                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        qint64 pressedButton = QMessageBox::warning(this, tr("Format disk"), message, QMessageBox::Ok | QMessageBox::Cancel, QMessageBox::Ok);                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (pressedButton == QMessageBox::Ok)                                                                                                                                                            // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Delete previous temporary directory if exists                                                                                                                                             // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (mTemporaryDir != nullptr)                                                                                                                                                            // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    delete mTemporaryDir;                                                                                                                                                                // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Create new temporary directory                                                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                mTemporaryDir = new QTemporaryDir();                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (!mTemporaryDir->isValid())                                                                                                                                                           // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    addLog(tr("Failed to create temporary directory"));                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    delete mTemporaryDir;                                                                                                                                                                // Colorize: green
                    mTemporaryDir = nullptr;                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return;                                                                                                                                                                              // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            qDebug() << "Downloading to temporary directory:" << mTemporaryDir->path();                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Setup UI controls                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                ui->deviceComboBox->setEnabled(false);                                                                                                                                                   // Colorize: green
                ui->startButton->setIcon(QIcon(":/assets/images/stop.png")); // Ignore CppPunctuationVerifier                                                                                            // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Prepare for first step                                                                                                                                                                    // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                mCurrentApplication = 0;                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                switchToState(UsbBootMakerState::GET_LATEST_VERSION);                                                                                                                                    // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
    else                                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        resetToInitialState();                                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::languageToggled(bool checked)                                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (checked)                                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QAction *action = (QAction *)sender();                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QString language = action->data().toString();                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        qDebug() << "Switching to language:" << language;                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Setup translator with new language                                                                                                                                                            // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (mTranslator->load(":/assets/translations/language_" + language)) // Ignore CppPunctuationVerifier                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                mLanguage = language;                                                                                                                                                                    // Colorize: green
                QApplication::installTranslator(mTranslator);                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                ui->retranslateUi(this);                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                addLog(tr("Language switched to %1")                                                                                                                                                     // Colorize: green
                            .arg(action->text())                                                                                                                                                         // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                addLog(tr("Failed to switch language to %1")                                                                                                                                             // Colorize: green
                            .arg(action->text())                                                                                                                                                         // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::updateUsbDevices()                                                                                                                                                                      // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mUpdateTimer->stop();                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QList<UsbDeviceInfo *> usbDevices;                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get USB devices                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        usbDevices = getUsbDevices();                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        qDebug() << "";                                                                                                                                                                                  // Colorize: green
        qDebug() << "Found devices:" << usbDevices.size();                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        addLog(tr("Found devices: %1")                                                                                                                                                                   // Colorize: green
                    .arg(usbDevices.size())                                                                                                                                                              // Colorize: green
        );                                                                                                                                                                                               // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clear deviceComboBox                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < ui->deviceComboBox->count(); ++i)                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            delete ui->deviceComboBox->itemData(i).value<UsbDeviceInfo *>();                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        ui->deviceComboBox->clear();                                                                                                                                                                     // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Fill deviceComboBox                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < usbDevices.size(); ++i)                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            UsbDeviceInfo *usbDevice = usbDevices.at(i);                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QVariant data;                                                                                                                                                                               // Colorize: green
            data.setValue(usbDevice);                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            ui->deviceComboBox->addItem(usbDevice->title, data);                                                                                                                                         // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    ui->startButton->setEnabled(!usbDevices.isEmpty());                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::usbStatusChanged(quint16 delay)                                                                                                                                                         // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    if (!mUpdateTimer->isActive())                                                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        mUpdateTimer->start(delay);                                                                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::ignoreSslErrors(QNetworkReply *reply, const QList<QSslError> &/*errors*/)                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    reply->ignoreSslErrors();                                                                                                                                                                            // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::latestVersionReplyFinished()                                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QNetworkReply *reply  = (QNetworkReply *)sender();                                                                                                                                                   // Colorize: green
    QString        server = reply->url().host();                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clean up reply                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        reply->deleteLater();                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (mReplies.remove(server) != 1)                                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unknown reply");                                                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Handle reply                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!reply->error())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qint64 delay = QDateTime::currentMSecsSinceEpoch() - mRequestTime;                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QJsonDocument jsonDocument = QJsonDocument::fromJson(reply->readAll());                                                                                                                      // Colorize: green
            QJsonObject   json         = jsonDocument.object();                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (json["status"].toString("") == "OK")                                                                                                                                                     // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QJsonValue version = json["version"];                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (version.isUndefined())                                                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                       // Colorize: green
                                .arg(server)                                                                                                                                                             // Colorize: green
                                .arg(tr("version field absent"))                                                                                                                                         // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QJsonValue versionId   = version["id"];                                                                                                                                              // Colorize: green
                    QJsonValue versionCode = version["version"];                                                                                                                                         // Colorize: green
                    QJsonValue versionHash = version["hash"];                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (versionId.isUndefined())                                                                                                                                                         // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                   // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("id field absent"))                                                                                                                                          // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                    else                                                                                                                                                                                 // Colorize: green
                    if (versionCode.isUndefined())                                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                   // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("version field absent"))                                                                                                                                     // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                    else                                                                                                                                                                                 // Colorize: green
                    if (versionHash.isUndefined())                                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                   // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("hash field absent"))                                                                                                                                        // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                    else                                                                                                                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        // Store version information received from server                                                                                                                                // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            VersionInfo versionInfo;                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            versionInfo.id      = versionId.toVariant().toLongLong();                                                                                                                    // Colorize: green
                            versionInfo.version = versionCode.toVariant().toLongLong();                                                                                                                  // Colorize: green
                            versionInfo.hash    = versionHash.toString("");                                                                                                                              // Colorize: green
                            versionInfo.server  = server;                                                                                                                                                // Colorize: green
                            versionInfo.delay   = delay;                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            mLatestVersions.insert(server, versionInfo);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            addLog(tr("Response received from server %1 in %2 ms. Version: %3")                                                                                                          // Colorize: green
                                        .arg(server)                                                                                                                                                     // Colorize: green
                                        .arg(delay)                                                                                                                                                      // Colorize: green
                                        .arg(versionInfo.version)                                                                                                                                        // Colorize: green
                            );                                                                                                                                                                           // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QString message = json["message"].toString("");                                                                                                                                          // Colorize: green
                QString details = json["details"].toString("");                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                           // Colorize: green
                            .arg(server)                                                                                                                                                                 // Colorize: green
                            .arg(message + (details != "" ? (" (" + details + ')') : ""))                                                                                                                // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addLog(tr("Failed to get information about latest version from server %1: %2")                                                                                                               // Colorize: green
                        .arg(server)                                                                                                                                                                     // Colorize: green
                        .arg(reply->errorString())                                                                                                                                                       // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Switch to next step when all replies are handled                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mReplies.isEmpty())                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                             // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::fileListReplyFinished()                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QNetworkReply *reply  = (QNetworkReply *)sender();                                                                                                                                                   // Colorize: green
    QString        server = reply->url().host();                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clean up reply                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        reply->deleteLater();                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (mReplies.remove(server) != 1)                                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unknown reply");                                                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Handle reply                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!reply->error())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QJsonDocument jsonDocument = QJsonDocument::fromJson(reply->readAll());                                                                                                                      // Colorize: green
            QJsonObject   json         = jsonDocument.object();                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (json["status"].toString("") == "OK")                                                                                                                                                     // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QJsonValue version = json["version"];                                                                                                                                                    // Colorize: green
                QJsonValue files   = json["files"];                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check JSON structure                                                                                                                                                                  // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (version.isUndefined())                                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get file list from server %1: %2")                                                                                                                          // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("version field absent"))                                                                                                                                     // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (files.isUndefined())                                                                                                                                                             // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get file list from server %1: %2")                                                                                                                          // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("files field absent"))                                                                                                                                       // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QJsonValue versionId   = version["id"];                                                                                                                                                  // Colorize: green
                QJsonValue versionCode = version["version"];                                                                                                                                             // Colorize: green
                QJsonValue versionHash = version["hash"];                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check JSON structure                                                                                                                                                                  // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (versionId.isUndefined())                                                                                                                                                         // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get file list from server %1: %2")                                                                                                                          // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("id field absent"))                                                                                                                                          // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (versionCode.isUndefined())                                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get file list from server %1: %2")                                                                                                                          // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("version field absent"))                                                                                                                                     // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (versionHash.isUndefined())                                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to get file list from server %1: %2")                                                                                                                          // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                                    .arg(tr("hash field absent"))                                                                                                                                        // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check that version is still the same                                                                                                                                                  // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (                                                                                                                                                                                 // Colorize: green
                        mSelectedVersionInfo.id != versionId.toVariant().toLongLong()                                                                                                                    // Colorize: green
                        ||                                                                                                                                                                               // Colorize: green
                        mSelectedVersionInfo.version != versionCode.toVariant().toLongLong()                                                                                                             // Colorize: green
                        ||                                                                                                                                                                               // Colorize: green
                        mSelectedVersionInfo.hash != versionHash.toString("")                                                                                                                            // Colorize: green
                       )                                                                                                                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("File list received from server %1 did't match with stored value")                                                                                                     // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QJsonArray filesArray    = files.toArray();                                                                                                                                              // Colorize: green
                quint64    resultHash[2] = { 0, 0 };                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Calculate application hash from files                                                                                                                                                 // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    for (qint64 i = 0; i < filesArray.size(); ++i)                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        QString fileHash = filesArray.at(i)["hash"].toString("");                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        QByteArray fileHashBytes = QByteArray::fromHex(fileHash.toUtf8());                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        if (fileHashBytes.size() != 16)                                                                                                                                                  // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            addLog(tr("File list received from server %1 did't match with stored value")                                                                                                 // Colorize: green
                                        .arg(server)                                                                                                                                                     // Colorize: green
                            );                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            abortReplies();                                                                                                                                                              // Colorize: green
                            switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            return;                                                                                                                                                                      // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        quint64 *fileHashQuads = reinterpret_cast<quint64 *>(fileHashBytes.data());                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        resultHash[0] ^= fileHashQuads[0];                                                                                                                                               // Colorize: green
                        resultHash[1] ^= fileHashQuads[1];                                                                                                                                               // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Check that application hash is the same as stored one                                                                                                                                 // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (mSelectedVersionInfo.hash != QString::fromLatin1(QByteArray((char *)resultHash, 16).toHex()))                                                                                    // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("File list received from server %1 did't match with stored value")                                                                                                     // Colorize: green
                                    .arg(server)                                                                                                                                                         // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                mVersionFiles.clear();                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                // Fill list of files                                                                                                                                                                    // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    for (qint64 i = 0; i < filesArray.size(); ++i)                                                                                                                                       // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        QJsonValue file = filesArray.at(i);                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        QJsonValue fileDownloadName = file["download_name"];                                                                                                                             // Colorize: green
                        QJsonValue fileFileName     = file["filename"];                                                                                                                                  // Colorize: green
                        QJsonValue fileHash         = file["hash"];                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        // Check JSON structure                                                                                                                                                          // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            if (fileDownloadName.isUndefined())                                                                                                                                          // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                addLog(tr("Failed to get file list from server %1: %2")                                                                                                                  // Colorize: green
                                            .arg(server)                                                                                                                                                 // Colorize: green
                                            .arg(tr("download_name field absent"))                                                                                                                       // Colorize: green
                                );                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                abortReplies();                                                                                                                                                          // Colorize: green
                                switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                return;                                                                                                                                                                  // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            if (fileFileName.isUndefined())                                                                                                                                              // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                addLog(tr("Failed to get file list from server %1: %2")                                                                                                                  // Colorize: green
                                            .arg(server)                                                                                                                                                 // Colorize: green
                                            .arg(tr("filename field absent"))                                                                                                                            // Colorize: green
                                );                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                abortReplies();                                                                                                                                                          // Colorize: green
                                switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                return;                                                                                                                                                                  // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            if (fileHash.isUndefined())                                                                                                                                                  // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                addLog(tr("Failed to get file list from server %1: %2")                                                                                                                  // Colorize: green
                                            .arg(server)                                                                                                                                                 // Colorize: green
                                            .arg(tr("hash field absent"))                                                                                                                                // Colorize: green
                                );                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                abortReplies();                                                                                                                                                          // Colorize: green
                                switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                return;                                                                                                                                                                  // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        // Store file information                                                                                                                                                        // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            FileInfo fileInfo;                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            fileInfo.downloadName = fileDownloadName.toString("");                                                                                                                       // Colorize: green
                            fileInfo.fileName     = fileFileName.toString("");                                                                                                                           // Colorize: green
                            fileInfo.hash         = fileHash.toString("");                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            mVersionFiles.append(fileInfo);                                                                                                                                              // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                addLog(tr("File list received from server %1")                                                                                                                                           // Colorize: green
                            .arg(server)                                                                                                                                                                 // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QString message = json["message"].toString("");                                                                                                                                          // Colorize: green
                QString details = json["details"].toString("");                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                addLog(tr("Failed to get file list from server %1: %2")                                                                                                                                  // Colorize: green
                            .arg(server)                                                                                                                                                                 // Colorize: green
                            .arg(message + (details != "" ? (" (" + details + ')') : ""))                                                                                                                // Colorize: green
                );                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                abortReplies();                                                                                                                                                                          // Colorize: green
                switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addLog(tr("Failed to get file list from server %1: %2")                                                                                                                                      // Colorize: green
                        .arg(server)                                                                                                                                                                     // Colorize: green
                        .arg(reply->errorString())                                                                                                                                                       // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            abortReplies();                                                                                                                                                                              // Colorize: green
            switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Switch to next step when all replies are handled                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mReplies.isEmpty())                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            switchToState(UsbBootMakerState::DOWNLOAD);                                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::downloadReplyFinished()                                                                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QNetworkReply *reply    = (QNetworkReply *)sender();                                                                                                                                                 // Colorize: green
    QString        server   = reply->url().host();                                                                                                                                                       // Colorize: green
    FileInfo      *fileInfo = reply->property("fileInfo").value<FileInfo *>();                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clean up reply                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        reply->deleteLater();                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (mReplies.remove(fileInfo->fileName) != 1)                                                                                                                                                    // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unknown reply");                                                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Handle reply                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!reply->error())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addLog(tr("Downloaded file %1 from server %2")                                                                                                                                               // Colorize: green
                        .arg(fileInfo->fileName)                                                                                                                                                         // Colorize: green
                        .arg(server)                                                                                                                                                                     // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString applicationDir = mTemporaryDir->path() + '/' + applications.at(mCurrentApplication);                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Create folder for downloaded file                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qint64 index = fileInfo->fileName.lastIndexOf('/');                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (index < 0)                                                                                                                                                                           // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    index = 0;                                                                                                                                                                           // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (!QDir().mkpath(applicationDir + '/' + fileInfo->fileName.left(index)))                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    addLog(tr("Failed to store file %1")                                                                                                                                                 // Colorize: green
                                .arg(fileInfo->fileName)                                                                                                                                                 // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    abortReplies();                                                                                                                                                                      // Colorize: green
                    switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return;                                                                                                                                                                              // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QByteArray content  = reply->readAll();                                                                                                                                                      // Colorize: green
            QString    filePath = applicationDir + '/' + fileInfo->fileName;                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Create file                                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QFile file(filePath);                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (file.open(QIODevice::WriteOnly))                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (file.write(content) != content.size())                                                                                                                                           // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        file.close();                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        addLog(tr("Failed to store file %1")                                                                                                                                             // Colorize: green
                                    .arg(fileInfo->fileName)                                                                                                                                             // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    file.close();                                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    addLog(tr("Failed to store file %1")                                                                                                                                                 // Colorize: green
                                .arg(fileInfo->fileName)                                                                                                                                                 // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    abortReplies();                                                                                                                                                                      // Colorize: green
                    switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return;                                                                                                                                                                              // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Decompress file                                                                                                                                                                           // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (fileInfo->downloadName.endsWith(".xz"))                                                                                                                                              // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QProcess process;                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    process.start("xzcat", QStringList() << filePath, QIODevice::ReadOnly);                                                                                                              // Colorize: green
                    process.waitForFinished(-1);                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (process.exitCode() == 0)                                                                                                                                                         // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        content = process.readAllStandardOutput();                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        // Create file                                                                                                                                                                   // Colorize: green
                        {                                                                                                                                                                                // Colorize: green
                            QFile file(filePath);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                            if (file.open(QIODevice::WriteOnly))                                                                                                                                         // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                if (file.write(content) != content.size())                                                                                                                               // Colorize: green
                                {                                                                                                                                                                        // Colorize: green
                                    file.close();                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                    addLog(tr("Failed to store file %1")                                                                                                                                 // Colorize: green
                                                .arg(fileInfo->fileName)                                                                                                                                 // Colorize: green
                                    );                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                    abortReplies();                                                                                                                                                      // Colorize: green
                                    switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                    return;                                                                                                                                                              // Colorize: green
                                }                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                file.close();                                                                                                                                                            // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                            else                                                                                                                                                                         // Colorize: green
                            {                                                                                                                                                                            // Colorize: green
                                addLog(tr("Failed to store file %1")                                                                                                                                     // Colorize: green
                                            .arg(fileInfo->fileName)                                                                                                                                     // Colorize: green
                                );                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                abortReplies();                                                                                                                                                          // Colorize: green
                                switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                return;                                                                                                                                                                  // Colorize: green
                            }                                                                                                                                                                            // Colorize: green
                        }                                                                                                                                                                                // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                    else                                                                                                                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        addLog(tr("Failed to decompress file %1")                                                                                                                                        // Colorize: green
                                    .arg(fileInfo->fileName)                                                                                                                                             // Colorize: green
                        );                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        abortReplies();                                                                                                                                                                  // Colorize: green
                        switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                if (!fileInfo->downloadName.endsWith(".raw"))                                                                                                                                            // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qFatal("Unknown file format");                                                                                                                                                       // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Check file MD5 hash                                                                                                                                                                       // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QCryptographicHash hash(QCryptographicHash::Md5);                                                                                                                                        // Colorize: green
                hash.addData(content);                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (fileInfo->hash != QString::fromLatin1(hash.result().toHex()))                                                                                                                        // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    addLog(tr("Failed to store file %1")                                                                                                                                                 // Colorize: green
                                .arg(fileInfo->fileName)                                                                                                                                                 // Colorize: green
                    );                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    abortReplies();                                                                                                                                                                      // Colorize: green
                    switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    return;                                                                                                                                                                              // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            addLog(tr("Failed to download file %1 from server %2: %3")                                                                                                                                   // Colorize: green
                        .arg(fileInfo->fileName)                                                                                                                                                         // Colorize: green
                        .arg(server)                                                                                                                                                                     // Colorize: green
                        .arg(reply->errorString())                                                                                                                                                       // Colorize: green
            );                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            abortReplies();                                                                                                                                                                              // Colorize: green
            switchToState(UsbBootMakerState::GET_FILE_LIST);                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Switch to next step when all replies are handled                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mReplies.isEmpty())                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            ++mCurrentApplication;                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (mCurrentApplication >= applications.size())                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                switchToState(UsbBootMakerState::BURNING);                                                                                                                                               // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                switchToState(UsbBootMakerState::GET_LATEST_VERSION);                                                                                                                                    // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::burnFinished()                                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    delete mBurnThread;                                                                                                                                                                                  // Colorize: green
    mBurnThread = nullptr;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    switchToInitialState();                                                                                                                                                                              // Colorize: green
    addLog(tr("Done"));                                                                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::burnProgress(quint8 current, quint8 maximum)                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->statusProgressBar->setValue(PROGRESS_BAR_BURNING + (PROGRESS_BAR_MAXIMUM - PROGRESS_BAR_BURNING) * current / maximum);                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::addLog(const QString &text)                                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->logTextEdit->append(text);                                                                                                                                                                       // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::prepareLanguages()                                                                                                                                                                      // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QActionGroup *group = new QActionGroup(this);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Fill menu with the list of languages from assets                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QStringList languages = QDir(":/assets/translations").entryList(); // Ignore CppPunctuationVerifier                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 0; i < languages.size(); ++i)                                                                                                                                                    // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString language = languages.at(i);                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Get language code from file name                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (language.endsWith(".qm"))                                                                                                                                                            // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    language.remove(language.length() - 3, 3);                                                                                                                                           // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qFatal("Invalid file located in assets/translations folder: %s", language.toUtf8().constData());                                                                                   // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (language.startsWith("language_"))                                                                                                                                                    // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    language.remove(0, 9);                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qFatal("Invalid file located in assets/translations folder: %s", language.toUtf8().constData());                                                                                   // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QString languageName = QLocale(language).nativeLanguageName();                                                                                                                               // Colorize: green
            languageName[0]      = languageName.at(0).toUpper();                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            qDebug() << "Adding language:" << language << '|' << languageName;                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Create menu item with language                                                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QAction *languageItem = new QAction(languageName, this);                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                languageItem->setCheckable(true);                                                                                                                                                        // Colorize: green
                languageItem->setActionGroup(group);                                                                                                                                                     // Colorize: green
                languageItem->setData(language);                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                connect(languageItem, SIGNAL(toggled(bool)), this, SLOT(languageToggled(bool)));                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                ui->menuLanguage->addAction(languageItem);                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                mLanguageActions.insert(language, languageItem);                                                                                                                                         // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::switchToState(UsbBootMakerState state)                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mState = state;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    switch (mState)                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        case UsbBootMakerState::GET_LATEST_VERSION: handleGetLatestVersionState(); break;                                                                                                                // Colorize: green
        case UsbBootMakerState::GET_FILE_LIST:      handleGetFileListState();      break;                                                                                                                // Colorize: green
        case UsbBootMakerState::DOWNLOAD:           handleDownloadState();         break;                                                                                                                // Colorize: green
        case UsbBootMakerState::BURNING:            handleBurningState();          break;                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        case UsbBootMakerState::INITIAL:                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unexpected state %s", enumToFullString(mState));                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        default:                                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unknown state %s", enumToFullString(mState));                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::handleGetLatestVersionState()                                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->statusProgressBar->setValue(PROGRESS_BAR_INITIAL + (PROGRESS_BAR_BURNING - PROGRESS_BAR_INITIAL) * (0 + mCurrentApplication * 3) / applications.size() / 3);                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString application = applications.at(mCurrentApplication);                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    addLog("");                                                                                                                                                                                          // Colorize: green
    addLog(tr("Getting information about latest version of %1 from servers")                                                                                                                             // Colorize: green
                .arg(application)                                                                                                                                                                        // Colorize: green
    );                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    mLatestVersions.clear();                                                                                                                                                                             // Colorize: green
    mRequestTime = QDateTime::currentMSecsSinceEpoch();                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Send requests to servers in order to obtain latest application version from them                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < servers.size(); ++i)                                                                                                                                                      // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            const QString &server = servers.at(i);                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QNetworkReply *reply;                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Send network request                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QString url = QString("https://%1/rest/app_versions.php?codename=%2&version=latest&include_files=false")                                                                                 // Colorize: green
                                        .arg(server)                                                                                                                                                     // Colorize: green
                                        .arg(application);                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QNetworkRequest request;                                                                                                                                                                 // Colorize: green
                request.setUrl(QUrl(url));                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                reply = mManager->get(request);                                                                                                                                                          // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            connect(reply, SIGNAL(finished()), this, SLOT(latestVersionReplyFinished()));                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mReplies.insert(server, reply);                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::handleGetFileListState()                                                                                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->statusProgressBar->setValue(PROGRESS_BAR_INITIAL + (PROGRESS_BAR_BURNING - PROGRESS_BAR_INITIAL) * (1 + mCurrentApplication * 3) / applications.size() / 3);                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Terminate if no response received from any server                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (mLatestVersions.isEmpty())                                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            switchToInitialState();                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            addLog(tr("Latest version is unavailable"));                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QHash<qint64, QList<const VersionInfo *>> versionGroups; // Version => Group of version infos                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Fill versionGroups                                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QHashIterator<QString, VersionInfo> it(mLatestVersions);                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        while (it.hasNext())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            it.next();                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            const VersionInfo *versionInfo = &it.value();                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            versionGroups[versionInfo->version].append(versionInfo);                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    const QList<const VersionInfo *> *generalGroup = nullptr;                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Find version that more spread among servers                                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        qint64 max = 0;                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QHashIterator<qint64, QList<const VersionInfo *>> it(versionGroups);                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        while (it.hasNext())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            it.next();                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            const QList<const VersionInfo *> *versions = &it.value();                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Check that all versions are the same                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                const VersionInfo *firstVersionInfo = versions->constFirst();                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                for (qint64 j = 1; j < versions->size(); ++j)                                                                                                                                            // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    const VersionInfo *versionInfo = versions->at(j);                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (                                                                                                                                                                                 // Colorize: green
                        versionInfo->id != firstVersionInfo->id                                                                                                                                          // Colorize: green
                        ||                                                                                                                                                                               // Colorize: green
                        versionInfo->version != firstVersionInfo->version                                                                                                                                // Colorize: green
                        ||                                                                                                                                                                               // Colorize: green
                        versionInfo->hash != firstVersionInfo->hash                                                                                                                                      // Colorize: green
                       )                                                                                                                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        switchToInitialState();                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        addLog(tr("Database is broken"));                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        return;                                                                                                                                                                          // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (versions->size() > max)                                                                                                                                                                  // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                max          = versions->size();                                                                                                                                                         // Colorize: green
                generalGroup = versions;                                                                                                                                                                 // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Find server with the minimum delay                                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        const VersionInfo *selectedVersionInfo = generalGroup->constFirst();                                                                                                                             // Colorize: green
        qint64             min                 = selectedVersionInfo->delay;                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = 1; i < generalGroup->size(); ++i)                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (generalGroup->at(i)->delay < min)                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                selectedVersionInfo = generalGroup->at(i);                                                                                                                                               // Colorize: green
                min                 = selectedVersionInfo->delay;                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mSelectedVersionInfo = *selectedVersionInfo;                                                                                                                                                     // Colorize: green
        mLatestVersions.remove(mSelectedVersionInfo.server);                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Send request to server in order to get list of files                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QNetworkReply *reply;                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Send network request                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString url = QString("https://%1/rest/app_versions.php?codename=%2&version=%3&include_files=true")                                                                                          // Colorize: green
                                    .arg(mSelectedVersionInfo.server)                                                                                                                                    // Colorize: green
                                    .arg(applications.at(mCurrentApplication))                                                                                                                           // Colorize: green
                                    .arg(mSelectedVersionInfo.version);                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QNetworkRequest request;                                                                                                                                                                     // Colorize: green
            request.setUrl(QUrl(url));                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            reply = mManager->get(request);                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        connect(reply, SIGNAL(finished()), this, SLOT(fileListReplyFinished()));                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mReplies.insert(mSelectedVersionInfo.server, reply);                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::handleDownloadState()                                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->statusProgressBar->setValue(PROGRESS_BAR_INITIAL + (PROGRESS_BAR_BURNING - PROGRESS_BAR_INITIAL) * (2 + mCurrentApplication * 3) / applications.size() / 3);                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Send requests to server in order to download files                                                                                                                                                // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < mVersionFiles.size(); ++i)                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            FileInfo *fileInfo = &mVersionFiles[i];                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QNetworkReply *reply;                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Send network request                                                                                                                                                                      // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QString url = QString("https://%1/downloads/%2")                                                                                                                                         // Colorize: green
                                        .arg(mSelectedVersionInfo.server)                                                                                                                                // Colorize: green
                                        .arg(fileInfo->downloadName);                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                QNetworkRequest request;                                                                                                                                                                 // Colorize: green
                request.setUrl(QUrl(url));                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                reply = mManager->get(request);                                                                                                                                                          // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            connect(reply, SIGNAL(finished()), this, SLOT(downloadReplyFinished()));                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QVariant data;                                                                                                                                                                               // Colorize: green
            data.setValue(fileInfo);                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            reply->setProperty("fileInfo", data);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            mReplies.insert(fileInfo->fileName, reply);                                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::handleBurningState()                                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    ui->statusProgressBar->setValue(PROGRESS_BAR_BURNING);                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    addLog("");                                                                                                                                                                                          // Colorize: green
    addLog(tr("Making bootable USB flash drive on disk \"%1\"")                                                                                                                                          // Colorize: green
                .arg(ui->deviceComboBox->currentText())                                                                                                                                                  // Colorize: green
    );                                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Create and start burn thread                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        mBurnThread = new BurnThread(ui->deviceComboBox->currentData().value<UsbDeviceInfo *>(), mTemporaryDir->path());                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        connect(mBurnThread, SIGNAL(logAdded(const QString &)), this, SLOT(addLog(const QString &)));                                                                                                    // Colorize: green
        connect(mBurnThread, SIGNAL(progress(quint8, quint8)),  this, SLOT(burnProgress(quint8, quint8)));                                                                                               // Colorize: green
        connect(mBurnThread, SIGNAL(finished()),                this, SLOT(burnFinished()));                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mBurnThread->start();                                                                                                                                                                            // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::resetToInitialState()                                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    addLog(tr("Operation terminated by user"));                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    switch (mState)                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        case UsbBootMakerState::GET_LATEST_VERSION:                                                                                                                                                      // Colorize: green
        case UsbBootMakerState::GET_FILE_LIST:                                                                                                                                                           // Colorize: green
        case UsbBootMakerState::DOWNLOAD:                                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            abortReplies();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        case UsbBootMakerState::BURNING:                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            mBurnThread->blockSignals(true);                                                                                                                                                             // Colorize: green
            mBurnThread->stop();                                                                                                                                                                         // Colorize: green
            mBurnThread->wait();                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            delete mBurnThread;                                                                                                                                                                          // Colorize: green
            mBurnThread = nullptr;                                                                                                                                                                       // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        case UsbBootMakerState::INITIAL:                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unexpected state %s", enumToFullString(mState));                                                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        default:                                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qFatal("Unknown state %s", enumToFullString(mState));                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        break;                                                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    switchToInitialState();                                                                                                                                                                              // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::abortReplies()                                                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Iterate over replies and abort them                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QHashIterator<QString, QNetworkReply *> it(mReplies);                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        while (it.hasNext())                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            it.next();                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QNetworkReply *reply = it.value();                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            reply->blockSignals(true);                                                                                                                                                                   // Colorize: green
            reply->abort();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            reply->deleteLater();                                                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    mReplies.clear();                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::switchToInitialState()                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    mState = UsbBootMakerState::INITIAL;                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Setup UI controls                                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        ui->statusProgressBar->setValue(0);                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        ui->deviceComboBox->setEnabled(true);                                                                                                                                                            // Colorize: green
        ui->startButton->setIcon(QIcon(":/assets/images/start.png")); // Ignore CppPunctuationVerifier                                                                                                   // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::saveWindowState()                                                                                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QSettings settings("NGOS", "usb_boot_maker");                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Save settings                                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        settings.setValue("Language",               mLanguage);                                                                                                                                          // Colorize: green
        settings.setValue("MainWindow/geometry",    saveGeometry());                                                                                                                                     // Colorize: green
        settings.setValue("MainWindow/windowState", saveState());                                                                                                                                        // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void MainWindow::loadWindowState()                                                                                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QSettings settings("NGOS", "usb_boot_maker");                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Load settings                                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        // Ignore CppAlignmentVerifier [BEGIN]                                                                                                                                                           // Colorize: green
        mLanguage =     settings.value("Language", QLocale::system().name()).toString(); // Ignore CppEqualAlignmentVerifier                                                                             // Colorize: green
        restoreGeometry(settings.value("MainWindow/geometry").toByteArray());                                                                                                                            // Colorize: green
        restoreState(   settings.value("MainWindow/windowState").toByteArray());                                                                                                                         // Colorize: green
        // Ignore CppAlignmentVerifier [END]                                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Mark selected language menu item                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        mLanguage = mLanguage.left(mLanguage.indexOf('_'));                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!mLanguageActions.contains(mLanguage))                                                                                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            mLanguage = "en";                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        mLanguageActions.value(mLanguage)->setChecked(true);                                                                                                                                             // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
