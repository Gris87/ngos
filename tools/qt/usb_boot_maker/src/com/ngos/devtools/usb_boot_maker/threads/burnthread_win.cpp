#include "burnthread.h"                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#ifdef Q_OS_WIN                                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <QCoreApplication>                                                                                                                                                                              // Colorize: green
#include <QDebug>                                                                                                                                                                                        // Colorize: green
#include <QFile>                                                                                                                                                                                         // Colorize: green
#include <Windows.h>                                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#include <com/ngos/devtools/usb_boot_maker/other/defines.h>                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define ZERO_SIZE 0                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define DISK_ACCESS_RETRIES 150                                                                                                                                                                          // Colorize: green
#define DISK_ACCESS_TIMEOUT 100                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define WRITE_RETRIES 100                                                                                                                                                                                // Colorize: green
#define WRITE_TIMEOUT 100                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define CHECK_IF_THREAD_TERMINATED(thread) \
    if (!thread->isWorking()) \
    { \
        goto out; \
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#define CHECK_IF_TERMINATED() \
    if (!mIsRunning) \
    { \
        return; \
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
enum class LockDisk: quint8 // Ignore CppEnumVerifier                                                                                                                                                    // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    NO,                                                                                                                                                                                                  // Colorize: green
    YES                                                                                                                                                                                                  // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
enum class Access: quint8 // Ignore CppEnumVerifier                                                                                                                                                      // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    READ_ONLY,                                                                                                                                                                                           // Colorize: green
    READ_WRITE                                                                                                                                                                                           // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
enum class ShareWrite: quint8 // Ignore CppEnumVerifier                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    NO,                                                                                                                                                                                                  // Colorize: green
    YES                                                                                                                                                                                                  // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
enum class FILE_SYSTEM_CALLBACK_COMMAND: quint8 // Ignore CppEnumVerifier                                                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    FCC_PROGRESS,                                                                                                                                                                                        // Colorize: green
    FCC_DONE_WITH_STRUCTURE,                                                                                                                                                                             // Colorize: green
    FCC_UNKNOWN2,                                                                                                                                                                                        // Colorize: green
    FCC_INCOMPATIBLE_FILE_SYSTEM,                                                                                                                                                                        // Colorize: green
    FCC_UNKNOWN4,                                                                                                                                                                                        // Colorize: green
    FCC_UNKNOWN5,                                                                                                                                                                                        // Colorize: green
    FCC_ACCESS_DENIED,                                                                                                                                                                                   // Colorize: green
    FCC_MEDIA_WRITE_PROTECTED,                                                                                                                                                                           // Colorize: green
    FCC_VOLUME_IN_USE,                                                                                                                                                                                   // Colorize: green
    FCC_CANT_QUICK_FORMAT,                                                                                                                                                                               // Colorize: green
    FCC_UNKNOWNA,                                                                                                                                                                                        // Colorize: green
    FCC_DONE,                                                                                                                                                                                            // Colorize: green
    FCC_BAD_LABEL,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWND,                                                                                                                                                                                        // Colorize: green
    FCC_OUTPUT,                                                                                                                                                                                          // Colorize: green
    FCC_STRUCTURE_PROGRESS,                                                                                                                                                                              // Colorize: green
    FCC_CLUSTER_SIZE_TOO_SMALL,                                                                                                                                                                          // Colorize: green
    FCC_CLUSTER_SIZE_TOO_BIG,                                                                                                                                                                            // Colorize: green
    FCC_VOLUME_TOO_SMALL,                                                                                                                                                                                // Colorize: green
    FCC_VOLUME_TOO_BIG,                                                                                                                                                                                  // Colorize: green
    FCC_NO_MEDIA_IN_DRIVE,                                                                                                                                                                               // Colorize: green
    FCC_UNKNOWN15,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN16,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN17,                                                                                                                                                                                       // Colorize: green
    FCC_DEVICE_NOT_READY,                                                                                                                                                                                // Colorize: green
    FCC_CHECKDISK_PROGRESS,                                                                                                                                                                              // Colorize: green
    FCC_UNKNOWN1A,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN1B,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN1C,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN1D,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN1E,                                                                                                                                                                                       // Colorize: green
    FCC_UNKNOWN1F,                                                                                                                                                                                       // Colorize: green
    FCC_READ_ONLY_MODE                                                                                                                                                                                   // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
// Redefine VOLUME_DISK_EXTENTS from winioctl.h with more space for extents                                                                                                                              // Colorize: green
struct VOLUME_DISK_EXTENTS_REDEF                                                                                                                                                                         // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    DWORD       numberOfDiskExtents;                                                                                                                                                                     // Colorize: green
    DISK_EXTENT extents[8];                                                                                                                                                                              // Colorize: green
};                                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
// Ignore CppAlignmentVerifier [BEGIN]                                                                                                                                                                   // Colorize: green
typedef bool (__stdcall *FILE_SYSTEM_CALLBACK)(                                                                                                                                                          // Colorize: green
    FILE_SYSTEM_CALLBACK_COMMAND command,                                                                                                                                                                // Colorize: green
    ULONG                        action,                                                                                                                                                                 // Colorize: green
    PVOID                        pData                                                                                                                                                                   // Colorize: green
);                                                                                                                                                                                                       // Colorize: green
// Ignore CppAlignmentVerifier [END]                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
// Ignore CppAlignmentVerifier [BEGIN]                                                                                                                                                                   // Colorize: green
typedef long long int (WINAPI *FormatEx_t)(                                                                                                                                                              // Colorize: green
    WCHAR                *driveRoot,                                                                                                                                                                     // Colorize: green
    MEDIA_TYPE            mediaType,                                                                                                                                                                     // Colorize: green
    WCHAR                *fileSystemTypeName,                                                                                                                                                            // Colorize: green
    WCHAR                *label,                                                                                                                                                                         // Colorize: green
    BOOL                  quickFormat,                                                                                                                                                                   // Colorize: green
    ULONG                 desiredUnitAllocationSize,                                                                                                                                                     // Colorize: green
    FILE_SYSTEM_CALLBACK  callback                                                                                                                                                                       // Colorize: green
);                                                                                                                                                                                                       // Colorize: green
// Ignore CppAlignmentVerifier [END]                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
const GUID PARTITION_BASIC_DATA_GUID = { 0xEBD0A0A2L, 0xB9E5, 0x4433, { 0x87, 0xC0, 0x68, 0xB6, 0xB7, 0x26, 0x99, 0xC7 } };                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QString getPhysicalName(BurnThread *thread)                                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return "\\\\.\\PhysicalDrive" + QString::number(thread->getSelectedUsb().diskNumber);                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QString getLogicalName(BurnThread *thread)                                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString res;                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    char   volumeName[MAX_PATH];                                                                                                                                                                         // Colorize: green
    HANDLE volumeHandle = INVALID_HANDLE_VALUE;                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    do                                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        // Iterate over volumes                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (volumeHandle == INVALID_HANDLE_VALUE)                                                                                                                                                    // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                volumeHandle = FindFirstVolumeA(volumeName, sizeof(volumeName));                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                if (volumeHandle == INVALID_HANDLE_VALUE)                                                                                                                                                // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qCritical() << "FindFirstVolume failed:" << GetLastError();                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    thread->stop();                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (!FindNextVolumeA(volumeHandle, volumeName, sizeof(volumeName)))                                                                                                                      // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qCritical() << "FindNextVolume failed:" << GetLastError();                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    thread->stop();                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        size_t len          = strlen(volumeName);                                                                                                                                                        // Colorize: green
        volumeName[len - 1] = 0;                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        HANDLE deviceHandle;                                                                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Open volume as file                                                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            deviceHandle = CreateFileA(volumeName, GENERIC_READ, FILE_SHARE_READ | FILE_SHARE_WRITE, nullptr, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, nullptr);                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (deviceHandle == INVALID_HANDLE_VALUE)                                                                                                                                                    // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "CreateFile failed:" << GetLastError();                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                continue;                                                                                                                                                                                // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Check that current volume related to USB device. If it so then take volume name                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            VOLUME_DISK_EXTENTS_REDEF diskExtents;                                                                                                                                                       // Colorize: green
            DWORD                     size;                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (DeviceIoControl(deviceHandle, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, nullptr, ZERO_SIZE, &diskExtents, sizeof(diskExtents), &size, nullptr))                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if ((diskExtents.numberOfDiskExtents >= 1) && (diskExtents.extents[0].DiskNumber == thread->getSelectedUsb().diskNumber))                                                                // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    res = volumeName;                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "DeviceIoControl failed:" << GetLastError();                                                                                                                              // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Close file                                                                                                                                                                                    // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (!CloseHandle(deviceHandle))                                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "CloseHandle failed:" << GetLastError();                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                continue;                                                                                                                                                                                // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (res != "")                                                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    } while(true);                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Terminate volume iteration                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (volumeHandle != INVALID_HANDLE_VALUE)                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (!FindVolumeClose(volumeHandle))                                                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "FindVolumeClose failed:" << GetLastError();                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                thread->stop();                                                                                                                                                                          // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return res;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
HANDLE getHandle(BurnThread *thread, const QString &path, LockDisk lockDisk, Access writeAccess, ShareWrite shareWrite)                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    HANDLE res = INVALID_HANDLE_VALUE;                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Try to get access to disk                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < DISK_ACCESS_RETRIES && thread->isWorking(); ++i)                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            // Open disk as file                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                // Ignore CppAlignmentVerifier [BEGIN]                                                                                                                                                   // Colorize: green
                res = CreateFileA(path.toLatin1().data()                                                                                                                                                 // Colorize: green
                                    , GENERIC_READ    | (writeAccess == Access::READ_WRITE ? GENERIC_WRITE    : 0)                                                                                       // Colorize: green
                                    , FILE_SHARE_READ | (shareWrite  == ShareWrite::YES    ? FILE_SHARE_WRITE : 0)                                                                                       // Colorize: green
                                    , nullptr, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, nullptr);                                                                                                           // Colorize: green
                // Ignore CppAlignmentVerifier [END]                                                                                                                                                     // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Terminate if successfull                                                                                                                                                                  // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (res != INVALID_HANDLE_VALUE)                                                                                                                                                         // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Terminate if access denied                                                                                                                                                                // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (                                                                                                                                                                                     // Colorize: green
                    GetLastError() != ERROR_ACCESS_DENIED                                                                                                                                                // Colorize: green
                    &&                                                                                                                                                                                   // Colorize: green
                    GetLastError() != ERROR_SHARING_VIOLATION                                                                                                                                            // Colorize: green
                   )                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Log that we fail to get access to disk with first try or try without exclusive rights                                                                                                     // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (i == 0)                                                                                                                                                                              // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qDebug() << "Waiting for access to disk";                                                                                                                                            // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                if (                                                                                                                                                                                     // Colorize: green
                    shareWrite == ShareWrite::NO                                                                                                                                                         // Colorize: green
                    &&                                                                                                                                                                                   // Colorize: green
                    i > DISK_ACCESS_RETRIES / 3                                                                                                                                                          // Colorize: green
                   )                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qWarning() << "Could not obtain exclusive rights. Retrying with write sharing enabled...";                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    shareWrite = ShareWrite::YES;                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            QThread::msleep(DISK_ACCESS_TIMEOUT);                                                                                                                                                        // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that disk openned                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (res == INVALID_HANDLE_VALUE)                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not open disk:" << GetLastError();                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return res;                                                                                                                                                                                  // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Write that disk openned to debug console                                                                                                                                                          // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (writeAccess == Access::READ_WRITE)                                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug().nospace() << "Disk opened for " << (shareWrite == ShareWrite::YES ? "shared" : "exclusive") << " write access";                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qDebug() << "Disk opened for read-only access";                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Lock disk                                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (lockDisk == LockDisk::YES)                                                                                                                                                                   // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            DWORD size;                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Disable I/O boundary checks                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (DeviceIoControl(res, FSCTL_ALLOW_EXTENDED_DASD_IO, nullptr, ZERO_SIZE, nullptr, ZERO_SIZE, &size, nullptr))                                                                          // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    qDebug() << "I/O boundary checks disabled";                                                                                                                                          // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            // Try to lock                                                                                                                                                                               // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                for (qint64 i = 0; i < DISK_ACCESS_RETRIES && thread->isWorking(); ++i)                                                                                                                  // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    if (DeviceIoControl(res, FSCTL_LOCK_VOLUME, nullptr, ZERO_SIZE, nullptr, ZERO_SIZE, &size, nullptr))                                                                                 // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        return res;                                                                                                                                                                      // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    QThread::msleep(DISK_ACCESS_TIMEOUT);                                                                                                                                                // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            qCritical() << "Could not lock disk:" << GetLastError();                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return res;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
HANDLE getPhysicalHandle(BurnThread *thread, LockDisk lockDisk, Access writeAccess, ShareWrite shareWrite)                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return getHandle(thread, getPhysicalName(thread), lockDisk, writeAccess, shareWrite);                                                                                                                // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
HANDLE getLogicalHandle(BurnThread *thread, LockDisk lockDisk, Access writeAccess, ShareWrite shareWrite)                                                                                                // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return getHandle(thread, getLogicalName(thread), lockDisk, writeAccess, shareWrite);                                                                                                                 // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void unlockAndCloseHandle(BurnThread *thread, HANDLE handle)                                                                                                                                             // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
    Q_ASSERT(handle != INVALID_HANDLE_VALUE);                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Unlock handle                                                                                                                                                                                     // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        DWORD size;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!DeviceIoControl(handle, FSCTL_UNLOCK_VOLUME, nullptr, ZERO_SIZE, nullptr, ZERO_SIZE, &size, nullptr))                                                                                       // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not unlock disk:" << GetLastError();                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Close handle                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!CloseHandle(handle))                                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "CloseHandle failed:" << GetLastError();                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void waitForLogical(BurnThread *thread)                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QThread::msleep(200);                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    while (thread->isWorking())                                                                                                                                                                          // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (getLogicalName(thread) != "")                                                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        QThread::msleep(DISK_ACCESS_TIMEOUT);                                                                                                                                                            // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void refreshDiskLayout(BurnThread *thread, HANDLE diskHandle)                                                                                                                                            // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread     != nullptr);                                                                                                                                                                     // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Refresh disk layout                                                                                                                                                                               // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        DWORD size;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!DeviceIoControl(diskHandle, IOCTL_DISK_UPDATE_PROPERTIES, nullptr, ZERO_SIZE, nullptr, ZERO_SIZE, &size, nullptr))                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not refresh disk layout:" << GetLastError();                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QByteArray readSectors(HANDLE diskHandle, qint64 startSector, qint64 numberOfSectors)                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Set pointer to startSector                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        LARGE_INTEGER ptr;                                                                                                                                                                               // Colorize: green
        ptr.QuadPart = startSector * SECTOR_SIZE;                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!SetFilePointerEx(diskHandle, ptr, nullptr, FILE_BEGIN))                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "SetFilePointerEx failed:" << GetLastError();                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return QByteArray();                                                                                                                                                                         // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    DWORD size = numberOfSectors * SECTOR_SIZE;                                                                                                                                                          // Colorize: green
    QByteArray buffer(size, 0);                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read sectors from disk to buffer                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!ReadFile(diskHandle, buffer.data(), size, &size, nullptr))                                                                                                                                  // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "ReadFile failed:" << GetLastError();                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return QByteArray();                                                                                                                                                                         // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return buffer;                                                                                                                                                                                       // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
qint64 writeSectors(HANDLE diskHandle, qint64 startSector, qint64 numberOfSectors, const QByteArray &buffer)                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Set pointer to startSector                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        LARGE_INTEGER ptr;                                                                                                                                                                               // Colorize: green
        ptr.QuadPart = startSector * SECTOR_SIZE;                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!SetFilePointerEx(diskHandle, ptr, nullptr, FILE_BEGIN))                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "SetFilePointerEx failed:" << GetLastError();                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return -1;                                                                                                                                                                                   // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    DWORD size = numberOfSectors * SECTOR_SIZE;                                                                                                                                                          // Colorize: green
    Q_ASSERT(buffer.size() == size);                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Write sectors from buffer to disk                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!WriteFile(diskHandle, buffer.constData(), size, &size, nullptr))                                                                                                                            // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "WriteFile failed:" << GetLastError();                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return -1;                                                                                                                                                                                   // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return size;                                                                                                                                                                                         // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
QChar getUnusedDiskLetter()                                                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    QChar res;                                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString drivesString;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Get all configured drive letters                                                                                                                                                                  // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        char  drives[128];                                                                                                                                                                               // Colorize: green
        DWORD size = GetLogicalDriveStringsA(sizeof(drives), drives);                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (size > 0 && size <= sizeof(drives))                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            for (char *drive = drives; *drive != 0; drive += strlen(drive) + 1)                                                                                                                          // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                // Check that drive letter is valid                                                                                                                                                      // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    drive[0] = QChar::toUpper(drive[0]);                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (drive[0] < 'A' || drive[0] > 'Z')                                                                                                                                                // Colorize: green
                    {                                                                                                                                                                                        // Colorize: green
                        continue;                                                                                                                                                                            // Colorize: green
                    }                                                                                                                                                                                        // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                drivesString += drive[0];                                                                                                                                                                // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "size is invalid";                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that drive letter is free                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 'C'; i <= 'Z'; ++i)                                                                                                                                                              // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            if (!drivesString.contains((char)i))                                                                                                                                                        // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                res = (char)i;                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                break;                                                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return res;                                                                                                                                                                                          // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
quint8 gCurrentBurnStep;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void notifyNextStep(BurnThread *thread)                                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Increment step and send notification to UI                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        ++gCurrentBurnStep;                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        Q_ASSERT(gCurrentBurnStep <= 11);                                                                                                                                                                // Colorize: green
        thread->notifyProgress(gCurrentBurnStep, 11);                                                                                                                                                    // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void unmountVolumes(BurnThread *thread, QString *targetDiskLetter)                                                                                                                                       // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread           != nullptr);                                                                                                                                                               // Colorize: green
    Q_ASSERT(targetDiskLetter != nullptr);                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    HANDLE diskHandle;                                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Lock disk                                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        diskHandle = getPhysicalHandle(thread, LockDisk::YES, Access::READ_ONLY, ShareWrite::NO);                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (diskHandle == INVALID_HANDLE_VALUE)                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Iterate over USB disk letters and unmount them                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (thread->isWorking())                                                                                                                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QString diskLetters = thread->getSelectedUsb().letters;                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (diskLetters != "")                                                                                                                                                                       // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                for (qint64 i = 0; i < diskLetters.length(); ++i)                                                                                                                                        // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    wchar_t diskPath[] = { diskLetters.at(i).unicode(), ':', '\\', 0 };                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    thread->addLog(QCoreApplication::translate("BurnThread", "Unmounting disk volume %1").arg(diskPath));                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                    if (!DeleteVolumeMountPoint(diskPath))                                                                                                                                               // Colorize: green
                    {                                                                                                                                                                                    // Colorize: green
                        qCritical() << "DeleteVolumeMountPoint failed:" << GetLastError();                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        thread->stop();                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                        break;                                                                                                                                                                           // Colorize: green
                    }                                                                                                                                                                                    // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                *targetDiskLetter = QString("%1:\\").arg(diskLetters.at(0));                                                                                                                             // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                thread->addLog(QCoreApplication::translate("BurnThread", "There is no any mounted disk volume"));                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                *targetDiskLetter = QString("%1:\\").arg(getUnusedDiskLetter());                                                                                                                         // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            qDebug().nospace() << "Disk will be mounted to " << targetDiskLetter->toLatin1().data();                                                                                                     // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    unlockAndCloseHandle(thread, diskHandle);                                                                                                                                                            // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void clearGpt(BurnThread *thread, HANDLE diskHandle)                                                                                                                                                     // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread     != nullptr);                                                                                                                                                                     // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QByteArray buffer(SECTOR_SIZE, 0);                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Clearing GPT"));                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clear first 34 sectors                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < 34 && thread->isWorking(); ++i)                                                                                                                                           // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            for (qint64 j = 0; j < WRITE_RETRIES && thread->isWorking(); ++j)                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (writeSectors(diskHandle, i, 1, buffer) == SECTOR_SIZE)                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QThread::msleep(WRITE_TIMEOUT);                                                                                                                                                      // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Clear last 33 sectors                                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        qint64 sectorsCount = thread->getSelectedUsb().diskSize / SECTOR_SIZE;                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        for (qint64 i = sectorsCount - 33; i < sectorsCount && thread->isWorking(); ++i)                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            for (qint64 j = 0; j < WRITE_RETRIES && thread->isWorking(); ++j)                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (writeSectors(diskHandle, i, 1, buffer) == SECTOR_SIZE)                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QThread::msleep(WRITE_TIMEOUT);                                                                                                                                                      // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void initializeDisk(BurnThread *thread, HANDLE diskHandle)                                                                                                                                               // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread     != nullptr);                                                                                                                                                                     // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    CREATE_DISK createDisk = { PARTITION_STYLE_RAW, {{ 0 }} };                                                                                                                                           // Colorize: green
    DWORD       size       = sizeof(createDisk);                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Initializing disk"));                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Create raw disk                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!DeviceIoControl(diskHandle, IOCTL_DISK_CREATE_DISK, (BYTE *)&createDisk, size, nullptr, ZERO_SIZE, &size, nullptr))                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not delete disk layout:" << GetLastError();                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    refreshDiskLayout(thread, diskHandle);                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void createPartition(BurnThread *thread, HANDLE diskHandle)                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread     != nullptr);                                                                                                                                                                     // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Creating GPT partition for UEFI"));                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    DRIVE_LAYOUT_INFORMATION_EX driveLayout;                                                                                                                                                             // Colorize: green
    memset(&driveLayout, 0, sizeof(driveLayout));                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Initialize partition                                                                                                                                                                              // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        driveLayout.PartitionStyle = PARTITION_STYLE_GPT;                                                                                                                                                // Colorize: green
        driveLayout.PartitionCount = 1;                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        driveLayout.PartitionEntry[0].PartitionStyle           = PARTITION_STYLE_GPT;                                                                                                                    // Colorize: green
        driveLayout.PartitionEntry[0].StartingOffset.QuadPart  = 1 * MB;                                                                                                                                 // Colorize: green
        driveLayout.PartitionEntry[0].PartitionLength.QuadPart = thread->getSelectedUsb().diskSize - driveLayout.PartitionEntry[0].StartingOffset.QuadPart - (33 * SECTOR_SIZE); // Last 33 sectors reserved for Secondary GPT header // Colorize: green
        driveLayout.PartitionEntry[0].PartitionNumber          = 1;                                                                                                                                      // Colorize: green
        driveLayout.PartitionEntry[0].RewritePartition         = true;                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        driveLayout.PartitionEntry[0].Gpt.PartitionType = PARTITION_BASIC_DATA_GUID;                                                                                                                     // Colorize: green
        CoCreateGuid(&driveLayout.PartitionEntry[0].Gpt.PartitionId);                                                                                                                                    // Colorize: green
        QString("Microsoft Basic Data").toWCharArray(driveLayout.PartitionEntry[0].Gpt.Name);                                                                                                            // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    CREATE_DISK createDisk = { PARTITION_STYLE_GPT, {{ 0 }} };                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Initialize GPT information                                                                                                                                                                        // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        CoCreateGuid(&createDisk.Gpt.DiskId);                                                                                                                                                            // Colorize: green
        createDisk.Gpt.MaxPartitionCount = MAX_GPT_PARTITIONS;                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        driveLayout.Gpt.DiskId                        = createDisk.Gpt.DiskId;                                                                                                                           // Colorize: green
        driveLayout.Gpt.StartingUsableOffset.QuadPart = 34 * SECTOR_SIZE;                                              // First 34 sectors reserved for Protective MBR and Primary GPT header            // Colorize: green
        driveLayout.Gpt.UsableLength.QuadPart         = thread->getSelectedUsb().diskSize - ((34 + 33) * SECTOR_SIZE); // Last 33 sectors reserved for Secondary GPT header                              // Colorize: green
        driveLayout.Gpt.MaxPartitionCount             = MAX_GPT_PARTITIONS;                                                                                                                              // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Create GPT disk                                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        DWORD size = sizeof(createDisk);                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!DeviceIoControl(diskHandle, IOCTL_DISK_CREATE_DISK, (BYTE *)&createDisk, size, nullptr, ZERO_SIZE, &size, nullptr))                                                                         // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not reset disk layout:" << GetLastError();                                                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Set GPT layout to disk                                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        DWORD size = sizeof(driveLayout);                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!DeviceIoControl(diskHandle, IOCTL_DISK_SET_DRIVE_LAYOUT_EX, (BYTE *)&driveLayout, size, nullptr, 0, &size, nullptr))                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "Could not set disk layout:" << GetLastError();                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    refreshDiskLayout(thread, diskHandle);                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool gFormatSuccessful;                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
bool __stdcall formatExCallback(FILE_SYSTEM_CALLBACK_COMMAND command, DWORD /*action*/, PVOID /*pData*/)                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    // Check that required commands received                                                                                                                                                             // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        switch (command)                                                                                                                                                                                 // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_PROGRESS:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_STRUCTURE_PROGRESS:                                                                                                                                   // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_DONE:                                                                                                                                                 // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_DONE_WITH_STRUCTURE:                                                                                                                                  // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                return true;                                                                                                                                                                             // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN2:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_INCOMPATIBLE_FILE_SYSTEM:                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN4:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN5:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_ACCESS_DENIED:                                                                                                                                        // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_MEDIA_WRITE_PROTECTED:                                                                                                                                // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_VOLUME_IN_USE:                                                                                                                                        // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_CANT_QUICK_FORMAT:                                                                                                                                    // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWNA:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_BAD_LABEL:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWND:                                                                                                                                             // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_OUTPUT:                                                                                                                                               // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_CLUSTER_SIZE_TOO_SMALL:                                                                                                                               // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_CLUSTER_SIZE_TOO_BIG:                                                                                                                                 // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_VOLUME_TOO_SMALL:                                                                                                                                     // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_VOLUME_TOO_BIG:                                                                                                                                       // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_NO_MEDIA_IN_DRIVE:                                                                                                                                    // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN15:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN16:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN17:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_DEVICE_NOT_READY:                                                                                                                                     // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_CHECKDISK_PROGRESS:                                                                                                                                   // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1A:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1B:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1C:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1D:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1E:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_UNKNOWN1F:                                                                                                                                            // Colorize: green
            case FILE_SYSTEM_CALLBACK_COMMAND::FCC_READ_ONLY_MODE:                                                                                                                                       // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "Unexpected command:" << (quint8)command;                                                                                                                                // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            default:                                                                                                                                                                                     // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "Unknown command:" << (quint8)command;                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            break;                                                                                                                                                                                       // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    gFormatSuccessful = false;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    return false;                                                                                                                                                                                        // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void formatPartitionWithFmifs(BurnThread *thread, HMODULE moduleHandle)                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread       != nullptr);                                                                                                                                                                   // Colorize: green
    Q_ASSERT(moduleHandle != nullptr);                                                                                                                                                                   // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    FormatEx_t pfFormatEx = reinterpret_cast<FormatEx_t>(reinterpret_cast<void *>(GetProcAddress(moduleHandle, "FormatEx")));                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (pfFormatEx == nullptr)                                                                                                                                                                           // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        qCritical() << "GetProcAddress failed:" << GetLastError();                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        thread->stop();                                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        return;                                                                                                                                                                                          // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    wchar_t volumeName[MAX_PATH] = { 0 };                                                                                                                                                                // Colorize: green
    wchar_t fsType[8]            = { 0 };                                                                                                                                                                // Colorize: green
    wchar_t label[16]            = { 0 };                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    getLogicalName(thread).toWCharArray(volumeName);                                                                                                                                                     // Colorize: green
    QString("FAT32").toWCharArray(fsType);                                                                                                                                                               // Colorize: green
    QString("NGOS BOOT").toWCharArray(label);                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Format partition with fmifs.dll                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        gFormatSuccessful = true;                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        pfFormatEx(volumeName, RemovableMedia, fsType, label, true, DEFAULT_CLUSTER_SIZE, formatExCallback);                                                                                             // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!gFormatSuccessful)                                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->addLog(QCoreApplication::translate("BurnThread", "Disk formatting failed"));                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void formatPartition(BurnThread *thread, HANDLE diskHandle)                                                                                                                                              // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Formatting partition to FAT32"));                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    HMODULE moduleHandle = LoadLibraryA("fmifs.dll");                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Format partition with fmifs.dll                                                                                                                                                                   // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (moduleHandle != nullptr)                                                                                                                                                                     // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            formatPartitionWithFmifs(thread, moduleHandle);                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (!FreeLibrary(moduleHandle))                                                                                                                                                              // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "FreeLibrary failed:" << GetLastError();                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                thread->stop();                                                                                                                                                                          // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
        else                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "LoadLibrary failed:" << GetLastError();                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    refreshDiskLayout(thread, diskHandle);                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void writeProtectiveMbr(BurnThread *thread, HANDLE diskHandle)                                                                                                                                           // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread     != nullptr);                                                                                                                                                                     // Colorize: green
    Q_ASSERT(diskHandle != INVALID_HANDLE_VALUE);                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Writing protective MBR"));                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QByteArray originalBuffer;                                                                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Read first sector from disk                                                                                                                                                                       // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        for (qint64 i = 0; i < WRITE_RETRIES && thread->isWorking(); ++i)                                                                                                                                // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            originalBuffer = readSectors(diskHandle, 0, 1);                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (originalBuffer.size() == SECTOR_SIZE)                                                                                                                                                    // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                break;                                                                                                                                                                                   // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
            else                                                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                QThread::msleep(WRITE_TIMEOUT);                                                                                                                                                          // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (originalBuffer.size() == SECTOR_SIZE)                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        QByteArray buffer;                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Read protective MBR from assets                                                                                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            QFile file(":/assets/binaries/protective_mbr.bin");                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            if (!file.open(QIODevice::ReadOnly))                                                                                                                                                         // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                qCritical() << "Failed to open :/assets/binaries/protective_mbr.bin";                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                thread->stop();                                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                return;                                                                                                                                                                                  // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            buffer = file.readAll();                                                                                                                                                                     // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            file.close();                                                                                                                                                                                // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Replace part for protective MBR buffer related to partition table with original MBR from device                                                                                               // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            buffer.replace(MBR_RESERVED, SECTOR_SIZE - MBR_RESERVED, originalBuffer.mid(MBR_RESERVED));                                                                                                  // Colorize: green
            buffer.replace(SECTOR_SIZE - 2, 2, "\x55\xAA");                                                                                                                                              // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        // Write buffer to first disk sector                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            for (qint64 i = 0; i < WRITE_RETRIES && thread->isWorking(); ++i)                                                                                                                            // Colorize: green
            {                                                                                                                                                                                            // Colorize: green
                if (writeSectors(diskHandle, 0, 1, buffer) == SECTOR_SIZE)                                                                                                                               // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    break;                                                                                                                                                                               // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
                else                                                                                                                                                                                     // Colorize: green
                {                                                                                                                                                                                        // Colorize: green
                    QThread::msleep(WRITE_TIMEOUT);                                                                                                                                                      // Colorize: green
                }                                                                                                                                                                                        // Colorize: green
            }                                                                                                                                                                                            // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        refreshDiskLayout(thread, diskHandle);                                                                                                                                                           // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void formatDisk(BurnThread *thread)                                                                                                                                                                      // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    HANDLE diskHandle;                                                                                                                                                                                   // Colorize: green
    HANDLE volumeHandle;                                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Lock disk                                                                                                                                                                                         // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        diskHandle = getPhysicalHandle(thread, LockDisk::YES, Access::READ_WRITE, ShareWrite::NO);                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (diskHandle == INVALID_HANDLE_VALUE)                                                                                                                                                          // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        volumeHandle = getLogicalHandle(thread, LockDisk::YES, Access::READ_ONLY, ShareWrite::NO);                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (volumeHandle == INVALID_HANDLE_VALUE)                                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            unlockAndCloseHandle(thread, diskHandle);                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    clearGpt(thread, diskHandle);                                                                                                                                                                        // Colorize: green
    notifyNextStep(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    initializeDisk(thread, diskHandle);                                                                                                                                                                  // Colorize: green
    notifyNextStep(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    createPartition(thread, diskHandle);                                                                                                                                                                 // Colorize: green
    notifyNextStep(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    unlockAndCloseHandle(thread, volumeHandle);                                                                                                                                                          // Colorize: green
    volumeHandle = INVALID_HANDLE_VALUE;                                                                                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    waitForLogical(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    formatPartition(thread, diskHandle);                                                                                                                                                                 // Colorize: green
    notifyNextStep(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    writeProtectiveMbr(thread, diskHandle);                                                                                                                                                              // Colorize: green
    notifyNextStep(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    waitForLogical(thread);                                                                                                                                                                              // Colorize: green
    CHECK_IF_THREAD_TERMINATED(thread);                                                                                                                                                                  // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
out:                                                                                                                                                                                                     // Colorize: green
    unlockAndCloseHandle(thread, diskHandle);                                                                                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    if (volumeHandle != INVALID_HANDLE_VALUE)                                                                                                                                                            // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        unlockAndCloseHandle(thread, volumeHandle);                                                                                                                                                      // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void mountVolumeByGuid(BurnThread *thread, QString *diskPath, const QString &volumeName)                                                                                                                 // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread   != nullptr);                                                                                                                                                                       // Colorize: green
    Q_ASSERT(diskPath != nullptr);                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Check that volume already mounted                                                                                                                                                                 // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        char  mountedLetters[27];                                                                                                                                                                        // Colorize: green
        DWORD size;                                                                                                                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (                                                                                                                                                                                             // Colorize: green
            GetVolumePathNamesForVolumeNameA(volumeName.toLatin1().data(), mountedLetters, sizeof(mountedLetters), &size)                                                                                // Colorize: green
            &&                                                                                                                                                                                           // Colorize: green
            size > 1                                                                                                                                                                                     // Colorize: green
           )                                                                                                                                                                                             // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            (*diskPath)[0] = mountedLetters[0];                                                                                                                                                          // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->addLog(QCoreApplication::translate("BurnThread", "Disk already mounted to %1").arg(*diskPath));                                                                                      // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Mount volume                                                                                                                                                                                      // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        if (!SetVolumeMountPointA(diskPath->toLatin1().data(), volumeName.toLatin1().data()))                                                                                                            // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "SetVolumeMountPoint failed:" << GetLastError();                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->addLog(QCoreApplication::translate("BurnThread", "Failed to mount disk"));                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void mountVolume(BurnThread *thread, QString *diskPath)                                                                                                                                                  // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread   != nullptr);                                                                                                                                                                       // Colorize: green
    Q_ASSERT(diskPath != nullptr);                                                                                                                                                                       // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    thread->addLog(QCoreApplication::translate("BurnThread", "Mounting disk volume %1").arg(*diskPath));                                                                                                 // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    mountVolumeByGuid(thread, diskPath, getLogicalName(thread) + '\\');                                                                                                                                  // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void remountVolume(BurnThread *thread, const QString &diskPath)                                                                                                                                          // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    Q_ASSERT(thread != nullptr);                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    // Unmount volume                                                                                                                                                                                    // Colorize: green
    {                                                                                                                                                                                                    // Colorize: green
        thread->addLog(QCoreApplication::translate("BurnThread", "Unmounting disk volume %1").arg(diskPath));                                                                                            // Colorize: green
                                                                                                                                                                                                         // Colorize: green
        if (!DeleteVolumeMountPointA(diskPath.toLatin1().data()))                                                                                                                                        // Colorize: green
        {                                                                                                                                                                                                // Colorize: green
            qCritical() << "DeleteVolumeMountPoint failed:" << GetLastError();                                                                                                                           // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            thread->stop();                                                                                                                                                                              // Colorize: green
                                                                                                                                                                                                         // Colorize: green
            return;                                                                                                                                                                                      // Colorize: green
        }                                                                                                                                                                                                // Colorize: green
    }                                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    mountVolume(thread, (QString *)&diskPath);                                                                                                                                                           // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
void BurnThread::run()                                                                                                                                                                                   // Colorize: green
{                                                                                                                                                                                                        // Colorize: green
    gCurrentBurnStep = 0;                                                                                                                                                                                // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    QString diskPath;                                                                                                                                                                                    // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    unmountVolumes(this, &diskPath);                                                                                                                                                                     // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    formatDisk(this);                                                                                                                                                                                    // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    mountVolume(this, &diskPath);                                                                                                                                                                        // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    copyFiles(diskPath);                                                                                                                                                                                 // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    createAutorun(diskPath);                                                                                                                                                                             // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
                                                                                                                                                                                                         // Colorize: green
    remountVolume(this, diskPath);                                                                                                                                                                       // Colorize: green
    notifyNextStep(this);                                                                                                                                                                                // Colorize: green
    CHECK_IF_TERMINATED();                                                                                                                                                                               // Colorize: green
}                                                                                                                                                                                                        // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
                                                                                                                                                                                                         // Colorize: green
#endif // Q_OS_WIN                                                                                                                                                                                       // Colorize: green
